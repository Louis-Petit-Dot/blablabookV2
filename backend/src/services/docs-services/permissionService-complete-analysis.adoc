= Service PermissionService (Version Simplifiée) - Analyse Complète
:toc:
:toclevels: 3

== Vue d'ensemble

Le service permissionService gère les permissions dans l'API BlaBlaBook V2. Il s'agit d'un service de consultation simple qui permet de récupérer les permissions disponibles dans le système, servant de base au système de contrôle d'accès basé sur les rôles (RBAC).

NOTE: Ce service utilise `.select()` **sans projections explicites** car la table Permission ne contient **aucune donnée sensible**. Toutes les informations (nom de permission, description) sont publiques pour la configuration du système. L'utilisation de `.select().from(Permission)` est donc appropriée et optimale pour ce cas d'usage.

== Fonctions principales

=== getAll
**Objectif:** Récupérer la liste complète de toutes les permissions disponibles
**Quand:** Utilisé pour afficher les permissions dans les interfaces d'administration
**Pourquoi important:** Permet la configuration et la gestion des droits d'accès du système

=== getById
**Objectif:** Récupérer les informations détaillées d'une permission spécifique
**Quand:** Utilisé pour afficher les détails d'une permission ou lors de validations
**Pourquoi important:** Fournit les données nécessaires pour le contrôle d'accès granulaire

== Fonctionnement du service permissionService

=== Rôle de référentiel de permissions
Le service permissionService fonctionne comme un catalogue de droits :

1. **Référentiel central** : Il maintient la liste de toutes les permissions du système
2. **Consultation simple** : Il fournit un accès en lecture seule aux permissions
3. **Base du RBAC** : Il sert de fondation au système de rôles et permissions
4. **Validation de sécurité** : Il permet la vérification de l'existence des permissions

=== Architecture simple
Le service adopte une approche minimaliste :
- **Lecture seule** : Aucune opération de création, modification ou suppression
- **Pas de validation complexe** : Gestion d'erreur directe pour les permissions inexistantes
- **Structure légère** : Pas de dépendances externes complexes

== Opérations détaillées

=== Consultation de toutes les permissions (getAll)

**Fonctionnement en mots simples :**
Cette fonction agit comme un annuaire qui liste toutes les permissions disponibles dans le système.

**Processus de récupération :**
1. **Récupération complète** : SELECT sans filtrage de toutes les permissions
2. **Calcul des métadonnées** : Comptage automatique du nombre total
3. **Format standardisé** : Retour dans une structure cohérente

**Données retournées :**
- Liste complète des permissions système
- Compteur total pour statistiques
- Informations détaillées de chaque permission

**Usage typique :**
- Configuration des rôles
- Interfaces d'administration
- Audit des permissions disponibles

=== Consultation d'une permission (getById)

**Fonctionnement en mots simples :**
Cette fonction agit comme un lecteur de fiche qui récupère les détails d'une permission spécifique.

**Processus de récupération :**
1. **Recherche directe** : SELECT avec condition WHERE sur l'ID
2. **Limitation de résultats** : LIMIT 1 pour optimiser la requête
3. **Validation d'existence** : Vérification que la permission existe
4. **Gestion d'erreur** : Exception si permission non trouvée

**Gestion d'erreur intégrée :**
```javascript
if (permissions.length === 0) {
    throw new Error('Permission not found.');
}
```

**Données retournées :**
- Informations complètes de la permission demandée
- Structure cohérente avec les autres services

== Validation et contrôles qualité

=== Validation minimaliste
Le service applique une validation simple :
- **Existence de l'entité** : Vérification directe que la permission existe
- **Message d'erreur explicite** : "Permission not found." pour les cas d'échec
- **Pas de validation complexe** : Service de consultation pure

=== Gestion des erreurs
Le service gère les erreurs de façon directe :
- **Permission inexistante** : Exception claire avec message explicite
- **Pas de validation d'accès** : Service considéré comme public en lecture
- **Erreurs de base de données** : Propagation transparente des erreurs système

== Performance et optimisation

=== Requêtes optimisées
- **Sélection simple** : Pas de JOIN ou sous-requêtes complexes
- **LIMIT pour unicité** : LIMIT 1 pour getById optimise les performances
- **Index recommandé** : Index sur id_permission pour les recherches directes

=== Optimisation mémoire
- **Pas de traitement lourd** : Opérations de lecture directe
- **Calculs simples** : Compteurs via .length sans requêtes supplémentaires
- **Pas de cache nécessaire** : Données de permissions généralement stables

== Interaction avec d'autres services

=== Services connexes
- **roleService** : Attribution des permissions aux rôles
- **userRoleService** : Association des utilisateurs aux rôles et permissions
- **Système d'authentification** : Validation des droits d'accès

=== Impact sur d'autres fonctionnalités
- **Contrôle d'accès** : Base pour la vérification des droits utilisateur
- **Configuration système** : Gestion des permissions via interfaces admin
- **Audit de sécurité** : Traçabilité des permissions disponibles

== Exemple de flux typique

=== Scénario : Configuration des rôles administrateur

**Situation de départ :**
Un administrateur système configure les permissions pour un nouveau rôle "Modérateur".

**Traitement par le service :**
1. **Récupération des permissions** : `getAll()` pour lister toutes les permissions disponibles
2. **Affichage interface** : Présentation des permissions sous forme de liste à cocher
3. **Validation individuelle** : `getById()` pour chaque permission sélectionnée
4. **Attribution au rôle** : Utilisation des permissions validées dans roleService

**Données utilisées :**
```javascript
// Récupération pour interface
const allPermissions = await permissionService.getAll();
// permissions: [{id_permission, permission_name, description}, ...]

// Validation spécifique
const writePermission = await permissionService.getById("write-permission-id");
// permission: {id_permission, permission_name, description}
```

== Diagramme de séquence - Workflow PermissionService

[mermaid]
----
sequenceDiagram
    participant Controller
    participant PermissionService
    participant Database

    Note over Controller, Database: Exemple: Récupération de toutes les permissions

    Controller->>PermissionService: getAll()
    PermissionService->>Database: SELECT * FROM permissions
    Database-->>PermissionService: permissions[]
    PermissionService->>PermissionService: Calculate permissions.length
    PermissionService-->>Controller: {permissions: permissions[], total_permissions: count}

    Note over Controller, Database: Exemple: Consultation d'une permission spécifique

    Controller->>PermissionService: getById(permissionId)
    PermissionService->>Database: SELECT * FROM permissions WHERE id_permission = ? LIMIT 1
    Database-->>PermissionService: permissions[] (0 ou 1 élément)

    alt Si permission inexistante
        PermissionService-->>Controller: throw Error("Permission not found.")
    else Permission trouvée
        PermissionService-->>Controller: {permission: permissions[0]}
    end
----

== Structure des données

=== Modèle Permission
```typescript
interface Permission {
    id_permission: string;      // Identifiant unique
    permission_name: string;    // Nom de la permission
    description?: string;       // Description optionnelle
    created_at: Date;          // Date de création
}
```

=== Exemples de permissions typiques
- **read:books** : Lecture des livres
- **write:books** : Création/modification des livres
- **delete:books** : Suppression des livres
- **admin:users** : Administration des utilisateurs
- **moderate:reviews** : Modération des critiques

== Résumé

Le service permissionService est le **référentiel de permissions** de l'API BlaBlaBook V2. Il gère **2 opérations simples** avec :
- **Consultation complète** : Récupération de toutes les permissions système
- **Consultation individuelle** : Récupération d'une permission spécifique avec validation
- **Architecture simple** : Service de lecture pure sans complexité
- **Base du RBAC** : Fondation pour le système de rôles et contrôle d'accès
- **Gestion d'erreur directe** : Messages explicites pour les permissions inexistantes
- **Performance optimisée** : Requêtes directes sans JOIN complexes

**Points clés d'optimisation :**
- ✅ `.select()` complet approprié (pas de données sensibles)
- ✅ `LIMIT 1` pour `getById()` (optimisation)
- ✅ Pas de JOIN ni sous-requêtes complexes
- ✅ Pas de projections explicites nécessaires pour ce cas d'usage

**Il assure la gestion centralisée des permissions pour le contrôle d'accès de la plateforme.**