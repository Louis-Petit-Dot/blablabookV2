= Service RoleService - Analyse Complète
:toc:
:toclevels: 3

== Vue d'ensemble

Le service roleService est un service complet qui gère les rôles système et leurs permissions associées dans l'API BlaBlaBook V2. Il offre des opérations CRUD complètes pour les rôles ainsi qu'une gestion dynamique des permissions.

IMPORTANT: Ce service offre maintenant une gestion CRUD complète des rôles (création, modification, suppression) et une gestion dynamique des permissions (ajout/suppression). Les rôles système USER et ADMIN restent disponibles via des vues matérialisées pour les opérations courantes.

== Fonctions principales

=== Consultation de rôles système

==== getUserRole
**Objectif:** Récupérer le rôle système "USER"
**Quand:** Utilisé lors de l'attribution du rôle par défaut aux nouveaux utilisateurs
**Pourquoi important:** Permet l'assignation automatique du rôle USER lors de la création de compte

==== getAdminRole
**Objectif:** Récupérer le rôle système "ADMIN"
**Quand:** Utilisé pour l'attribution de privilèges administrateur
**Pourquoi important:** Permet l'assignation du rôle ADMIN aux administrateurs du système

==== getUserPermissions
**Objectif:** Récupérer toutes les permissions associées au rôle USER
**Quand:** Utilisé pour déterminer les droits d'accès des utilisateurs standard
**Pourquoi important:** Définit le périmètre d'action des utilisateurs normaux

==== getAdminPermissions
**Objectif:** Récupérer toutes les permissions associées au rôle ADMIN
**Quand:** Utilisé pour déterminer les droits d'accès des administrateurs
**Pourquoi important:** Définit le périmètre d'action complet des administrateurs

=== Gestion CRUD des rôles

==== getAll
**Objectif:** Récupérer tous les rôles du système
**Quand:** Affichage de la liste des rôles en administration
**Pourquoi important:** Permet de consulter tous les rôles disponibles

==== getById
**Objectif:** Récupérer un rôle spécifique par son ID
**Quand:** Consultation ou modification d'un rôle
**Pourquoi important:** Permet d'accéder aux détails d'un rôle précis

==== create
**Objectif:** Créer un nouveau rôle personnalisé
**Quand:** Ajout d'un nouveau rôle au système
**Pourquoi important:** Permet d'étendre le système de permissions avec de nouveaux rôles

==== update
**Objectif:** Modifier un rôle existant
**Quand:** Mise à jour du nom ou description d'un rôle
**Pourquoi important:** Permet d'ajuster les rôles selon l'évolution des besoins

==== delete
**Objectif:** Supprimer un rôle
**Quand:** Suppression d'un rôle devenu obsolète
**Pourquoi important:** Maintient la propreté du système de rôles

=== Gestion des permissions

==== addPermission
**Objectif:** Ajouter une permission à un rôle
**Quand:** Attribution de nouveaux droits à un rôle
**Pourquoi important:** Permet de personnaliser finement les permissions d'un rôle

==== removePermission
**Objectif:** Retirer une permission d'un rôle
**Quand:** Révocation de droits d'un rôle
**Pourquoi important:** Permet de réduire les permissions d'un rôle

== Fonctionnement du service roleService

=== Gestionnaire complet de rôles et permissions
Le service roleService fonctionne comme un gestionnaire RBAC complet :

1. **Consultation des rôles système** : Récupération des rôles USER et ADMIN via vues
2. **CRUD de rôles** : Création, lecture, mise à jour et suppression de rôles
3. **Gestion des permissions** : Ajout et suppression de permissions sur les rôles
4. **Validation des données** : Vérification de l'unicité et de l'existence
5. **Performance optimisée** : Utilisation de vues pour les opérations courantes

=== Architecture complète
Le service adopte une approche modulaire :
- **Opérations CRUD** : Création, modification et suppression de rôles
- **Rôles système** : USER et ADMIN accessibles via méthodes dédiées
- **Vues matérialisées** : UserRolePermissionsView et AdminRolePermissionsView
- **Validation robuste** : Vérification d'unicité et gestion d'erreurs
- **Gestion des permissions** : Attribution et révocation dynamiques

=== Utilisation des vues matérialisées
Le service exploite deux vues spécialisées :
- **UserRolePermissionsView** : Toutes les permissions du rôle USER
- **AdminRolePermissionsView** : Toutes les permissions du rôle ADMIN

Ces vues sont préalablement définies dans la base de données et offrent des performances optimales pour la consultation fréquente des permissions.

== Opérations détaillées

=== Récupération du rôle USER (getUserRole)

**Fonctionnement en mots simples :**
Cette fonction agit comme un lecteur de référence qui récupère le rôle système prédéfini "USER".

**Processus de récupération :**
1. **Recherche directe** : SELECT avec condition WHERE role_name = 'USER'
2. **Limitation de résultats** : LIMIT 1 pour optimiser la requête
3. **Retour conditionnel** : Rôle trouvé ou null si inexistant

**Implémentation :**
```typescript
const [role] = await db.select().from(Role).where(eq(Role.role_name, 'USER')).limit(1);
return role || null;
```

**Usage typique :**
- Assignation automatique lors de la création de nouveaux comptes utilisateur
- Vérification de l'existence du rôle USER dans le système
- Base pour l'attribution de permissions standard

=== Récupération du rôle ADMIN (getAdminRole)

**Fonctionnement en mots simples :**
Cette fonction agit comme un lecteur de référence qui récupère le rôle système prédéfini "ADMIN".

**Processus de récupération :**
1. **Recherche directe** : SELECT avec condition WHERE role_name = 'ADMIN'
2. **Limitation de résultats** : LIMIT 1 pour optimiser la requête
3. **Retour conditionnel** : Rôle trouvé ou null si inexistant

**Implémentation :**
```typescript
const [role] = await db.select().from(Role).where(eq(Role.role_name, 'ADMIN')).limit(1);
return role || null;
```

**Usage typique :**
- Assignation manuelle de privilèges administrateur
- Vérification de l'existence du rôle ADMIN dans le système
- Base pour l'attribution de permissions complètes

=== Consultation des permissions USER (getUserPermissions)

**Fonctionnement en mots simples :**
Cette fonction agit comme un catalogue qui liste toutes les permissions accordées au rôle USER via une vue matérialisée.

**Processus de récupération :**
1. **Lecture de vue** : SELECT * FROM UserRolePermissionsView
2. **Retour direct** : Liste complète des permissions sans transformation

**Avantages de la vue matérialisée :**
- **Performance** : Données pré-jointes et optimisées
- **Simplicité** : Pas de JOIN complexes à gérer dans le code
- **Maintenance** : Logique de permissions centralisée dans la base

=== Consultation des permissions ADMIN (getAdminPermissions)

**Fonctionnement en mots simples :**
Cette fonction agit comme un catalogue qui liste toutes les permissions accordées au rôle ADMIN via une vue matérialisée.

**Processus de récupération :**
1. **Lecture de vue** : SELECT * FROM AdminRolePermissionsView
2. **Retour direct** : Liste complète des permissions sans transformation

**Avantages de la vue matérialisée :**
- **Performance** : Données pré-jointes et optimisées
- **Simplicité** : Pas de JOIN complexes à gérer dans le code
- **Maintenance** : Logique de permissions centralisée dans la base

== Validation et contrôles qualité

=== Validation minimaliste
Le service applique une approche simple :
- **Pas de validation complexe** : Retour direct des données ou null
- **Gestion gracieuse** : null retourné si rôle inexistant
- **Pas d'exceptions** : Comportement prévisible et sûr

=== Gestion des cas edge
- **Rôle inexistant** : Retour null sans exception
- **Vues vides** : Retour de tableaux vides sans erreur
- **Appels multiples** : Service stateless et thread-safe

== Performance et optimisation

=== Requêtes optimisées
- **Sélection simple** : Pas de JOIN dans le code service
- **LIMIT systématique** : LIMIT 1 pour les recherches de rôles
- **Vues matérialisées** : Performances optimales pour les permissions
- **Index implicites** : Sur role_name pour les recherches rapides

=== Optimisation mémoire
- **Pas de traitement lourd** : Opérations de lecture directe
- **Pas de cache nécessaire** : Données de rôles et permissions stables
- **Destructuring efficient** : `const [role]` pour extraction directe

=== Avantages des vues matérialisées
- **Pré-calcul** : Jointures et agrégations effectuées en amont
- **Lecture rapide** : Accès direct sans calcul à la volée
- **Centralisation** : Logique de permissions maintenue côté base

== Interaction avec d'autres services

=== Services connexes
- **userService** : Attribution du rôle USER aux nouveaux comptes
- **userRoleService** : Association des utilisateurs aux rôles via les IDs récupérés
- **Système d'authentification** : Validation des droits d'accès via les permissions

=== Impact sur d'autres fonctionnalités
- **Création de compte** : Rôle USER attribué automatiquement
- **Contrôle d'accès** : Permissions définies par les vues consultées
- **Administration** : Rôle ADMIN pour les opérations privilégiées

== Exemple de flux complet

=== Scénario : Création d'un nouveau compte utilisateur

**Situation de départ :**
Un nouvel utilisateur s'inscrit sur la plateforme. Le système doit lui attribuer automatiquement le rôle USER.

**Traitement par le service :**
1. **Récupération du rôle USER** : `const userRole = await roleService.getUserRole()`
2. **Vérification** : Si userRole est null, erreur système
3. **Attribution** : Utilisation de `userRole.id_role` pour créer l'association dans UserRole
4. **Permissions** : Les permissions USER sont automatiquement applicables via la vue

**Code typique :**
```typescript
// Dans userService.create()
const userRole = await roleService.getUserRole();
if (!userRole) {
    throw new Error('USER role not found in system');
}

// Attribution du rôle à l'utilisateur
await userRoleService.assignRole({
    id_user: newUser.id_user,
    id_role: userRole.id_role
});
```

=== Scénario : Vérification des permissions d'un administrateur

**Situation de départ :**
Le système doit vérifier qu'un utilisateur administrateur possède bien toutes les permissions nécessaires.

**Traitement par le service :**
1. **Récupération des permissions** : `const adminPermissions = await roleService.getAdminPermissions()`
2. **Consultation** : Liste complète des permissions ADMIN
3. **Validation** : Vérification que les permissions requises sont présentes

== Diagramme de séquence - Workflow RoleService

[mermaid]
----
sequenceDiagram
    participant UserService
    participant RoleService
    participant Database
    participant RoleTable
    participant PermissionViews

    Note over UserService, PermissionViews: Exemple: Attribution rôle USER à nouveau compte

    UserService->>RoleService: getUserRole()
    RoleService->>Database: SELECT FROM Role WHERE role_name = 'USER' LIMIT 1
    Database->>RoleTable: Query role table
    RoleTable-->>Database: role || []
    Database-->>RoleService: [role] || []

    alt Si rôle inexistant
        RoleService-->>UserService: null
        UserService->>UserService: throw Error('USER role not found')
    else Rôle trouvé
        RoleService-->>UserService: userRole
        UserService->>UserService: Utiliser userRole.id_role pour attribution
    end

    Note over UserService, PermissionViews: Exemple: Consultation des permissions ADMIN

    UserService->>RoleService: getAdminPermissions()
    RoleService->>Database: SELECT * FROM AdminRolePermissionsView
    Database->>PermissionViews: Query materialized view
    PermissionViews-->>Database: permissions[]
    Database-->>RoleService: permissions[]
    RoleService-->>UserService: permissions[]
----

== Opérations CRUD détaillées

=== Création de rôle (create)

**Fonctionnement en mots simples :**
Crée un nouveau rôle personnalisé dans le système avec un nom et une description.

**Processus de création :**
1. **Validation** : Vérification que role_name et description sont fournis
2. **Insertion** : INSERT INTO Role avec les données fournies
3. **Retour** : Rôle créé avec son ID généré

**Implémentation :**
```typescript
const [result] = await db.insert(Role)
    .values(data)
    .returning();
return result;
```

=== Récupération de tous les rôles (getAll)

**Fonctionnement en mots simples :**
Récupère la liste complète de tous les rôles du système.

**Implémentation :**
```typescript
return await db.select().from(Role);
```

=== Récupération d'un rôle par ID (getById)

**Fonctionnement en mots simples :**
Récupère un rôle spécifique via son identifiant unique.

**Implémentation :**
```typescript
const [role] = await db.select().from(Role).where(eq(Role.id_role, roleId)).limit(1);
return role || null;
```

=== Mise à jour d'un rôle (update)

**Fonctionnement en mots simples :**
Modifie le nom ou la description d'un rôle existant.

**Processus de mise à jour :**
1. **Mise à jour** : UPDATE Role SET ... WHERE id_role = ?
2. **Vérification** : Erreur si le rôle n'existe pas
3. **Retour** : Rôle mis à jour

**Implémentation :**
```typescript
const [result] = await db.update(Role)
    .set(data)
    .where(eq(Role.id_role, roleId))
    .returning();

if (!result) {
    throw new Error('Role not found.');
}
return result;
```

=== Suppression d'un rôle (delete)

**Fonctionnement en mots simples :**
Supprime définitivement un rôle du système.

**Processus de suppression :**
1. **Suppression** : DELETE FROM Role WHERE id_role = ?
2. **Vérification** : Erreur si le rôle n'existe pas
3. **Retour** : Rôle supprimé

**Implémentation :**
```typescript
const [result] = await db.delete(Role)
    .where(eq(Role.id_role, roleId))
    .returning();

if (!result) {
    throw new Error('Role not found.');
}
return result;
```

== Gestion des permissions détaillée

=== Ajout d'une permission (addPermission)

**Fonctionnement en mots simples :**
Associe une permission existante à un rôle.

**Processus d'ajout :**
1. **Vérification d'unicité** : Vérifier que l'association n'existe pas déjà
2. **Insertion** : INSERT INTO RolePermission
3. **Retour** : Association créée

**Implémentation :**
```typescript
const existing = await db.select().from(RolePermission)
    .where(and(eq(RolePermission.id_role, roleId), eq(RolePermission.id_permission, permissionId)))
    .limit(1);

if (existing.length > 0) {
    throw new Error('Permission already assigned to this role.');
}

const [result] = await db.insert(RolePermission)
    .values({ id_role: roleId, id_permission: permissionId })
    .returning();

return result;
```

=== Suppression d'une permission (removePermission)

**Fonctionnement en mots simples :**
Retire une permission d'un rôle.

**Processus de suppression :**
1. **Suppression** : DELETE FROM RolePermission WHERE ...
2. **Vérification** : Erreur si l'association n'existe pas
3. **Retour** : Association supprimée

**Implémentation :**
```typescript
const [result] = await db.delete(RolePermission)
    .where(and(eq(RolePermission.id_role, roleId), eq(RolePermission.id_permission, permissionId)))
    .returning();

if (!result) {
    throw new Error('Permission not found for this role.');
}

return result;
```

== Fonctionnalités du système RBAC complet

=== Fonctionnalités implémentées

- ✅ **Création de rôles** : Fonction `create()`
- ✅ **Modification de rôles** : Fonction `update()`
- ✅ **Suppression de rôles** : Fonction `delete()`
- ✅ **Gestion des permissions** : `addPermission()` / `removePermission()`
- ✅ **Consultation de tous les rôles** : `getAll()`
- ✅ **Consultation par ID** : `getById()`
- ✅ **Rôles système** : `getUserRole()` / `getAdminRole()`
- ✅ **Permissions système** : `getUserPermissions()` / `getAdminPermissions()`

=== Pourquoi cette architecture complète ?

Cette architecture complète permet :
- **Flexibilité** : Création de rôles personnalisés selon les besoins
- **Gestion dynamique** : Ajout/suppression de permissions à la volée
- **Évolutivité** : Le système peut s'adapter aux nouveaux besoins
- **Contrôle fin** : Gestion précise des permissions par rôle
- **Maintenance** : Modifications sans intervention en base de données

== Structure des données

=== Modèle Role
```typescript
interface Role {
    id_role: string;           // Identifiant unique
    role_name: string;         // Nom du rôle (USER, ADMIN)
    description?: string;      // Description optionnelle
    created_at: Date;         // Date de création
}
```

=== Vues de permissions
```typescript
// UserRolePermissionsView
interface UserPermission {
    id_permission: string;
    permission_name: string;
    description?: string;
    // Autres champs selon la définition de la vue
}

// AdminRolePermissionsView
interface AdminPermission {
    id_permission: string;
    permission_name: string;
    description?: string;
    // Autres champs selon la définition de la vue
}
```

== Résumé

Le service roleService est le **gestionnaire complet RBAC** de l'API BlaBlaBook V2. Il gère **12 opérations** avec :
- **Consultation des rôles système** : Accès direct aux rôles USER et ADMIN
- **CRUD complet** : Création, lecture, mise à jour et suppression de rôles
- **Gestion des permissions** : Ajout et suppression de permissions sur les rôles
- **Vues matérialisées** : Exploitation de UserRolePermissionsView et AdminRolePermissionsView
- **Validation robuste** : Vérification d'unicité et gestion d'erreurs
- **Performance optimisée** : Utilisation de LIMIT 1 et vues pré-calculées
- **Gestion gracieuse** : Retour null pour les rôles inexistants, erreurs explicites pour les opérations d'écriture

**Il assure la gestion complète des rôles et permissions pour un contrôle d'accès flexible et évolutif de la plateforme.**

NOTE: Cette version complète permet une gestion dynamique des rôles et permissions, tout en conservant l'accès rapide aux rôles système USER et ADMIN via des vues matérialisées.