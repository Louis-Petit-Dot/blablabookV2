= Service GenreService (Version Simplifiée) - Analyse Complète
:toc:
:toclevels: 3

== Vue d'ensemble

Le service genreService gère les genres littéraires dans l'API BlaBlaBook V2. Il s'occupe de la création, de la consultation et de la gestion des catégories de livres, tout en offrant une intégration avec l'API OpenLibrary pour découvrir des livres par genre depuis des sources externes.

NOTE: Ce service utilise `.select()` **sans projections explicites** car la table Genre ne contient **aucune donnée sensible**. Toutes les informations (nom de genre, description) sont publiques. L'utilisation de `.select().from(Genre)` est donc appropriée et optimale pour ce cas d'usage.

== Fonctions principales

=== getAll
**Objectif:** Récupérer la liste complète de tous les genres enregistrés
**Quand:** Utilisé pour afficher le catalogue de genres ou dans les interfaces d'administration
**Pourquoi important:** Permet la navigation et l'organisation thématique de la bibliothèque

=== getById
**Objectif:** Récupérer les informations détaillées d'un genre spécifique
**Quand:** Utilisé pour afficher la page détaillée d'un genre
**Pourquoi important:** Fournit les données nécessaires pour l'affichage des détails d'une catégorie

=== create
**Objectif:** Créer un nouveau genre dans la base de données
**Quand:** Utilisé lors de l'ajout d'une nouvelle catégorie au système
**Pourquoi important:** Enrichit le système de classification et améliore l'organisation du catalogue

=== getBooks
**Objectif:** Rechercher des livres par genre via l'API OpenLibrary
**Quand:** Utilisé pour découvrir des livres d'un genre depuis des sources externes
**Pourquoi important:** Enrichit l'expérience utilisateur avec des suggestions de livres externes

== Fonctionnement du service genreService

=== Rôle de gestionnaire de taxonomie littéraire
Le service genreService fonctionne comme un système de classification :

1. **Répertoire des catégories** : Il maintient un catalogue de tous les genres littéraires
2. **Validation d'unicité** : Il s'assure qu'aucun genre n'est dupliqué par nom
3. **Enrichissement externe** : Il utilise OpenLibrary pour découvrir des livres par genre
4. **Organisation thématique** : Il permet la structuration du catalogue par centres d'intérêt
5. **Évolutivité** : Il permet l'ajout dynamique de nouvelles catégories

=== Intégration avec OpenLibrary
Le service intègre l'API OpenLibrary pour :
- **Recherche par sujet** : Découverte de livres via la requête `subject:"genre"`
- **Enrichissement du catalogue** : Suggestions de livres non présents localement
- **Exploration externe** : Accès à une base de données littéraire étendue

=== Système de validation intégré
Le service applique plusieurs niveaux de validation :
- **Validation d'entité** : Vérification que le genre existe via EntityValidator
- **Validation d'unicité** : Prévention des doublons par nom de genre
- **Validation des données** : Contrôle des champs obligatoires et optionnels

== Opérations détaillées

=== Consultation des genres (getAll / getById)

**Fonctionnement en mots simples :**
Ces fonctions agissent comme un catalogue de catégories qui permet de consulter la taxonomie complète ou de rechercher une catégorie spécifique.

**Processus de récupération :**
1. **getAll** : Collecte tous les genres sans filtrage
2. **getById** : Valide l'existence puis retourne le genre spécifique
3. **Enrichissement des données** : Calcule automatiquement le nombre total
4. **Format standardisé** : Retourne les données dans une structure cohérente

**Données retournées :**
- Liste complète des genres ou genre spécifique
- Compteur total pour les statistiques
- Informations descriptives disponibles

=== Création de genre (create)

**Fonctionnement en mots simples :**
Cette fonction agit comme un bureau d'enregistrement qui ajoute une nouvelle catégorie au système après vérification.

**Processus de validation :**
1. **Vérification d'unicité** : Recherche si un genre avec ce nom existe déjà
2. **Prévention des doublons** : Refuse la création si le nom est déjà pris
3. **Insertion sécurisée** : Crée le nouveau genre en base de données
4. **Retour des données** : Fournit le genre créé avec son ID généré

**Protection contre les doublons :**
Le système empêche la création de genres avec des noms identiques, maintenant ainsi l'unicité et évitant la confusion dans la classification.

**Données optionnelles :**
- **genre_name** : Obligatoire, nom unique du genre
- **description** : Optionnelle, description détaillée de la catégorie

=== Découverte de livres externes (getBooks)

**Fonctionnement en mots simples :**
Cette fonction agit comme un explorateur externe qui recherche tous les livres d'un genre dans les bases de données OpenLibrary.

**Processus d'enrichissement :**
1. **Construction de requête** : Utilise la syntaxe `subject:"genre"` pour OpenLibrary
2. **Limitation des résultats** : Récupère jusqu'à 50 livres pour éviter la surcharge
3. **Recherche externe** : Interroge l'API OpenLibrary avec le nom du genre
4. **Structuration des données** : Organise les résultats avec le genre et les livres découverts

**Enrichissement externe :**
Cette fonction permet de découvrir des livres qui ne sont pas encore dans la base locale, offrant une vision complète des livres disponibles dans une catégorie spécifique.

**Format de requête OpenLibrary :**
```javascript
OpenLibrary.searchBooks({
  q: `subject:"${genreName}"`,
  limit: 50
});
```

== Validation et contrôles qualité

=== EntityValidator integration
Le service s'appuie sur EntityValidator pour :
- **validateGenre** : Confirmer l'existence du genre demandé
- **Gestion cohérente** : Messages d'erreur standardisés avec les autres services
- **Validation automatique** : Intégration transparente dans les opérations

=== Contrôles métier spécifiques
Le service applique ses propres règles :
- **Unicité par nom** : Prévention des doublons de genres
- **Champs obligatoires** : Validation du nom de genre
- **Limite de résultats** : Maximum 50 livres par recherche OpenLibrary

=== Intégration OpenLibrary
La connexion avec l'API externe inclut :
- **Gestion des erreurs** : Récupération gracieuse en cas d'indisponibilité
- **Structuration des données** : Normalisation des réponses de l'API
- **Limitation de charge** : Contrôle du nombre de résultats pour les performances

== Gestion des erreurs spécialisées

=== Erreurs de duplication
- **Genre déjà existant** : "A genre with this name already exists."
- **Validation préalable** : Vérification avant insertion pour éviter les conflits
- **Message explicite** : Information claire sur la cause du rejet

=== Erreurs de validation
- **Genre inexistant** : Gérée par EntityValidator avec message standardisé
- **API externe** : Gestion des erreurs de communication avec OpenLibrary
- **Données manquantes** : Validation des champs obligatoires

=== Gestion des cas limites
- **Genre sans livres** : Recherche externe possible même sans livres locaux
- **API indisponible** : Récupération gracieuse avec données partielles
- **Noms de genres complexes** : Support des caractères internationaux et espaces

== Performance et optimisation

=== Requêtes optimisées
- **Sélections ciblées** : Utilisation de LIMIT pour les vérifications d'unicité
- **Index sur nom** : Recommandé pour les recherches par nom de genre
- **Pas de jointures** : Service simple sans JOIN complexes

=== Gestion des API externes
- **Limite de résultats** : 50 livres maximum par requête OpenLibrary
- **Cache potentiel** : Possibilité d'ajouter une mise en cache des résultats
- **Timeout approprié** : Protection contre les API lentes

=== Optimisation mémoire
- **Réutilisation de connexions** : Partage de la connexion base de données
- **Nettoyage automatique** : Libération des ressources après traitement
- **Pas de chargement massif** : Pas de récupération de grandes collections

== Interaction avec d'autres services

=== Dépendances directes
- **EntityValidator** : Validation de l'existence des genres
- **OpenLibrary API** : Recherche de livres par genre
- **Database connection** : Opérations CRUD via Drizzle ORM

=== Services connexes
- **bookGenreService** : Association des genres avec les livres
- **bookService** : Catégorisation des livres par genre
- **authorService** : Classification des auteurs par genres préférés

=== Impact sur d'autres fonctionnalités
- **Recherche** : Les genres alimentent les filtres de recherche par catégorie
- **Recommandations** : Base pour des suggestions par genre préféré
- **Navigation** : Organisation thématique du catalogue
- **Statistiques** : Métriques de popularité par genre

== Exemple de flux complet

=== Scénario : Création d'un nouveau genre "Cyberpunk" avec découverte de livres

**Situation de départ :**
Un administrateur souhaite ajouter "Cyberpunk" comme nouveau genre et découvrir immédiatement des livres de cette catégorie.

**Traitement par le service :**
1. **Vérification d'unicité** : Confirme qu'aucun genre "Cyberpunk" n'existe
2. **Création du genre** : Insère le nouveau genre dans la base locale
3. **Recherche OpenLibrary** : Interroge l'API avec `subject:"Cyberpunk"`
4. **Découverte automatique** : Trouve "Neuromancer", "Snow Crash", etc.
5. **Structuration du retour** : Combine le genre créé et les livres découverts

**Enrichissement automatique :**
Le service découvre automatiquement des classiques du cyberpunk comme "Neuromancer" de William Gibson, enrichissant immédiatement les suggestions disponibles.

**Résultat :**
L'administrateur obtient un nouveau genre complet avec accès immédiat à une bibliographie via les sources externes.

== Diagramme de séquence - Workflow GenreService

[mermaid]
----
sequenceDiagram
    participant Controller
    participant GenreService
    participant EntityValidator
    participant Database
    participant OpenLibrary

    Note over Controller, OpenLibrary: Exemple: Création d'un nouveau genre

    Controller->>GenreService: create({genre_name, description})
    GenreService->>Database: SELECT FROM genres WHERE genre_name = ?
    Database-->>GenreService: existingGenre || []

    alt Si genre déjà existant
        GenreService-->>Controller: throw Error("A genre with this name already exists.")
    else Genre unique
        GenreService->>Database: INSERT INTO genres VALUES(genreData)
        Database-->>GenreService: newGenre avec id_genre généré
        GenreService-->>Controller: {genre: newGenre}
    end

    Note over Controller, OpenLibrary: Exemple: Consultation d'un genre par ID

    Controller->>GenreService: getById(genreId)
    GenreService->>EntityValidator: validateGenre(genreId)
    EntityValidator->>Database: SELECT FROM genres WHERE id_genre = ?
    Database-->>EntityValidator: genreData || null

    alt Si genre inexistant
        EntityValidator-->>GenreService: throw Error("Genre not found")
    else Genre trouvé
        EntityValidator-->>GenreService: genreData
        GenreService-->>Controller: {genre: genreData}
    end

    Note over Controller, OpenLibrary: Exemple: Découverte de livres par genre

    Controller->>GenreService: getBooks(genreName)
    GenreService->>OpenLibrary: searchBooks({q: 'subject:"genreName"', limit: 50})
    OpenLibrary->>OpenLibrary: Rechercher dans la base OpenLibrary

    alt Si API indisponible
        OpenLibrary-->>GenreService: Error ou timeout
        GenreService-->>Controller: {genre: genreName, books: []}
    else Recherche réussie
        OpenLibrary-->>GenreService: {docs: [...books]}
        GenreService-->>Controller: {genre: genreName, books: books.docs}
    end

    Note over Controller, OpenLibrary: Exemple: Récupération de tous les genres

    Controller->>GenreService: getAll()
    GenreService->>Database: SELECT * FROM genres
    Database-->>GenreService: genres[]
    GenreService->>GenreService: Calculer genres.length
    GenreService-->>Controller: {genres: genres[], total_genres: count}
----

== Résumé

Le service genreService est le **gestionnaire de taxonomie littéraire** de l'API BlaBlaBook V2. Il gère **4 opérations principales** avec :
- **Validation d'unicité** : Prévention des doublons par nom de genre
- **Intégration OpenLibrary** : Enrichissement avec des données externes de livres par genre
- **Classification évolutive** : Ajout dynamique de nouvelles catégories
- **EntityValidator** : Validation cohérente avec le reste du système
- **Gestion d'erreurs** : Messages explicites pour les cas de conflit
- **Recherche externe** : Découverte de livres via API OpenLibrary avec limitation à 50 résultats

**Points clés d'optimisation :**
- ✅ `.select()` complet approprié (pas de données sensibles)
- ✅ `LIMIT 1` pour les vérifications d'unicité
- ✅ `.returning()` complet pour les opérations de création
- ✅ Recherche OpenLibrary via `subject:"genre"` pour précision
- ✅ Pas de projections explicites nécessaires pour ce cas d'usage

**Il assure l'organisation thématique et l'enrichissement du catalogue littéraire de la plateforme.**