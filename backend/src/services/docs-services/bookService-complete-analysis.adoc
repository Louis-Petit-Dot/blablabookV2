= Service BookService - Analyse Compl√®te
:toc:
:toclevels: 3

== Vue d'ensemble

Le service bookService g√®re les op√©rations de recherche, de consultation et d'import de livres dans l'API BlaBlaBook V2. Il s'occupe de la r√©cup√©ration des informations sur les livres depuis l'API externe OpenLibrary, de la gestion du catalogue local, et de l'importation de livres dans la base de donn√©es avec upload des couvertures sur Cloudinary.

NOTE: Ce service utilise `.select()` **sans projections explicites** car la table Book ne contient **aucune donn√©e sensible**. Toutes les informations (titre, ISBN, r√©sum√©, etc.) sont publiques par nature. L'utilisation de `.select().from(Book)` est donc appropri√©e et optimale pour ce cas d'usage.

== Fonctions principales

=== search
**Objectif:** Rechercher des livres via l'API OpenLibrary et indiquer lesquels sont d√©j√† import√©s localement
**Quand:** Utilis√© lors des recherches d'utilisateurs dans la barre de recherche
**Pourquoi important:** Permet la d√©couverte de nouveaux livres depuis OpenLibrary tout en indiquant ceux d√©j√† pr√©sents dans la base locale

=== getById
**Objectif:** R√©cup√©rer les informations d√©taill√©es d'un livre sp√©cifique depuis la base locale
**Quand:** Utilis√© pour afficher la page d√©tail d'un livre
**Pourquoi important:** Fournit les donn√©es n√©cessaires pour l'affichage des fiches livre

=== getAll
**Objectif:** R√©cup√©rer la liste de tous les livres de la base locale avec pagination
**Quand:** Utilis√© pour afficher le catalogue complet ou dans les interfaces d'administration
**Pourquoi important:** Permet la navigation et la d√©couverte de livres dans la biblioth√®que locale

=== getTrending
**Objectif:** R√©cup√©rer une s√©lection al√©atoire de livres depuis la base locale
**Quand:** Utilis√© pour afficher les suggestions de livres sur la page d'accueil
**Pourquoi important:** Fournit des recommandations vari√©es et performantes sans appel API externe

=== createFromOpenLibrary
**Objectif:** Importer un livre depuis OpenLibrary dans la base locale avec sa couverture
**Quand:** Utilis√© quand un utilisateur souhaite ajouter un nouveau livre √† son catalogue
**Pourquoi important:** Permet l'enrichissement progressif du catalogue local depuis une source externe fiable

== Fonctionnement du service bookService

=== R√¥le de pont entre OpenLibrary et la base locale
Le service bookService fonctionne comme un syst√®me hybride :

1. **Moteur de recherche externe** : Il interroge l'API OpenLibrary pour la d√©couverte de livres
2. **Catalogue local** : Il g√®re les livres import√©s dans la base de donn√©es PostgreSQL
3. **D√©tection de doublons** : Il v√©rifie automatiquement si un livre OpenLibrary est d√©j√† import√©
4. **Import intelligent** : Il cr√©e les livres, auteurs et relations lors de l'importation
5. **Upload de couvertures** : Il g√®re l'upload des images vers Cloudinary

=== Syst√®me de recherche hybride
Le service utilise une approche en deux √©tapes :
- **Recherche OpenLibrary** : Interrogation de l'API externe pour trouver des livres
- **V√©rification locale** : Contr√¥le des livres d√©j√† import√©s via `openlibrary_key`
- **Enrichissement de r√©ponse** : Ajout des champs `isImported` et `localId` pour chaque livre
- **Limitation intelligente** : 20 r√©sultats maximum pour la performance

=== Gestion des trending books
Pour optimiser les performances de la page d'accueil :
- **Source locale uniquement** : S√©lection depuis la base PostgreSQL (pas d'appel OpenLibrary)
- **S√©lection al√©atoire** : Utilisation de `RANDOM()` pour varier les suggestions
- **Jointures optimis√©es** : R√©cup√©ration des auteurs en une seule requ√™te
- **Limite par d√©faut** : 20 livres pour √©quilibrer vari√©t√© et performance

=== Processus d'importation complet
L'import d'un livre depuis OpenLibrary suit ce workflow :
- **D√©tection de doublons** : V√©rification par `openlibrary_key` et `isbn`
- **Cr√©ation du livre** : INSERT dans la table Book
- **Upload Cloudinary** : Upload de la couverture et mise √† jour de l'URL
- **Gestion des auteurs** : Cr√©ation ou r√©cup√©ration des auteurs existants
- **Relations** : Cr√©ation des liens book-author dans BookAuthor

== Op√©rations d√©taill√©es

=== Recherche de livres (search)

**Fonctionnement en mots simples :**
Cette fonction interroge l'API OpenLibrary pour trouver des livres, puis v√©rifie lesquels sont d√©j√† import√©s dans la base locale.

**Processus de recherche :**
1. **Requ√™te OpenLibrary** : Appel de `searchGeneral(query, 20)` depuis le service OpenLibrary
2. **Extraction des cl√©s** : R√©cup√©ration des `openlibrary_key` de chaque livre trouv√©
3. **V√©rification locale** : SELECT sur Book avec OR sur toutes les cl√©s OpenLibrary
4. **Mapping enrichi** : Ajout de `isImported` (boolean) et `localId` (UUID si import√©) √† chaque livre
5. **Retour structur√©** : {books, total_books, search_query, source: "openlibrary"}

**Structure de r√©ponse enrichie :**
```javascript
{
    books: [
        {
            key: "/works/OL893415W",
            title: "1984",
            author_name: ["George Orwell"],
            cover_i: 8228691,
            first_publish_year: 1949,
            isbn: "0451524934",
            subject: ["Fiction", "Dystopia"],
            isImported: true,          // ‚Üê NOUVEAU: indique si d√©j√† en base
            localId: "uuid-du-livre"   // ‚Üê NOUVEAU: ID local si import√©
        }
    ],
    total_books: 1,
    search_query: "1984",
    source: "openlibrary"
}
```

**Gestion des doublons :**
Le service utilise un `Set` pour v√©rifier rapidement si une cl√© OpenLibrary est pr√©sente localement, optimisant la performance.

=== Consultation d√©taill√©e (getById)

**Fonctionnement en mots simples :**
Cette fonction r√©cup√®re un livre sp√©cifique depuis la **base locale uniquement** (pas d'appel OpenLibrary).

**Processus de validation :**
1. **Validation d'existence** : Utilise EntityValidator pour confirmer que le livre existe localement
2. **R√©cup√©ration s√©curis√©e** : Obtient les donn√©es compl√®tes du livre valid√©
3. **Format standardis√©** : Retourne les informations dans une structure coh√©rente
4. **Gestion d'erreurs** : L√®ve une exception si le livre n'existe pas

**S√©curit√© int√©gr√©e :**
L'utilisation d'EntityValidator garantit que seuls les livres existants dans la base locale sont retourn√©s, √©vitant les erreurs d'affichage.

=== Consultation du catalogue (getAll)

**Fonctionnement en mots simples :**
Cette fonction r√©cup√®re une liste de livres depuis la **base locale uniquement**.

**Processus de r√©cup√©ration :**
1. **Param√®tre de limite** : Accepte une limite personnalis√©e (50 par d√©faut)
2. **S√©lection pagin√©e** : R√©cup√®re le nombre demand√© de livres locaux
3. **Comptage automatique** : Calcule le nombre de livres retourn√©s
4. **M√©tadonn√©es incluses** : Retourne la limite appliqu√©e pour information

**Gestion de la charge :**
La limite par d√©faut de 50 livres √©quilibre la richesse des donn√©es et la performance de l'interface.

=== Livres tendances (getTrending)

**Fonctionnement en mots simples :**
Cette fonction s√©lectionne al√©atoirement des livres depuis la **base locale** pour afficher des suggestions vari√©es sur la page d'accueil.

**Changement architectural important :**
```javascript
// ANCIEN CODE (comment√©) - Causait LCP 30s
// const olResults = await getTrendingBooks(limit);
// Interrogeait OpenLibrary √† chaque chargement de page

// NOUVEAU CODE - Performance optimale
const localBooks = await db
    .select({...})
    .from(Book)
    .leftJoin(BookAuthor, ...)
    .leftJoin(Author, ...)
    .orderBy(sql`RANDOM()`)
    .limit(limit);
```

**Raison du changement :**
L'ancien code utilisant OpenLibrary causait un **LCP (Largest Contentful Paint) de 30 secondes**, rendant la page d'accueil inutilisable. Le nouveau code utilise uniquement la base locale avec s√©lection al√©atoire.

**Processus de r√©cup√©ration :**
1. **S√©lection al√©atoire** : `orderBy(sql\`RANDOM()\`)` pour varier les suggestions
2. **Jointures optimis√©es** : R√©cup√©ration des auteurs en une seule requ√™te (LEFT JOIN)
3. **Groupement des auteurs** : Agr√©gation des auteurs multiples par livre via Map
4. **Limite par d√©faut** : 20 livres pour √©quilibrer vari√©t√© et performance
5. **Retour structur√©** : {books, total_books, source: "local-random"}

**Structure de r√©ponse :**
```javascript
{
    books: [
        {
            key: "local-uuid",           // Cl√© locale si pas d'openlibrary_key
            title: "Le Petit Prince",
            author_name: ["Antoine de Saint-Exup√©ry"],
            cover_i: null,               // Pas de cover_i pour livres locaux
            first_publish_year: 1943,
            image: "https://cloudinary.com/...",
            isLocal: true                // Indique que c'est un livre local
        }
    ],
    total_books: 20,
    source: "local-random"
}
```

=== Importation depuis OpenLibrary (createFromOpenLibrary)

**Fonctionnement en mots simples :**
Cette fonction importe un livre complet depuis OpenLibrary dans la base locale, incluant la cr√©ation des auteurs, l'upload de la couverture sur Cloudinary, et les relations book-author.

**Processus complet d'importation :**

==== 1. D√©tection de doublons (lignes 148-176)
```javascript
// V√©rification par openlibrary_key
if (openLibraryData.key) {
    const existingByKey = await db.select()
        .from(Book)
        .where(eq(Book.openlibrary_key, openLibraryData.key))
        .limit(1);

    if (existingByKey.length > 0) {
        return {
            book: existingByKey[0],
            message: "Ce livre existe d√©j√† dans la base de donn√©es",
            isNew: false
        };
    }
}

// V√©rification par ISBN
if (openLibraryData.isbn?.[0]) {
    const existingByIsbn = await db.select()
        .from(Book)
        .where(eq(Book.isbn, openLibraryData.isbn[0]))
        .limit(1);
    // ...
}
```

**Double protection :**
- Par `openlibrary_key` en priorit√© (identifiant unique OpenLibrary)
- Par `isbn` en fallback (pour d√©tecter les imports manuels)

==== 2. Cr√©ation du livre (lignes 178-187)
```javascript
const [newBook] = await db.insert(Book).values({
    title: openLibraryData.title,
    isbn: openLibraryData.isbn?.[0] || null,
    openlibrary_key: openLibraryData.key,
    publication_year: openLibraryData.first_publish_year || null,
    image: null, // Sera mis √† jour apr√®s l'upload Cloudinary
}).returning();

const bookId = newBook.id_book; // UUID g√©n√©r√© par PostgreSQL
```

**Point cl√© :**
PostgreSQL g√©n√®re automatiquement l'UUID via `gen_random_uuid()`, pas besoin de le fournir.

==== 3. Upload de la couverture sur Cloudinary (lignes 189-204)
```javascript
if (openLibraryData.key) {
    const uploadResult = await imageService.uploadBookCover(
        bookId,
        openLibraryData.key
    );

    if (uploadResult.success && uploadResult.url) {
        // Mise √† jour de l'URL de l'image
        await db.update(Book)
            .set({ image: uploadResult.url })
            .where(eq(Book.id_book, bookId));

        newBook.image = uploadResult.url;
    }
}
```

**Processus Cloudinary :**
- Le service `imageService.uploadBookCover()` t√©l√©charge la couverture depuis OpenLibrary
- Upload vers Cloudinary avec transformation automatique (resize, optimization)
- Retour de l'URL publique Cloudinary
- Mise √† jour du champ `image` dans Book

==== 4. Cr√©ation des auteurs et relations (lignes 206-233)
```javascript
if (openLibraryData.author_name && openLibraryData.author_name.length > 0) {
    for (const authorName of openLibraryData.author_name) {
        // V√©rifie si l'auteur existe d√©j√†
        const [existingAuthor] = await db.select()
            .from(Author)
            .where(eq(Author.author_name, authorName))
            .limit(1);

        let authorId: string;

        if (existingAuthor) {
            authorId = existingAuthor.id_author;
        } else {
            // Cr√©e le nouvel auteur
            const [newAuthor] = await db.insert(Author).values({
                author_name: authorName,
            }).returning();
            authorId = newAuthor.id_author;
        }

        // Cr√©e la relation book-author
        await db.insert(BookAuthor).values({
            id_book: bookId,
            id_author: authorId,
        });
    }
}
```

**Gestion intelligente des auteurs :**
- **R√©utilisation** : Si l'auteur existe d√©j√†, r√©cup√©ration de son ID
- **Cr√©ation** : Si nouvel auteur, insertion avec g√©n√©ration d'UUID
- **Relations** : Cr√©ation syst√©matique du lien book-author dans la table de jonction

==== 5. Retour structur√© (lignes 235-239)
```javascript
return {
    book: newBook,
    message: "Livre import√© avec succ√®s depuis OpenLibrary",
    isNew: true
};
```

**R√©ponse compl√®te :**
- `book` : Objet Book complet avec l'URL Cloudinary mise √† jour
- `message` : Message de succ√®s localis√©
- `isNew` : Boolean indiquant qu'il s'agit d'un nouvel import (vs doublon)

== Validation et contr√¥les qualit√©

=== EntityValidator integration
Le service s'appuie sur EntityValidator pour :
- **validateBook** : Confirmer l'existence du livre demand√© dans la base locale
- **Gestion coh√©rente** : Messages d'erreur standardis√©s avec les autres services
- **Validation automatique** : Int√©gration transparente dans getById

=== Contr√¥les de performance
Le service applique des limites intelligentes :
- **Limite de recherche** : 20 r√©sultats maximum pour les recherches OpenLibrary
- **Limite de trending** : 20 livres al√©atoires par d√©faut
- **Limite de consultation** : 50 livres par d√©faut pour getAll
- **Optimisation des requ√™tes** : Utilisation de LEFT JOIN pour r√©cup√©rer les auteurs
- **Pr√©vention de surcharge** : Protection contre les requ√™tes trop larges

=== Gestion des doublons
Les fonctionnalit√©s de d√©tection incluent :
- **Double v√©rification** : Par `openlibrary_key` ET par `isbn`
- **Retour informatif** : `isNew: false` si doublon d√©tect√©
- **Performance** : Utilisation de `Set` pour v√©rification O(1) dans search()
- **S√©curit√©** : Pr√©vention des imports multiples du m√™me livre

== Gestion des erreurs sp√©cialis√©es

=== Erreurs de validation
- **Livre inexistant** : G√©r√©e par EntityValidator avec message standardis√©
- **ID invalide** : Validation du format avant recherche en base
- **Param√®tres manquants** : Gestion gracieuse avec valeurs par d√©faut

=== Erreurs d'importation
- **Doublon d√©tect√©** : Retour gracieux avec `isNew: false`
- **√âchec upload Cloudinary** : L'import continue sans image (NULL)
- **Auteur manquant** : Import du livre sans relation author (optionnel)
- **OpenLibrary API down** : Propagation de l'erreur avec message explicite

=== Gestion des cas limites
- **Aucun r√©sultat** : Retour d'une liste vide sans erreur
- **Recherche trop large** : Limitation automatique √† 20 r√©sultats
- **Catalogue vide** : Gestion gracieuse avec compteur √† z√©ro
- **Livre sans couverture** : Import valide avec `image: NULL`

== Performance et optimisation

=== Requ√™tes optimis√©es
- **Index recommand√©s** : Sur `openlibrary_key` et `isbn` pour les recherches et d√©tections de doublons
- **LIMIT syst√©matique** : Pr√©vention des requ√™tes sans limite
- **LEFT JOIN efficace** : R√©cup√©ration des auteurs en une seule requ√™te dans getTrending
- **RANDOM() PostgreSQL** : S√©lection al√©atoire native pour performance optimale
- **Projection compl√®te** : SELECT * acceptable pour l'entit√© Book (pas de donn√©es sensibles)

=== Gestion m√©moire
- **Limitation des r√©sultats** : Maximum 50 livres par requ√™te getAll
- **Groupement efficace** : Utilisation de Map pour agr√©ger les auteurs par livre
- **R√©utilisation de connexions** : Partage de la connexion base de donn√©es
- **Nettoyage automatique** : Lib√©ration des ressources apr√®s traitement

=== Cache et optimisations externes
- **Cloudinary CDN** : Les images sont servies via CDN global
- **OpenLibrary throttling** : Limite de 20 r√©sultats pour respecter les limites API
- **Base locale prioritaire** : getTrending n'appelle jamais OpenLibrary pour la performance

== Interaction avec d'autres services

=== D√©pendances directes
- **EntityValidator** : Validation de l'existence des livres
- **openlibrary/books** : Service d'interrogation de l'API OpenLibrary externe
- **cloudinary/imageService** : Upload et transformation des couvertures
- **Database connection** : Op√©rations CRUD via Drizzle ORM

=== Services connexes
- **authorService** : Gestion des auteurs cr√©√©s lors de l'import
- **genreService** : Cat√©gorisation possible des livres par genre (futur)
- **reviewService** : Association avec les avis sur les livres
- **rateService** : Lien avec les notes attribu√©es aux livres

=== Tables impact√©es lors de l'import
- **Book** : Insertion du livre principal
- **Author** : Cr√©ation ou r√©utilisation des auteurs
- **BookAuthor** : Cr√©ation des relations many-to-many
- **Cloudinary** : Upload externe des images de couverture

== Exemple de flux complet

=== Sc√©nario 1 : Recherche d'un livre sur OpenLibrary

**Situation de d√©part :**
Marie tape "1984" dans la barre de recherche pour trouver le livre de George Orwell.

**Traitement par le service :**
1. **Requ√™te OpenLibrary** : `searchGeneral("1984", 20)` retourne 20 livres
2. **Extraction des cl√©s** : R√©cup√©ration de tous les `key` OpenLibrary (ex: "/works/OL893415W")
3. **V√©rification locale** : SELECT sur Book avec OR sur toutes les cl√©s
4. **Enrichissement** : Ajout de `isImported: true` et `localId: "uuid"` pour les livres d√©j√† import√©s
5. **Retour** : Liste de 20 livres avec indication claire de ceux d√©j√† pr√©sents localement

**R√©sultat :**
Marie voit une liste de livres avec un indicateur visuel pour ceux d√©j√† dans sa biblioth√®que, et peut importer les autres.

=== Sc√©nario 2 : Import d'un livre depuis OpenLibrary

**Situation de d√©part :**
Pierre veut ajouter "Le Petit Prince" √† sa collection apr√®s l'avoir trouv√© via search.

**Traitement par le service :**
1. **D√©tection doublon** : V√©rification par `openlibrary_key` et `isbn` ‚Üí Livre non trouv√© localement
2. **Cr√©ation Book** : INSERT dans la table Book avec titre, ISBN, publication_year
3. **Upload Cloudinary** : T√©l√©chargement de la couverture depuis OpenLibrary ‚Üí Upload vers Cloudinary ‚Üí Mise √† jour de `image` avec l'URL
4. **Gestion auteurs** : "Antoine de Saint-Exup√©ry" n'existe pas ‚Üí Cr√©ation dans Author ‚Üí Cr√©ation relation dans BookAuthor
5. **Retour** : `{book: {...}, message: "Livre import√© avec succ√®s", isNew: true}`

**R√©sultat :**
Pierre a maintenant "Le Petit Prince" dans sa biblioth√®que locale avec couverture optimis√©e sur Cloudinary et auteur cr√©√©.

=== Sc√©nario 3 : Affichage des trending books sur la page d'accueil

**Situation de d√©part :**
Un visiteur arrive sur la page d'accueil et doit voir des suggestions de livres.

**Traitement par le service :**
1. **S√©lection al√©atoire** : `SELECT ... ORDER BY RANDOM() LIMIT 20` depuis la base locale
2. **Jointures auteurs** : LEFT JOIN sur BookAuthor et Author pour r√©cup√©rer les noms d'auteurs
3. **Groupement** : Agr√©gation des auteurs multiples via Map
4. **Retour** : {books: 20 livres avec auteurs, total_books: 20, source: "local-random"}

**R√©sultat :**
La page d'accueil charge en moins de 2 secondes avec 20 suggestions vari√©es (vs 30s avec l'ancien code OpenLibrary).

== Diagramme de s√©quence - Import complet depuis OpenLibrary

[mermaid]
----
sequenceDiagram
    participant Controller
    participant BookService
    participant Database
    participant ImageService
    participant Cloudinary

    Note over Controller, Cloudinary: Workflow: Import d'un livre depuis OpenLibrary

    Controller->>BookService: createFromOpenLibrary(openLibraryData)

    BookService->>Database: SELECT FROM books WHERE openlibrary_key = ?
    Database-->>BookService: [] (aucun doublon)

    BookService->>Database: INSERT INTO books (title, isbn, openlibrary_key, ...)
    Database-->>BookService: newBook avec id_book g√©n√©r√©

    BookService->>ImageService: uploadBookCover(bookId, openLibraryKey)
    ImageService->>Cloudinary: Upload de la couverture
    Cloudinary-->>ImageService: {success: true, url: "https://..."}
    ImageService-->>BookService: uploadResult

    BookService->>Database: UPDATE books SET image = ? WHERE id_book = ?
    Database-->>BookService: OK

    loop Pour chaque auteur
        BookService->>Database: SELECT FROM authors WHERE author_name = ?

        alt Auteur existe
            Database-->>BookService: existingAuthor
        else Auteur n'existe pas
            BookService->>Database: INSERT INTO authors (author_name)
            Database-->>BookService: newAuthor avec id_author g√©n√©r√©
        end

        BookService->>Database: INSERT INTO book_author (id_book, id_author)
        Database-->>BookService: OK
    end

    BookService-->>Controller: {book: {...}, message: "Livre import√© avec succ√®s", isNew: true}
----

== R√©sum√©

Le service bookService est le **syst√®me hybride de gestion de livres** de l'API BlaBlaBook V2. Il g√®re **5 op√©rations principales** avec :

=== Op√©rations de recherche et consultation
- **search()** : Interroge OpenLibrary et enrichit avec statut d'import local (isImported, localId)
- **getById()** : R√©cup√®re un livre depuis la base locale avec validation EntityValidator
- **getAll()** : Liste les livres locaux avec pagination (limite 50 par d√©faut)
- **getTrending()** : S√©lection al√©atoire depuis la base locale pour performance optimale (vs ancien code OpenLibrary 30s)

=== Op√©ration d'importation compl√®te
- **createFromOpenLibrary()** : Import workflow complet incluant :
  - D√©tection de doublons (openlibrary_key + isbn)
  - Cr√©ation du livre dans PostgreSQL
  - Upload couverture sur Cloudinary avec transformation
  - Gestion intelligente des auteurs (cr√©ation ou r√©utilisation)
  - Relations book-author automatiques

=== Points cl√©s d'architecture
- ‚úÖ **Approche hybride** : OpenLibrary pour recherche, base locale pour consultation
- ‚úÖ **Performance optimis√©e** : getTrending utilise uniquement la base locale (RANDOM())
- ‚úÖ **D√©tection de doublons** : Double v√©rification openlibrary_key + isbn
- ‚úÖ **Upload Cloudinary** : Couvertures optimis√©es et servies via CDN
- ‚úÖ **Relations automatiques** : Gestion compl√®te auteurs et book-author lors de l'import
- ‚úÖ **Gestion gracieuse** : Import continue m√™me si upload Cloudinary √©choue

=== Optimisations critiques
- üöÄ **LCP am√©lior√©** : getTrending passe de 30s (OpenLibrary) √† <2s (local)
- üöÄ **Enrichissement search** : Indication `isImported` √©vite les imports doublons
- üöÄ **Cloudinary CDN** : Images optimis√©es et distribu√©es globalement
- üöÄ **R√©utilisation auteurs** : √âvite la duplication dans la table Author

**Il assure la d√©couverte, la consultation, et l'enrichissement progressif du catalogue de livres de la plateforme.**
