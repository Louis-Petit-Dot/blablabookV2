= Service BookGenreService - Analyse Complète
:toc:
:toclevels: 3

== Vue d'ensemble

Le service bookGenreService gère les associations entre livres et genres littéraires dans l'API BlaBlaBook V2. Il s'occupe de la consultation, de l'assignation et de la navigation dans les relations livre-genre, permettant la catégorisation et la découverte de livres par genre.

== Fonctions principales

=== getBookGenres
**Objectif:** Récupérer tous les genres d'un livre spécifique
**Quand:** Utilisé pour afficher les catégories d'un livre sur sa page détaillée
**Pourquoi important:** Permet la catégorisation et aide à la découverte de livres similaires

=== getGenreBooks
**Objectif:** Récupérer tous les livres d'un genre avec pagination
**Quand:** Utilisé pour la navigation par genre et l'exploration de catalogues thématiques
**Pourquoi important:** Facilite la découverte de livres par centre d'intérêt et organise le catalogue

=== assign
**Objectif:** Assigner un genre à un livre
**Quand:** Utilisé lors de la catégorisation ou de l'enrichissement des métadonnées d'un livre
**Pourquoi important:** Enrichit la base de données et améliore les capacités de recherche et recommandation

== Fonctionnement du service bookGenreService

=== Rôle de gestionnaire de catégorisation
Le service bookGenreService fonctionne comme un système de classification littéraire :

1. **Classification bidirectionnelle** : Navigation livre→genres et genre→livres
2. **Assignation contrôlée** : Prévention des doublons dans les associations
3. **Pagination intelligente** : Gestion des grandes collections par genre
4. **Tri alphabétique** : Organisation logique des genres et des livres
5. **Enrichissement des métadonnées** : Calcul automatique des statistiques

=== Intégration avec EntityValidator
Le service s'appuie sur EntityValidator pour :
- **validateBook** : Confirmer l'existence du livre avant opérations
- **validateGenre** : Confirmer l'existence du genre avant opérations
- **Validation automatique** : Intégration transparente dans toutes les opérations

== Opérations détaillées

=== Consultation des genres d'un livre (getBookGenres)

**Fonctionnement en mots simples :**
Cette fonction agit comme un étiquetage qui liste toutes les catégories littéraires d'un livre spécifique.

**Processus de récupération :**
1. **Validation du livre** : Vérification que le livre existe via EntityValidator
2. **Jointure enrichie** : JOIN BookGenre + Genre pour récupérer les données complètes
3. **Tri alphabétique** : Classement par nom de genre (ORDER BY genre_name)
4. **Structuration des données** : Mapping vers format cohérent avec métadonnées d'association

**Données retournées :**
- Informations complètes du livre
- Liste des genres triés alphabétiquement
- Identifiants d'association avec dates de création
- Compteur total de genres pour statistiques

**Tri alphabétique :**
Les genres sont automatiquement classés alphabétiquement pour faciliter la lecture et la navigation.

=== Consultation des livres d'un genre (getGenreBooks)

**Fonctionnement en mots simples :**
Cette fonction agit comme un catalogue thématique qui présente tous les livres d'une catégorie littéraire avec navigation paginée.

**Processus de récupération :**
1. **Calcul de pagination** : Détermination de l'offset basé sur page et limite
2. **Validation du genre** : Vérification que le genre existe via EntityValidator
3. **Jointure enrichie** : JOIN BookGenre + Book pour récupérer les données complètes
4. **Pagination appliquée** : LIMIT et OFFSET pour contrôler les résultats
5. **Comptage total** : Requête séparée pour calculer le nombre total de livres
6. **Métadonnées de pagination** : Calcul des informations de navigation

**Données retournées :**
- Informations complètes du genre
- Liste paginée des livres triés par titre
- Métadonnées de pagination complètes (page actuelle, total pages, etc.)
- Identifiants d'association avec dates

**Système de pagination :**
```
Page 1, Limite 20 → Offset 0, LIMIT 20
Page 2, Limite 20 → Offset 20, LIMIT 20
Page 3, Limite 20 → Offset 40, LIMIT 20
```

**Métadonnées de pagination :**
- current_page : Page actuellement affichée
- total_pages : Nombre total de pages calculé
- total_books : Nombre total de livres dans le genre
- books_per_page : Limite appliquée pour la pagination

=== Assignation genre-livre (assign)

**Fonctionnement en mots simples :**
Cette fonction agit comme un étiqueteur qui associe un livre à une catégorie littéraire après vérification de l'unicité.

**Processus d'assignation :**
1. **Validation des entités** : Vérification que livre et genre existent via EntityValidator
2. **Contrôle de doublon** : Recherche d'association existante avec conditions AND
3. **Prévention des duplicatas** : Rejet si l'association existe déjà
4. **Création de l'association** : Insertion sécurisée avec RETURNING
5. **Enrichissement du retour** : Combinaison association + entités complètes

**Protection contre les doublons :**
Le système empêche l'assignation multiple d'un même genre à un livre, maintenant ainsi la cohérence de la base de données et évitant la redondance.

**Données retournées :**
- Association créée avec son identifiant généré
- Informations complètes du livre associé
- Informations complètes du genre associé

== Validation et contrôles qualité

=== EntityValidator integration
Le service s'appuie sur EntityValidator pour :
- **validateBook** : Confirmer l'existence du livre avant toute opération
- **validateGenre** : Confirmer l'existence du genre avant toute opération
- **Gestion cohérente** : Messages d'erreur standardisés avec les autres services
- **Validation automatique** : Intégration transparente dans toutes les méthodes

=== Contrôles métier spécifiques
Le service applique ses propres règles :
- **Unicité des associations** : Prévention des doublons livre-genre
- **Pagination contrôlée** : Limites par défaut (page=1, limit=20)
- **Tri cohérent** : Alphabétique pour les genres, par titre pour les livres

=== Gestion des associations vides
Le service gère gracieusement les cas où :
- **Livre sans genres** : Retourne une liste vide avec compteur à 0
- **Genre sans livres** : Retourne une liste vide avec pagination correcte
- **Entités valides** : Aucune erreur générée pour les collections légitimement vides

== Gestion des erreurs spécialisées

=== Erreurs de duplication
- **Association déjà existante** : "A book with this genre already exists."
- **Validation préalable** : Vérification avant insertion pour éviter les conflits
- **Message explicite** : Information claire sur la cause du rejet

=== Erreurs de validation
- **Livre inexistant** : Gérée par EntityValidator avec message standardisé
- **Genre inexistant** : Gérée par EntityValidator avec message standardisé
- **Validation précoce** : Échec rapide avant opérations coûteuses

=== Gestion des cas limites
- **Paramètres de pagination** : Valeurs par défaut pour page et limit
- **Calculs de pagination** : Protection contre les divisions par zéro
- **Collections volumineuses** : Pagination obligatoire pour les genres populaires

== Performance et optimisation

=== Requêtes optimisées
- **JOINs efficaces** : Utilisation d'INNER JOIN pour des performances optimales
- **Sélections explicites** : Évitement du SELECT * pour réduire le transfert
- **Pagination native** : LIMIT/OFFSET au niveau base de données
- **Index recommandés** : Sur (id_book, id_genre) et genre_name pour optimiser les requêtes

=== Gestion de la pagination
- **Requête séparée pour le comptage** : Évite COUNT(*) OVER() coûteux
- **Calculs côté service** : total_pages calculé efficacement
- **Paramètres par défaut** : page=1, limit=20 pour éviter les surcharges

=== Optimisation mémoire
- **Mapping efficient** : Transformation directe sans stockage intermédiaire
- **Pagination contrôlée** : Évite le chargement de grandes collections en mémoire
- **Calculs simples** : Compteurs optimisés selon le contexte

== Interaction avec d'autres services

=== Dépendances directes
- **EntityValidator** : Validation de l'existence des entités
- **Database connection** : Opérations CRUD via Drizzle ORM
- **BookGenre model** : Table de jointure pour les associations

=== Services connexes
- **bookService** : Gestion CRUD des livres
- **genreService** : Gestion CRUD des genres
- **authorBookService** : Pattern similaire pour les associations auteur-livre

=== Impact sur d'autres fonctionnalités
- **Recherche par genre** : Base pour les filtres de recherche avancée
- **Recommandations** : Données pour suggérer des livres de genres similaires
- **Navigation thématique** : Organisation du catalogue par centres d'intérêt
- **Statistiques** : Métriques de popularité par genre

== Exemple de flux complet

=== Scénario : Exploration du genre "Science-Fiction" avec pagination

**Situation de départ :**
Un utilisateur clique sur "Science-Fiction" et souhaite explorer les livres disponibles dans cette catégorie.

**Traitement par le service :**
1. **Validation du genre** : Confirme que "Science-Fiction" existe dans la base
2. **Calcul de pagination** : Page 1, limite 20 → offset 0
3. **Récupération paginée** : JOIN BookGenre + Book avec LIMIT 20 OFFSET 0
4. **Comptage total** : Requête séparée pour déterminer le total (ex: 150 livres)
5. **Calcul des métadonnées** : total_pages = ceil(150/20) = 8 pages
6. **Structuration du retour** : Genre + livres paginés + navigation

**Enrichissement automatique :**
Le service retourne automatiquement les métadonnées de pagination permettant à l'interface de proposer la navigation entre les 8 pages de résultats.

**Résultat :**
L'utilisateur obtient les 20 premiers livres de science-fiction avec la possibilité de naviguer vers les pages suivantes, optimisant à la fois l'expérience utilisateur et les performances.

== Diagramme de séquence - Workflow BookGenreService

[mermaid]
----
sequenceDiagram
    participant Controller
    participant BookGenreService
    participant EntityValidator
    participant Database
    participant Models

    Note over Controller, Models: Exemple: Consultation des genres d'un livre

    Controller->>BookGenreService: getBookGenres(bookId)
    BookGenreService->>EntityValidator: validateBook(bookId)
    EntityValidator->>Database: SELECT FROM books WHERE id_book = ?
    Database-->>EntityValidator: bookData || null

    alt Si livre inexistant
        EntityValidator-->>BookGenreService: throw Error("Book not found")
    else Livre trouvé
        EntityValidator-->>BookGenreService: bookData
        BookGenreService->>Database: JOIN BookGenre + Genre WHERE id_book = bookId ORDER BY genre_name
        Database-->>BookGenreService: genreAssociations[]
        BookGenreService->>BookGenreService: Map to structured format
        BookGenreService-->>Controller: {book, genres[], total_genres}
    end

    Note over Controller, Models: Exemple: Consultation paginée des livres d'un genre

    Controller->>BookGenreService: getGenreBooks(genreId, page=2, limit=20)
    BookGenreService->>BookGenreService: Calculate offset = (2-1) * 20 = 20
    BookGenreService->>EntityValidator: validateGenre(genreId)
    EntityValidator->>Database: SELECT FROM genres WHERE id_genre = ?
    Database-->>EntityValidator: genreData || null

    alt Si genre inexistant
        EntityValidator-->>BookGenreService: throw Error("Genre not found")
    else Genre trouvé
        EntityValidator-->>BookGenreService: genreData

        par Récupération des livres
            BookGenreService->>Database: JOIN BookGenre + Book WHERE id_genre = genreId ORDER BY title LIMIT 20 OFFSET 20
            Database-->>BookGenreService: bookAssociations[]
        and Comptage total
            BookGenreService->>Database: SELECT COUNT(*) FROM BookGenre WHERE id_genre = genreId
            Database-->>BookGenreService: {count: 150}
        end

        BookGenreService->>BookGenreService: Calculate pagination: current_page=2, total_pages=8
        BookGenreService->>BookGenreService: Map to structured format
        BookGenreService-->>Controller: {genre, books[], pagination{...}}
    end

    Note over Controller, Models: Exemple: Assignation d'un genre à un livre

    Controller->>BookGenreService: assign({id_book, id_genre, user_id})
    BookGenreService->>EntityValidator: validateBook(id_book)
    EntityValidator-->>BookGenreService: bookData
    BookGenreService->>EntityValidator: validateGenre(id_genre)
    EntityValidator-->>BookGenreService: genreData

    BookGenreService->>Database: SELECT FROM BookGenre WHERE id_book = ? AND id_genre = ?
    Database-->>BookGenreService: existingAssociation

    alt Si association existe
        BookGenreService-->>Controller: throw Error("A book with this genre already exists.")
    else Association unique
        BookGenreService->>Database: INSERT INTO BookGenre VALUES({id_book, id_genre}) RETURNING
        Database-->>BookGenreService: newBookGenre
        BookGenreService-->>Controller: {book_genre: newBookGenre, book, genre}
    end
----

== Résumé

Le service bookGenreService est le **gestionnaire d'associations livre-genre** de l'API BlaBlaBook V2. Il gère **3 opérations principales** avec :
- **Classification bidirectionnelle** : Navigation livre→genres et genre→livres
- **Pagination intelligente** : Gestion optimisée des grandes collections thématiques
- **Assignation contrôlée** : Prévention des doublons avec validation préalable
- **Tri alphabétique** : Organisation logique des genres et par titre pour les livres
- **EntityValidator** : Validation cohérente avec le reste du système
- **Métadonnées enrichies** : Compteurs totaux et informations de pagination complètes

**Il assure la catégorisation et la découverte thématique efficace du catalogue de livres.**