= Service AuthorBookService - Analyse Complète
:toc:
:toclevels: 3

== Vue d'ensemble

Le service authorBookService gère les relations bidirectionnelles entre auteurs et livres dans l'API BlaBlaBook V2. Il s'occupe de la consultation et de la navigation dans les associations auteur-livre, permettant de découvrir tous les livres d'un auteur ou tous les auteurs d'un livre.

== Fonctions principales

=== getBookAuthors
**Objectif:** Récupérer tous les auteurs d'un livre spécifique
**Quand:** Utilisé pour afficher les informations d'auteurs sur une page de livre
**Pourquoi important:** Permet d'identifier les créateurs d'une œuvre et de naviguer vers leurs profils

=== getAuthorBooks
**Objectif:** Récupérer tous les livres d'un auteur spécifique
**Quand:** Utilisé pour afficher la bibliographie complète d'un auteur
**Pourquoi important:** Facilite la découverte d'œuvres par auteur et l'exploration littéraire

== Fonctionnement du service authorBookService

=== Rôle de gestionnaire d'associations
Le service authorBookService fonctionne comme un index croisé de références :

1. **Navigation bidirectionnelle** : Il permet la navigation dans les deux sens (auteur→livres, livre→auteurs)
2. **Enrichissement des données** : Il joint les informations complètes des entités liées
3. **Tri intelligent** : Il organise les livres par année de publication pour un affichage chronologique
4. **Métadonnées calculées** : Il fournit automatiquement les compteurs totaux

=== Intégration avec EntityValidator
Le service s'appuie sur EntityValidator pour :
- **validateBook** : Confirmer l'existence du livre demandé
- **validateAuthor** : Confirmer l'existence de l'auteur demandé
- **Validation automatique** : Intégration transparente avant récupération des associations

== Opérations détaillées

=== Consultation des auteurs d'un livre (getBookAuthors)

**Fonctionnement en mots simples :**
Cette fonction agit comme un annuaire qui liste tous les créateurs d'une œuvre littéraire spécifique.

**Processus de récupération :**
1. **Validation du livre** : Vérification que le livre existe via EntityValidator
2. **Jointure enrichie** : JOIN BookAuthor + Author pour récupérer les données complètes
3. **Sélection structurée** : Récupération des informations d'association et d'auteur
4. **Transformation des données** : Mapping vers une structure cohérente avec métadonnées

**Données retournées :**
- Informations complètes du livre
- Liste des auteurs avec leurs associations
- Compteur total d'auteurs pour statistiques
- Identifiant de l'association pour traçabilité

=== Consultation des livres d'un auteur (getAuthorBooks)

**Fonctionnement en mots simples :**
Cette fonction agit comme une bibliographie personnalisée qui présente toute la production littéraire d'un auteur.

**Processus de récupération :**
1. **Validation de l'auteur** : Vérification que l'auteur existe via EntityValidator
2. **Jointure enrichie** : JOIN BookAuthor + Book pour récupérer les données complètes
3. **Tri chronologique** : Classement par année de publication (orderBy publication_year)
4. **Transformation des données** : Mapping vers une structure cohérente avec métadonnées

**Données retournées :**
- Informations complètes de l'auteur
- Liste des livres triés chronologiquement
- Compteur total de livres pour statistiques
- Identifiant de l'association pour traçabilité

**Tri chronologique :**
Les livres sont automatiquement classés par année de publication, permettant de suivre l'évolution littéraire de l'auteur dans le temps.

== Validation et contrôles qualité

=== EntityValidator integration
Le service s'appuie sur EntityValidator pour :
- **validateBook** : Confirmer l'existence du livre avant récupération des auteurs
- **validateAuthor** : Confirmer l'existence de l'auteur avant récupération des livres
- **Gestion cohérente** : Messages d'erreur standardisés avec les autres services
- **Validation automatique** : Intégration transparente dans les opérations

=== Gestion des associations vides
Le service gère gracieusement les cas où :
- **Livre sans auteurs** : Retourne une liste vide avec compteur à 0
- **Auteur sans livres** : Retourne une liste vide avec compteur à 0
- **Entités valides** : Aucune erreur générée pour les associations légitimement vides

== Gestion des erreurs spécialisées

=== Erreurs de validation
- **Livre inexistant** : Gérée par EntityValidator avec message standardisé
- **Auteur inexistant** : Gérée par EntityValidator avec message standardisé
- **Validation préalable** : Échec rapide avant opérations coûteuses

=== Gestion des cas limites
- **Associations multiples** : Support correct des livres multi-auteurs
- **Auteurs prolifiques** : Pas de limitation sur le nombre de livres retournés
- **Données manquantes** : Gestion gracieuse des champs optionnels

== Performance et optimisation

=== Requêtes optimisées
- **JOINs efficaces** : Utilisation d'INNER JOIN pour des performances optimales
- **Sélections explicites** : Évitement du SELECT * pour réduire le transfert de données
- **Limitation automatique** : Aucune pagination nécessaire pour ces associations
- **Index recommandés** : Sur (id_book, id_author) pour optimiser les jointures

=== Optimisation mémoire
- **Mapping efficient** : Transformation directe sans stockage intermédiaire
- **Pas de duplication** : Structure de données optimisée
- **Calculs simples** : Compteurs via .length pour éviter les requêtes supplémentaires

=== Tri intelligent
- **Tri par publication_year** : Optimisé au niveau base de données (ORDER BY)
- **Tri par genre_name** : Dans getBookGenres pour un affichage alphabétique
- **Performance** : Tri côté base pour éviter le tri en mémoire

== Interaction avec d'autres services

=== Dépendances directes
- **EntityValidator** : Validation de l'existence des entités
- **Database connection** : Opérations de lecture via Drizzle ORM
- **BookAuthor model** : Table de jointure pour les associations

=== Services connexes
- **authorService** : Gestion CRUD des auteurs
- **bookService** : Gestion CRUD des livres
- **bookGenreService** : Pattern similaire pour les associations livre-genre

=== Impact sur d'autres fonctionnalités
- **Pages détaillées** : Alimentation des vues détaillées auteur/livre
- **Recherche** : Base pour la recherche par auteur ou par livre
- **Recommandations** : Données pour suggérer d'autres livres du même auteur

== Exemple de flux complet

=== Scénario : Consultation de la bibliographie d'un auteur populaire

**Situation de départ :**
Un utilisateur clique sur "Stephen King" et souhaite voir tous ses livres disponibles dans la base de données.

**Traitement par le service :**
1. **Validation de l'auteur** : Confirme que Stephen King existe dans la base
2. **Récupération des associations** : Recherche toutes les entrées BookAuthor pour cet auteur
3. **Enrichissement des données** : Joint les informations complètes de chaque livre associé
4. **Tri chronologique** : Classe les livres par année de publication (1974→2024)
5. **Structuration du retour** : Combine auteur, livres triés et métadonnées

**Enrichissement automatique :**
Le service retourne automatiquement la progression chronologique de l'auteur, de "Carrie" (1974) aux œuvres les plus récentes.

**Résultat :**
L'utilisateur obtient une bibliographie complète et chronologique, facilitant la découverte et l'exploration de l'œuvre de l'auteur.

== Diagramme de séquence - Workflow AuthorBookService

[mermaid]
----
sequenceDiagram
    participant Controller
    participant AuthorBookService
    participant EntityValidator
    participant Database
    participant Models

    Note over Controller, Models: Exemple: Consultation des auteurs d'un livre

    Controller->>AuthorBookService: getBookAuthors(bookId)
    AuthorBookService->>EntityValidator: validateBook(bookId)
    EntityValidator->>Database: SELECT FROM books WHERE id_book = ?
    Database-->>EntityValidator: bookData || null

    alt Si livre inexistant
        EntityValidator-->>AuthorBookService: throw Error("Book not found")
    else Livre trouvé
        EntityValidator-->>AuthorBookService: bookData
        AuthorBookService->>Database: JOIN BookAuthor + Author WHERE id_book = bookId
        Database-->>AuthorBookService: authorAssociations[]
        AuthorBookService->>AuthorBookService: Map to structured format
        AuthorBookService-->>Controller: {book, authors[], total_authors}
    end

    Note over Controller, Models: Exemple: Consultation des livres d'un auteur

    Controller->>AuthorBookService: getAuthorBooks(authorId)
    AuthorBookService->>EntityValidator: validateAuthor(authorId)
    EntityValidator->>Database: SELECT FROM authors WHERE id_author = ?
    Database-->>EntityValidator: authorData || null

    alt Si auteur inexistant
        EntityValidator-->>AuthorBookService: throw Error("Author not found")
    else Auteur trouvé
        EntityValidator-->>AuthorBookService: authorData
        AuthorBookService->>Database: JOIN BookAuthor + Book WHERE id_author = authorId ORDER BY publication_year
        Database-->>AuthorBookService: bookAssociations[]
        AuthorBookService->>AuthorBookService: Map to structured format with chronological order
        AuthorBookService-->>Controller: {author, books[], total_books}
    end
----

== Résumé

Le service authorBookService est le **gestionnaire d'associations auteur-livre** de l'API BlaBlaBook V2. Il gère **2 opérations principales** avec :
- **Navigation bidirectionnelle** : Consultation auteur→livres et livre→auteurs
- **Enrichissement des données** : Jointures complètes avec informations détaillées
- **Tri intelligent** : Classement chronologique des livres par année de publication
- **EntityValidator** : Validation cohérente avec le reste du système
- **Métadonnées automatiques** : Compteurs totaux et identifiants d'association
- **Performance optimisée** : JOINs efficaces et sélections ciblées

**Il assure la navigation fluide et enrichie entre auteurs et livres de la plateforme.**