= Service ImageService (Cloudinary) - Analyse Complète
:toc:
:toclevels: 3

== Vue d'ensemble

Le service imageService gère l'upload et la suppression de couvertures de livres sur Cloudinary CDN. Il s'occupe de récupérer les meilleures couvertures depuis OpenLibrary et de les optimiser automatiquement via les transformations Cloudinary.

IMPORTANT: Ce service est ultra-simplifié avec seulement **2 méthodes** : upload et suppression de couvertures. Il utilise languageService pour sélectionner automatiquement les meilleures couvertures françaises.

== Fonctions principales

=== uploadBookCover
**Objectif:** Uploader une couverture de livre optimisée sur Cloudinary CDN
**Quand:** Utilisé lors de l'import d'un livre depuis OpenLibrary
**Pourquoi important:** Garantit la disponibilité et la performance des couvertures avec optimisation WebP automatique

=== deleteBookCover
**Objectif:** Supprimer une couverture de livre du CDN
**Quand:** Utilisé lors de la suppression d'un livre
**Pourquoi important:** Maintient la propreté du CDN et évite les fichiers orphelins

== Fonctionnement du service imageService

=== Rôle de gestionnaire de médias CDN
Le service imageService fonctionne comme un pont entre OpenLibrary et Cloudinary :

1. **Recherche intelligente** : Utilise languageService pour trouver la meilleure couverture française
2. **Upload optimisé** : Conversion automatique en WebP avec qualité maximale
3. **Nomenclature cohérente** : public_id basé sur l'UUID du livre
4. **Gestion d'erreurs** : Retour structuré avec success/error pour tolérance aux pannes
5. **Overwrite automatique** : Remplacement des anciennes couvertures sans duplication

=== Configuration Cloudinary

Le service utilise un système de configuration flexible avec support de noms legacy :

```typescript
ensureConfig() {
    const cloudName = Deno.env.get("CLOUDINARY_CLOUD_NAME")
        || Deno.env.get("CLOUD_NAME")
        || Deno.env.get("CLOUDINARY_CLOUD")
        || Deno.env.get("CLOUD");

    const apiKey = Deno.env.get("CLOUDINARY_API_KEY")
        || Deno.env.get("CLOUD_API_KEY")
        || Deno.env.get("CLOUDINARY_KEY");

    const apiSecret = Deno.env.get("CLOUDINARY_API_SECRET")
        || Deno.env.get("CLOUD_API_SECRET")
        || Deno.env.get("CLOUDINARY_SECRET");

    // Validation avant configuration
    if (!cloudName || !apiKey || !apiSecret) {
        throw new Error('Cloudinary configuration incomplete');
    }

    cloudinary.config({ cloud_name, api_key, api_secret });
}
```

**Variables d'environnement supportées :**
- `CLOUDINARY_CLOUD_NAME` ou `CLOUD_NAME` ou `CLOUDINARY_CLOUD` ou `CLOUD`
- `CLOUDINARY_API_KEY` ou `CLOUD_API_KEY` ou `CLOUDINARY_KEY`
- `CLOUDINARY_API_SECRET` ou `CLOUD_API_SECRET` ou `CLOUDINARY_SECRET`

== Opérations détaillées

=== Upload de couverture (uploadBookCover)

**Fonctionnement en mots simples :**
Cette fonction récupère la meilleure couverture française d'un livre et l'upload sur Cloudinary avec optimisation automatique.

**Processus d'upload :**
1. **Configuration Cloudinary** : Vérification et chargement des credentials
2. **Recherche couverture optimale** : Appel à languageService.findBestCover(workKey)
3. **Validation existence** : Retour erreur si aucune couverture trouvée
4. **Upload direct Cloudinary** : URL OpenLibrary → Cloudinary CDN
5. **Optimisations automatiques** : Conversion WebP + compression intelligente
6. **Retour structuré** : {success, url} ou {success, error}

**Code complet :**
```typescript
async uploadBookCover(bookId: string, workKey: string): Promise<UploadResult> {
    try {
        ensureConfig();

        // 1. Trouver la meilleure couverture française
        const coverId = await languageService.findBestCover(workKey);

        if (!coverId) {
            return { success: false, error: "Aucune couverture trouvée" };
        }

        // 2. Upload direct vers Cloudinary
        const result = await cloudinary.uploader.upload(
            `https://covers.openlibrary.org/b/id/${coverId}-L.jpg`,
            {
                public_id: `book-${bookId.replace(/[^a-zA-Z0-9]/g, '-')}`,
                folder: "book-covers",
                format: "webp",
                quality: "auto:best",
                overwrite: true
            }
        );

        return { success: true, url: result.secure_url };

    } catch (error) {
        console.error('imageService.uploadBookCover error:', error);
        return {
            success: false,
            error: error instanceof Error ? error.message : "Erreur inconnue"
        };
    }
}
```

**Paramètres upload Cloudinary :**
- **public_id** : `book-{bookId}` avec caractères spéciaux remplacés par `-`
- **folder** : `book-covers` pour organisation dans Cloudinary
- **format** : `webp` pour taille optimale avec qualité maximale
- **quality** : `auto:best` pour compression intelligente
- **overwrite** : `true` pour remplacement automatique en cas de ré-upload

**Gestion des erreurs :**
- Couverture introuvable : `{success: false, error: "Aucune couverture trouvée"}`
- Erreur upload : `{success: false, error: message}`
- Console.error pour debugging des échecs d'upload

=== Suppression de couverture (deleteBookCover)

**Fonctionnement en mots simples :**
Cette fonction supprime une couverture de livre du CDN Cloudinary en utilisant son public_id.

**Processus de suppression :**
1. **Configuration Cloudinary** : Vérification des credentials
2. **Construction public_id** : Même format que lors de l'upload
3. **Suppression Cloudinary** : Appel cloudinary.uploader.destroy()
4. **Retour booléen** : true si succès, false sinon

**Code complet :**
```typescript
async deleteBookCover(bookId: string): Promise<boolean> {
    try {
        ensureConfig();
        await cloudinary.uploader.destroy(
            `book-covers/book-${bookId.replace(/[^a-zA-Z0-9]/g, '-')}`
        );
        return true;
    } catch {
        return false;
    }
}
```

**Nomenclature public_id :**
- Format : `book-covers/book-{bookId}`
- Exemple : `book-covers/book-550e8400-e29b-41d4-a716-446655440000`
- Cohérence avec uploadBookCover() pour garantir la correspondance

**Gestion des erreurs :**
- Toutes les erreurs retournent `false` (tolérance aux pannes)
- Pas de throw pour éviter de bloquer les opérations de suppression
- La suppression d'une couverture inexistante est considérée comme un succès silencieux

== Intégration avec languageService

Le service imageService délègue la sélection de couverture à languageService :

**Workflow intégré :**
```typescript
// 1. imageService demande la meilleure couverture
const coverId = await languageService.findBestCover(workKey);

// 2. languageService interroge OpenLibrary pour les éditions
// 3. languageService filtre les éditions françaises
// 4. languageService retourne le cover_id de la meilleure édition
// 5. imageService utilise ce cover_id pour l'upload Cloudinary
```

**Avantages de cette séparation :**
- **Responsabilités claires** : imageService = CDN, languageService = sélection
- **Réutilisabilité** : languageService peut être utilisé ailleurs
- **Testabilité** : Les deux services peuvent être testés indépendamment
- **Optimisation française** : Garantit des couvertures pertinentes pour le public français

== Type UploadResult

```typescript
export interface UploadResult {
    success: boolean;
    url?: string;
    error?: string;
}
```

**Structure de retour :**
- **success** : `true` si upload réussi, `false` sinon
- **url** : URL HTTPS de la couverture sur Cloudinary (si success = true)
- **error** : Message d'erreur descriptif (si success = false)

**Exemples de retours :**
```typescript
// Succès
{
    success: true,
    url: "https://res.cloudinary.com/xyz/image/upload/book-covers/book-123.webp"
}

// Aucune couverture trouvée
{
    success: false,
    error: "Aucune couverture trouvée"
}

// Erreur upload
{
    success: false,
    error: "Network timeout"
}
```

== Performance et optimisation

=== Optimisations Cloudinary

**Transformations automatiques :**
- **format: webp** : Réduction ~30% de la taille vs JPEG
- **quality: auto:best** : Compression intelligente sans perte visible
- **URL HTTPS** : Sécurité et performance avec HTTP/2
- **CDN global** : Latence minimale via edge locations

**Comparaison tailles :**
```
JPEG original (OpenLibrary) : ~500KB
WebP auto:best (Cloudinary) : ~150KB
→ Gain de 70% de bande passante
```

=== Stratégie de nomenclature

**Format public_id :**
```typescript
`book-${bookId.replace(/[^a-zA-Z0-9]/g, '-')}`
```

**Avantages :**
- **UUID safe** : Retire les tirets d'UUID qui poseraient problème
- **Cohérence** : Même format upload/delete pour éviter les orphelins
- **Organisation** : Folder `book-covers` pour tri dans Cloudinary
- **Overwrite** : Remplacement automatique sans duplication

=== Gestion d'erreurs résiliente

Le service est conçu pour la tolérance aux pannes :

**Principes de résilience :**
- **Pas de throw dans delete** : Échecs silencieux pour ne pas bloquer
- **Retour structuré** : `{success, url/error}` pour gestion explicite
- **Console.error** : Debugging sans casser le flux
- **Validation config** : Échec rapide si credentials manquants

== Gestion des erreurs spécialisées

=== Erreurs de configuration

**Configuration incomplète :**
```typescript
throw new Error(
    `Cloudinary configuration incomplete: cloudName=${!!cloudName}, apiKey=${!!apiKey}, apiSecret=${!!apiSecret}`
);
```

**Debug helper :**
```typescript
console.debug('Cloudinary config:', {
    cloudName: cloudName || null,
    apiKeyPresent: !!apiKey,
    apiSecretPresent: !!apiSecret
});
```

=== Erreurs d'upload

- **Couverture introuvable** : `{success: false, error: "Aucune couverture trouvée"}`
- **Timeout réseau** : `{success: false, error: "Network timeout"}`
- **Quota Cloudinary dépassé** : `{success: false, error: message Cloudinary}`

=== Erreurs de suppression

- **Toutes les erreurs** : Retournent `false`
- **Pas de distinction** : La suppression est best-effort
- **Idempotence** : Supprimer une couverture déjà supprimée retourne `false`

== Interaction avec d'autres services

=== Dépendances directes

- **languageService** : Sélection de la meilleure couverture française
- **Cloudinary SDK** : Upload et suppression via API v2
- **OpenLibrary** : Source des images originales (covers.openlibrary.org)

=== Utilisé par

- **bookService.createFromOpenLibrary()** : Upload de couverture lors de l'import
- **bookController.deleteBook()** : Suppression de couverture lors de la suppression du livre
- **Potentiel futur** : Mise à jour de couverture, images multiples

== Exemple de flux complet

=== Scénario : Import d'un livre avec couverture optimisée

**Situation de départ :**
Un utilisateur importe "1984" de George Orwell depuis OpenLibrary avec workKey `/works/OL1168083W`.

**Traitement par le service :**
1. **Appel uploadBookCover** :
   - bookId : `550e8400-e29b-41d4-a716-446655440000`
   - workKey : `/works/OL1168083W`

2. **Recherche couverture française** :
   - languageService.findBestCover() interroge OpenLibrary
   - Filtre éditions françaises
   - Retourne coverId : `8231607`

3. **Upload optimisé Cloudinary** :
   - Source : `https://covers.openlibrary.org/b/id/8231607-L.jpg`
   - Destination : `book-covers/book-550e8400-e29b-41d4-a716-446655440000.webp`
   - Transformations : WebP + auto:best

4. **Retour du service** :
   ```typescript
   {
       success: true,
       url: "https://res.cloudinary.com/blablabook/image/upload/book-covers/book-550e8400-e29b-41d4-a716-446655440000.webp"
   }
   ```

**Résultat :**
L'utilisateur obtient une couverture française optimisée (WebP) servie depuis le CDN global avec latence minimale.

== Diagramme de séquence - Workflow ImageService

[mermaid]
----
sequenceDiagram
    participant BookService
    participant ImageService
    participant LanguageService
    participant OpenLibrary
    participant Cloudinary

    Note over BookService, Cloudinary: Exemple: Upload de couverture lors d'import

    BookService->>ImageService: uploadBookCover(bookId, workKey)
    ImageService->>ImageService: ensureConfig() - Vérifier credentials

    ImageService->>LanguageService: findBestCover(workKey)
    LanguageService->>OpenLibrary: GET /works/{workKey}/editions.json
    OpenLibrary-->>LanguageService: Éditions avec languages + covers
    LanguageService->>LanguageService: Filtrer éditions françaises
    LanguageService-->>ImageService: coverId (ex: 8231607)

    alt Aucune couverture trouvée
        ImageService-->>BookService: {success: false, error: "Aucune couverture trouvée"}
    else Couverture trouvée
        ImageService->>Cloudinary: upload(https://covers.openlibrary.org/b/id/{coverId}-L.jpg)
        Note over Cloudinary: Transformations: WebP + auto:best
        Cloudinary-->>ImageService: {secure_url: "https://...webp"}
        ImageService-->>BookService: {success: true, url: "https://...webp"}
    end

    Note over BookService, Cloudinary: Exemple: Suppression de couverture

    BookService->>ImageService: deleteBookCover(bookId)
    ImageService->>ImageService: ensureConfig() - Vérifier credentials
    ImageService->>Cloudinary: destroy(book-covers/book-{bookId})

    alt Suppression réussie
        Cloudinary-->>ImageService: OK
        ImageService-->>BookService: true
    else Erreur suppression
        Cloudinary-->>ImageService: Error
        ImageService-->>BookService: false
    end
----

== Résumé

Le service imageService est le **gestionnaire de couvertures optimisées** de l'API BlaBlaBook V2. Il gère **2 opérations** avec :

- **Upload intelligent** : Sélection automatique de la meilleure couverture française via languageService
- **Optimisation WebP** : Conversion automatique avec compression intelligente (gain 70%)
- **CDN global** : Cloudinary pour latence minimale et disponibilité maximale
- **Nomenclature cohérente** : public_id basé sur UUID pour garantir la correspondance upload/delete
- **Configuration flexible** : Support de multiples noms de variables d'environnement
- **Tolérance aux pannes** : Retours structurés {success, url/error} sans throw agressif
- **Overwrite automatique** : Remplacement des anciennes couvertures sans duplication

**Points clés d'optimisation :**
- ✅ Format WebP avec `quality: auto:best` pour taille optimale
- ✅ Upload direct URL → CDN sans téléchargement local
- ✅ Folder `book-covers` pour organisation Cloudinary
- ✅ Validation config avant toute opération
- ✅ Delete silencieux pour ne pas bloquer les suppressions
- ✅ Intégration languageService pour couvertures françaises

**Il assure la disponibilité et la performance des couvertures de livres avec optimisation automatique.**
