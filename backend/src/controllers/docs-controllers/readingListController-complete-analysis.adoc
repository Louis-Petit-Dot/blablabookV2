= Controller ReadingListController - Analyse Complète
:toc:
:toclevels: 3

== Vue d'ensemble

Le controller readingListController constitue la couche de présentation pour la gestion des listes de lecture dans l'API BlaBlaBook V2. Il expose des endpoints HTTP RESTful pour consulter, créer, modifier et supprimer des listes de lecture avec un système de permissions sophistiqué et protection des données sensibles.

== Architecture du controller

=== Design pattern d'authentification systématique
- **Middleware d'authentification** : Utilisation de `c.get('user')` sur tous les endpoints
- **Système de permissions** : Gestion fine des accès publics/privés
- **Protection des données sensibles** : Suppression des champs critiques lors des modifications
- **Navigation utilisateur** : Consultation des listes d'autres utilisateurs
- **CRUD complet** : Opérations complètes avec sécurité intégrée

=== Rôle dans l'écosystème des listes personnelles
Le controller readingListController permet la gestion complète des collections de lecture :

1. **Consultation sécurisée** : Accès aux listes selon les permissions
2. **Gestion personnelle** : CRUD complet pour ses propres listes
3. **Navigation sociale** : Découverte des listes publiques d'autres utilisateurs
4. **Protection système** : Préservation des listes critiques
5. **Contrôle granulaire** : Permissions au niveau liste et opération

== Endpoints disponibles

=== GET /reading-lists - getAccessibleLists()
**Objectif:** Récupérer toutes les listes accessibles à l'utilisateur
**Méthode HTTP:** GET
**Authentification:** Middleware requis

**Code avec authentification :**
```typescript
async getAccessibleLists(c: Context) {
    const currentUser = c.get('user');
    const readingLists = await readingListService.getAccessibleLists(currentUser.id);
    return c.json(readingLists);
}
```

**Logique d'accès :**
- **Listes personnelles** : Toutes les listes de l'utilisateur (publiques + privées)
- **Listes publiques** : Listes publiques des autres utilisateurs
- **Filtrage automatique** : Exclusion des listes privées d'autrui
- **Performance optimisée** : Requête unique avec jointures optimisées

=== GET /users/:id/reading-lists - getUserLists()
**Objectif:** Récupérer les listes d'un utilisateur spécifique
**Méthode HTTP:** GET
**Authentification:** Middleware requis
**Paramètres:** `id` (UUID de l'utilisateur cible)

**Code avec contrôle d'accès :**
```typescript
async getUserLists(c: Context) {
    const targetUserId = c.req.param('id');
    const currentUser = c.get('user');

    const result = await readingListService.getUserLists(targetUserId, currentUser.id);
    return c.json(result);
}
```

**Logique de visibilité :**
- **Propriétaire** : Accès à toutes ses listes (publiques + privées)
- **Autres utilisateurs** : Accès aux listes publiques uniquement
- **Contrôle service** : Filtrage des permissions géré par readingListService
- **Navigation sociale** : Découverte des collections d'autres lecteurs

=== GET /reading-lists/:id - getById()
**Objectif:** Récupérer une liste de lecture spécifique
**Méthode HTTP:** GET
**Authentification:** Middleware requis
**Paramètres:** `id` (UUID de la liste)

**Code avec validation d'accès :**
```typescript
async getById(c: Context) {
    const listId = c.req.param('id');
    const currentUser = c.get('user');

    const readingList = await readingListService.getListById(listId, currentUser.id);
    return c.json(readingList);
}
```

**Validation d'accès :**
- **Liste privée** : Accès restreint au propriétaire
- **Liste publique** : Accès pour tous les utilisateurs authentifiés
- **Données enrichies** : Informations complètes de la liste avec livres
- **Gestion 404** : Erreur si liste inexistante ou accès refusé

=== POST /reading-lists - create()
**Objectif:** Créer une nouvelle liste de lecture
**Méthode HTTP:** POST
**Authentification:** Middleware requis
**Body JSON requis:**
```json
{
  "list_name": "string (obligatoire)",
  "description": "string (optionnel)",
  "is_public": "boolean (optionnel)"
}
```

**Code avec validation et injection :**
```typescript
async create(c: Context) {
    const listData = await c.req.json();
    const currentUser = c.get('user');

    if (!listData.list_name) {
        throw new Error('list_name is required.');
    }

    const result = await readingListService.create({
        ...listData,
        id_user: currentUser.id
    });
    return c.json(result, 201);
}
```

**Validations appliquées :**
- **list_name obligatoire** : Seul champ critique validé côté controller
- **Injection utilisateur** : id_user automatiquement ajouté
- **Propriété automatique** : Liste assignée au créateur
- **Code 201** : Création réussie avec données complètes

=== PUT /reading-lists/:id - update()
**Objectif:** Modifier une liste de lecture
**Méthode HTTP:** PUT
**Authentification:** Middleware requis
**Paramètres:** `id` (UUID de la liste)

**Code avec protection des champs sensibles :**
```typescript
async update(c: Context) {
    const listId = c.req.param('id');
    const listData = await c.req.json();
    const currentUser = c.get('user');

    const updateData = { ...listData };
    delete updateData.id_user;
    delete updateData.is_system;

    const result = await readingListService.update(listId, updateData, currentUser.id);
    return c.json(result);
}
```

**Protections appliquées :**
- **id_user supprimé** : Pas de changement de propriétaire
- **is_system supprimé** : Protection des listes système
- **Contrôle propriétaire** : Seul le propriétaire peut modifier
- **Données filtrées** : Champs sensibles exclus avant transmission

=== DELETE /reading-lists/:id - delete()
**Objectif:** Supprimer une liste de lecture
**Méthode HTTP:** DELETE
**Authentification:** Middleware requis
**Paramètres:** `id` (UUID de la liste)

**Code avec message enrichi :**
```typescript
async delete(c: Context) {
    const listId = c.req.param('id');
    const currentUser = c.get('user');

    const result = await readingListService.delete(listId, currentUser.id);
    return c.json({
        message: 'Reading list deleted successfully.',
        reading_list: result
    });
}
```

**Sécurité de suppression :**
- **Propriété requise** : Seul le propriétaire peut supprimer
- **Protection système** : Listes système non supprimables
- **Soft delete** : Suppression logique pour intégrité
- **Confirmation** : Liste supprimée retournée pour vérification

== Patterns de conception

=== Authentification middleware systématique
```typescript
// Pattern uniforme sur tous les endpoints
const currentUser = c.get('user');
```

**Bénéfices :**
- **Sécurité garantie** : Aucun endpoint accessible sans authentification
- **Code simplifié** : Pas de validation manuelle de tokens
- **Traçabilité** : user_id disponible pour toutes les opérations
- **Cohérence** : Même pattern sur toute l'API

=== Protection des données sensibles
```typescript
// Suppression des champs critiques lors des modifications
const updateData = { ...listData };
delete updateData.id_user;    // Pas de changement de propriétaire
delete updateData.is_system;  // Pas de modification du flag système
```

**Champs protégés :**
- **id_user** : Propriété immutable après création
- **is_system** : Flag système non modifiable par utilisateurs
- **created_at** : Horodatage de création préservé
- **id** : Identifiant unique non modifiable

=== Validation minimale ciblée
```typescript
// Seul le champ business-critical est validé
if (!listData.list_name) {
    throw new Error('list_name is required.');
}
```

**Stratégie de validation :**
- **Controller** : Champs obligatoires uniquement
- **Service** : Règles métier et contraintes
- **Database** : Intégrité et contraintes techniques
- **Performance** : Validation légère côté controller

=== Injection automatique d'identité
```typescript
// Injection transparente de l'utilisateur propriétaire
const result = await readingListService.create({
    ...listData,
    id_user: currentUser.id
});
```

**Avantages :**
- **Sécurité** : Impossible d'usurper la propriété
- **Simplicité UX** : Client n'a pas à fournir user_id
- **Audit** : Traçabilité automatique des créations
- **Cohérence** : Même pattern sur tous les controllers

== Sécurité et contrôle d'accès

=== Système de permissions sophistiqué
**Consultation :**
- **Listes publiques** : Accès lecture pour tous
- **Listes privées** : Accès restreint au propriétaire
- **Navigation utilisateur** : Découverte des profils publics

**Modification :**
- **Propriétaire uniquement** : Seul le créateur peut modifier/supprimer
- **Champs protégés** : id_user et is_system non modifiables
- **Listes système** : Protection absolue contre suppression

=== Contrôle granulaire par le service
- **Niveau controller** : Authentification et validation basique
- **Niveau service** : Règles métier et permissions détaillées
- **Niveau database** : Contraintes d'intégrité et foreign keys
- **Middleware** : Authentification JWT et validation tokens

=== Audit trail complet
- **user_id systématique** : Traçabilité de toutes les opérations
- **Horodatage automatique** : created_at, updated_at
- **Données complètes** : Retour des entités pour vérification
- **Logs d'accès** : Historique des consultations

== Gestion d'erreurs

=== Stratégie d'erreurs par endpoint
**Consultation :** 403 si accès refusé, 404 si liste inexistante
**Création :** 400 si list_name manquant, 409 si nom déjà utilisé
**Modification :** 403 si pas propriétaire, 400 si données invalides
**Suppression :** 403 si pas propriétaire, 400 si liste système

=== Codes de réponse
- **200** : Consultation, modification réussie
- **201** : Liste créée avec succès
- **400** : Données manquantes ou invalides
- **401** : Authentification requise
- **403** : Accès refusé (permissions insuffisantes)
- **404** : Liste non trouvée
- **409** : Conflit métier (nom déjà utilisé)

=== Messages d'erreur spécialisés
```typescript
// Messages adaptés au contexte des listes
'list_name is required.'
'Reading list deleted successfully.'
```

== Performance et optimisation

=== Optimisations de consultation
- **Requêtes optimisées** : Jointures minimales pour données essentielles
- **Cache des permissions** : Mise en cache des accès fréquents
- **Pagination intelligente** : Limitation automatique des résultats
- **Index database** : Optimisation sur user_id et is_public

=== Optimisations des modifications
- **Validation déléguée** : Contrôles métier côté service
- **Soft delete** : Préservation performance vs hard delete
- **Transactions** : Opérations atomiques pour cohérence

== Résumé

Le controller readingListController est l'**interface HTTP pour les listes de lecture** de l'API BlaBlaBook V2. Il expose **6 endpoints** avec :

- **Authentification systématique** : Middleware d'authentification sur tous les endpoints
- **Système de permissions sophistiqué** : Gestion fine des accès publics/privés
- **Protection des données sensibles** : Filtrage des champs critiques lors des modifications
- **Navigation sociale** : Consultation des listes publiques d'autres utilisateurs
- **CRUD complet sécurisé** : Opérations complètes avec contrôle de propriété
- **Validation minimale ciblée** : Contrôles essentiels côté controller
- **Messages enrichis** : Feedback explicite pour UX optimisée

**Il constitue l'interface centrale pour la gestion collaborative des listes de lecture avec sécurité multi-niveaux.**