= Controller RateController - Analyse Complète
:toc:
:toclevels: 3

== Vue d'ensemble

Le controller rateController constitue la couche de présentation pour la gestion des notes et évaluations de livres dans l'API BlaBlaBook V2. Il expose des endpoints HTTP RESTful pour consulter, créer, modifier et supprimer des notes avec authentification middleware et validation métier spécialisée.

== Architecture du controller

=== Design pattern d'évaluation avec authentification
- **Middleware d'authentification** : Utilisation de `c.get('user')` pour sécurité
- **Validation métier** : Contrôles spécialisés pour les données de notation
- **CRUD intelligent** : Create/Update en une seule opération
- **Sécurité propriétaire** : Seul l'auteur peut modifier/supprimer ses notes
- **Messages enrichis** : Feedback différencié selon l'opération

=== Rôle dans l'écosystème social
Le controller rateController permet aux utilisateurs d'évaluer les livres :

1. **Consultation des notes** : Accès aux évaluations d'un livre
2. **Notation personnelle** : Création/modification de sa propre note
3. **Gestion des évaluations** : Suppression de ses notes
4. **Système social** : Contribution aux statistiques globales des livres
5. **Sécurité utilisateur** : Protection des notes personnelles

== Endpoints disponibles

=== GET /books/:id/rates - getBookRates()
**Objectif:** Récupérer toutes les notes d'un livre
**Méthode HTTP:** GET
**Paramètres:** `id` (UUID du livre)

**Code avec validation :**
```typescript
async getBookRates(c: Context) {
    const bookId = c.req.param('id');
    const result = await rateService.getBookRates(bookId);

    if (!result) {
        const error = new Error('Book not found.');
        throw error;
    }

    return c.json(result);
}
```

**Fonctionnalité :**
- **Consultation ouverte** : Pas d'authentification requise
- **Validation existence** : Vérification que le livre existe
- **Données enrichies** : Notes avec informations utilisateurs
- **Statistiques incluses** : Moyenne, nombre total de notes

=== POST /rates - createOrUpdateRate()
**Objectif:** Créer ou modifier une note de livre
**Méthode HTTP:** POST
**Authentification:** Middleware requis
**Body JSON requis:**
```json
{
  "id_book": "uuid-du-livre",
  "rating": 4.5,
  "comment": "string (optionnel)"
}
```

**Code avec validation et authentification :**
```typescript
async createOrUpdateRate(c: Context) {
    const rateData = await c.req.json();
    const currentUser = c.get('user');

    if (!rateData.id_book || !rateData.rating) {
        const error = new Error('id_book and rating are required.');
        throw error;
    }

    const result = await rateService.createOrUpdateRate({
        ...rateData,
        id_user: currentUser.id
    });
    const message = result.updated ? 'Rating updated successfully.' : 'Rating created successfully.';
    const status = result.updated ? 200 : 201;

    return c.json({
        message,
        rate: result.rate
    }, status);
}
```

**Validations appliquées :**
- **Champs obligatoires** : id_book et rating validés côté controller
- **Injection utilisateur** : id_user automatiquement ajouté via middleware
- **Logique create/update** : Une seule méthode pour les deux opérations
- **Réponse adaptative** : Message et code de statut selon l'opération

**Sécurité et règles métier :**
- **Authentification requise** : currentUser obligatoire
- **Une note par utilisateur** : Update automatique si déjà existante
- **Validation rating** : Contrôle de plage (1-5) délégué au service
- **Audit automatique** : Traçabilité via user_id

=== DELETE /rates/:id - deleteRate()
**Objectif:** Supprimer une note
**Méthode HTTP:** DELETE
**Authentification:** Middleware requis
**Paramètres:** `id` (UUID de la note)

**Code avec sécurité propriétaire :**
```typescript
async deleteRate(c: Context) {
    const rateId = c.req.param('id');
    const currentUser = c.get('user');

    const deletedRate = await rateService.deleteRate(rateId, currentUser.id);

    if (!deletedRate) {
        const error = new Error('Rate not found.');
        throw error;
    }

    return c.json({
        message: 'Rating deleted successfully.',
        rate: deletedRate
    });
}
```

**Protections appliquées :**
- **Propriété requise** : Seul l'auteur peut supprimer sa note
- **Vérification existence** : Contrôle que la note existe et appartient à l'utilisateur
- **Suppression sécurisée** : user_id utilisé pour filtrage sécurisé
- **Confirmation retournée** : Note supprimée renvoyée pour vérification

== Patterns de conception

=== Authentification middleware intégrée
```typescript
// Pattern d'extraction utilisateur authentifié
const currentUser = c.get('user');
```

**Utilisation :**
- **createOrUpdateRate** : Injection automatique id_user
- **deleteRate** : Contrôle de propriété sécurisé
- **Sécurité transparente** : Authentification gérée par middleware
- **Code simplifié** : Pas de validation manuelle de tokens

=== Validation métier spécialisée
```typescript
// Validation des champs critiques pour notation
if (!rateData.id_book || !rateData.rating) {
    const error = new Error('id_book and rating are required.');
    throw error;
}
```

**Spécificités rating :**
- **id_book obligatoire** : Livre à noter identifié
- **rating obligatoire** : Note numérique requise
- **comment optionnel** : Texte libre pour justification
- **Plage rating** : Validation 1-5 déléguée au service

=== Logique create/update intelligente
```typescript
// Différenciation automatique du type d'opération
const result = await rateService.createOrUpdateRate({
    ...rateData,
    id_user: currentUser.id
});
const message = result.updated ? 'Rating updated successfully.' : 'Rating created successfully.';
const status = result.updated ? 200 : 201;
```

**Avantages :**
- **API unifiée** : Un seul endpoint pour créer/modifier
- **UX simplifiée** : Pas de distinction côté client
- **Messages adaptés** : Feedback précis selon l'opération
- **Codes HTTP corrects** : 201 création, 200 modification

=== Messages enrichis systématiques
```typescript
return c.json({
    message: 'Operation completed successfully.',
    rate: result.rate
}, statusCode);
```

**Enrichissement standard :**
- **message** : Feedback explicite de l'opération
- **rate** : Données de la note créée/modifiée/supprimée
- **statusCode** : Code HTTP approprié au contexte
- **Cohérence** : Même format sur tous les endpoints

== Sécurité et contrôle d'accès

=== Stratégie de sécurité multi-niveaux
**Controller :** Validation paramètres + authentification middleware
**Service :** Règles métier et contrôle de propriété
**Database :** Contraintes d'intégrité et foreign keys

=== Protection des notes personnelles
- **Création sécurisée** : id_user injecté automatiquement
- **Modification restreinte** : Seul l'auteur peut modifier
- **Suppression protégée** : Vérification propriétaire obligatoire
- **Isolation utilisateur** : Pas d'accès aux notes d'autrui

=== Audit trail intégré
- **user_id systématique** : Traçabilité de toutes les opérations
- **Opérations horodatées** : created_at, updated_at automatiques
- **Données complètes** : Retour des entités pour vérification
- **Logs d'activité** : Historique des modifications disponible

== Gestion d'erreurs

=== Stratégie d'erreurs par endpoint
**getBookRates :** 404 si livre inexistant
**createOrUpdateRate :** 400 si champs manquants, 409 si validation échoue
**deleteRate :** 404 si note inexistante ou pas propriétaire

=== Codes de réponse
- **200** : Consultation, modification réussie
- **201** : Note créée avec succès
- **400** : Paramètres manquants ou invalides
- **401** : Authentification requise
- **403** : Accès refusé (pas propriétaire)
- **404** : Livre ou note non trouvé
- **409** : Conflit métier (rating hors plage)

=== Messages d'erreur spécialisés
```typescript
// Messages adaptés au contexte métier
'id_book and rating are required.'
'Book not found.'
'Rate not found.'
```

== Performance et optimisation

=== Optimisations de consultation
- **Cache des statistiques** : Moyennes calculées et mises en cache
- **Pagination intelligente** : Limitation automatique des notes affichées
- **Index database** : Optimisation requêtes par book_id et user_id

=== Optimisations des modifications
- **Upsert optimisé** : Create/Update en une seule requête
- **Validation déléguée** : Contrôles métier côté service
- **Retour minimal** : Données essentielles seulement

== Résumé

Le controller rateController est l'**interface HTTP pour les évaluations de livres** de l'API BlaBlaBook V2. Il expose **3 endpoints** avec :

- **Authentification middleware** : Sécurité automatique via `c.get('user')`
- **Validation métier spécialisée** : Contrôles adaptés aux données de notation
- **CRUD intelligent** : Create/Update unifié avec feedback adaptatif
- **Sécurité propriétaire** : Protection stricte des notes personnelles
- **Messages enrichis** : Feedback explicite pour UX optimisée
- **Audit trail complet** : Traçabilité de toutes les opérations de notation
- **Performance optimisée** : Cache et pagination pour consultation rapide

**Il permet un système de notation sécurisé et convivial pour l'évaluation collaborative des livres.**