= Controller ReviewController - Analyse Complète
:toc:
:toclevels: 3

== Vue d'ensemble

Le controller reviewController constitue la couche de présentation pour la gestion des critiques de livres dans l'API BlaBlaBook V2. Il expose des endpoints HTTP RESTful pour consulter, créer, modifier et supprimer des critiques avec authentification middleware et validation des champs critiques.

== Architecture du controller

=== Design pattern de critique littéraire
- **Middleware d'authentification** : Utilisation de `c.get('user')` pour sécurité
- **Validation des champs critiques** : Contrôles spécialisés pour id_book et title
- **CRUD complet avec propriété** : Seul l'auteur peut modifier/supprimer ses critiques
- **Messages de succès enrichis** : Feedback détaillé avec données retournées
- **Interface CustomError** : Gestion d'erreurs avec status optionnel

=== Rôle dans l'écosystème critique
Le controller reviewController permet aux utilisateurs de partager leurs avis sur les livres :

1. **Consultation des critiques** : Accès aux avis d'un livre
2. **Rédaction de critiques** : Création d'avis personnels détaillés
3. **Gestion des avis** : Modification et suppression de ses propres critiques
4. **Système social** : Contribution aux discussions littéraires
5. **Sécurité d'auteur** : Protection des critiques personnelles

== Endpoints disponibles

=== GET /reviews - getAllReviews()
**Objectif:** Récupérer toutes les critiques publiques de l'application
**Méthode HTTP:** GET
**Paramètres:** Aucun
**Authentification:** Non requise (accès public)

**Code de délégation simple :**
```typescript
async getAllReviews(c: Context) {
    const reviews = await reviewService.getAllReviews();
    return c.json({ reviews });
}
```

**Fonctionnalités :**
- **Accès public** : Pas d'authentification requise
- **Toutes les critiques** : Liste complète de toutes les reviews
- **Pagination automatique** : Limitation côté service pour performance
- **Données enrichies** : Reviews avec infos utilisateur et livre

**Réponse type :**
```json
{
  "reviews": [
    {
      "id_review": "uuid",
      "title": "Chef d'œuvre de la SF",
      "comment": "Excellent livre de science-fiction !",
      "is_public": true,
      "is_spoiler": false,
      "user": {
        "id_user": "uuid",
        "username": "book_lover"
      },
      "book": {
        "id_book": "uuid",
        "title": "Dune"
      },
      "created_at": "2024-01-15T10:30:00Z"
    }
  ]
}
```

**Codes de réponse :**
- `200` : Liste des critiques retournée avec succès
- `500` : Erreur serveur

=== GET /users/:userId/reviews - getUserReviews()
**Objectif:** Récupérer toutes les critiques d'un utilisateur spécifique
**Méthode HTTP:** GET
**Paramètres:**
- `userId` (URL parameter) : Identifiant de l'utilisateur
**Authentification:** Non requise (accès public)

**Code de consultation par utilisateur :**
```typescript
async getUserReviews(c: Context) {
    const userId = c.req.param('userId');
    const reviews = await reviewService.getUserReviews(userId);
    return c.json({ reviews });
}
```

**Fonctionnalités :**
- **Profil utilisateur** : Consultation des avis d'un lecteur
- **Historique de critiques** : Toutes les reviews d'un utilisateur
- **Données enrichies** : Reviews avec informations livres associés
- **Navigation sociale** : Permet de découvrir les lectures d'autres utilisateurs

**Réponse type :**
```json
{
  "reviews": [
    {
      "id_review": "uuid",
      "title": "Ma critique de Dune",
      "comment": "Très bon livre, je recommande",
      "book": {
        "id_book": "uuid",
        "title": "Dune",
        "image": "https://..."
      },
      "created_at": "2024-01-15T10:30:00Z",
      "updated_at": "2024-01-16T09:20:00Z"
    }
  ]
}
```

**Codes de réponse :**
- `200` : Critiques de l'utilisateur retournées
- `404` : Utilisateur non trouvé
- `500` : Erreur serveur

=== GET /books/:id/reviews - getBookReviews()
**Objectif:** Récupérer toutes les critiques d'un livre spécifique
**Méthode HTTP:** GET
**Paramètres:** `id` (UUID du livre)

**Code avec validation :**
```typescript
async getBookReviews(c: Context) {
    const bookId = c.req.param('id');
    const result = await reviewService.getBookReviews(bookId);

    if (!result) {
        const error = new Error('Book not found.');
        throw error;
    }

    return c.json(result);
}
```

**Fonctionnalité :**
- **Consultation ouverte** : Pas d'authentification requise pour la lecture
- **Validation existence** : Vérification que le livre existe
- **Données enrichies** : Critiques avec informations d'auteurs
- **Pagination automatique** : Limitation côté service pour performance

=== POST /reviews - create()
**Objectif:** Créer une nouvelle critique
**Méthode HTTP:** POST
**Authentification:** Middleware requis
**Body JSON requis:**
```json
{
  "id_book": "uuid-du-livre",
  "title": "string (obligatoire)",
  "content": "string (optionnel)",
  "rating": "number (optionnel)"
}
```

**Code avec validation et authentification :**
```typescript
async create(c: Context) {
    const reviewData = await c.req.json();
    const currentUser = c.get('user');

    if (!reviewData.id_book || !reviewData.title) {
        const error = new Error('id_book and title are required.');
        throw error;
    }

    const newReview = await reviewService.create({
        ...reviewData,
        id_user: currentUser.id
    });
    return c.json({
        message: 'Review created successfully.',
        review: newReview
    }, 201);
}
```

**Validations appliquées :**
- **Champs obligatoires** : id_book et title validés côté controller
- **Injection utilisateur** : id_user automatiquement ajouté via middleware
- **Audit automatique** : Traçabilité via user_id
- **Réponse enrichie** : Message de succès + données de la critique créée

**Sécurité et règles métier :**
- **Authentification requise** : currentUser obligatoire
- **Une critique par utilisateur et livre** : Contrôle unicité côté service
- **Validation title** : Titre obligatoire pour structure de la critique
- **Content optionnel** : Flexibilité pour critiques courtes ou détaillées

=== PUT /reviews/:id - update()
**Objectif:** Modifier une critique existante
**Méthode HTTP:** PUT
**Authentification:** Middleware requis
**Paramètres:** `id` (UUID de la critique)

**Code avec sécurité propriétaire :**
```typescript
async update(c: Context) {
    const reviewId = c.req.param('id');
    const updateData = await c.req.json();
    const currentUser = c.get('user');

    const updatedReview = await reviewService.update(reviewId, updateData, currentUser.id);

    if (!updatedReview) {
        const error = new Error('Review not found.');
        throw error;
    }

    return c.json({
        message: 'Review updated successfully.',
        review: updatedReview
    });
}
```

**Protections appliquées :**
- **Propriété requise** : Seul l'auteur peut modifier sa critique
- **Vérification existence** : Contrôle que la critique existe et appartient à l'utilisateur
- **Modification sécurisée** : user_id utilisé pour filtrage sécurisé
- **Retour complet** : Critique modifiée renvoyée pour confirmation

=== DELETE /reviews/:id - delete()
**Objectif:** Supprimer une critique
**Méthode HTTP:** DELETE
**Authentification:** Middleware requis
**Paramètres:** `id` (UUID de la critique)

**Code avec validation propriétaire :**
```typescript
async delete(c: Context) {
    const reviewId = c.req.param('id');
    const currentUser = c.get('user');

    const deletedReview = await reviewService.delete(reviewId, currentUser.id);

    if (!deletedReview) {
        const error = new Error('Review not found.');
        throw error;
    }

    return c.json({
        message: 'Review deleted successfully.',
        review: deletedReview
    });
}
```

**Sécurité de suppression :**
- **Auteur uniquement** : Seul l'auteur peut supprimer sa critique
- **Vérification existence** : Contrôle que la critique existe et appartient à l'utilisateur
- **Suppression sécurisée** : user_id utilisé pour sélection sécurisée
- **Confirmation** : Critique supprimée retournée pour vérification

== Patterns de conception

=== Interface CustomError étendue
```typescript
interface CustomError extends Error {
    status?: number;
}
```

**Utilisation :**
- **Extension Error** : Interface pour enrichissement d'erreurs
- **Status HTTP optionnel** : Préparation pour codes de retour personnalisés
- **Cohérence système** : Même interface que autres controllers
- **Évolutivité** : Préparation pour gestion d'erreurs avancée

=== Validation des champs critiques spécialisée
```typescript
// Validation des champs essentiels pour critique littéraire
if (!reviewData.id_book || !reviewData.title) {
    const error = new Error('id_book and title are required.');
    throw error;
}
```

**Spécificités critique :**
- **id_book obligatoire** : Livre à critiquer identifié
- **title obligatoire** : Titre de la critique pour structure
- **content optionnel** : Texte libre pour développement
- **rating optionnel** : Note numérique complémentaire

=== Pattern de mise à jour sécurisé
```typescript
// Sécurité propriétaire avec user_id dans la requête
const updatedReview = await reviewService.update(reviewId, updateData, currentUser.id);
```

**Avantages sécurité :**
- **Triple validation** : ID critique + données + propriétaire
- **Isolation utilisateur** : Impossible de modifier les critiques d'autrui
- **Audit intégré** : user_id pour traçabilité des modifications
- **Atomicité** : Opération sécurisée en une seule requête

=== Messages enrichis systématiques
```typescript
return c.json({
    message: 'Operation completed successfully.',
    review: reviewData
}, statusCode);
```

**Enrichissement standard :**
- **message** : Feedback explicite de l'opération
- **review** : Données complètes de la critique
- **statusCode** : Code HTTP approprié au contexte
- **Cohérence** : Même format sur tous les endpoints de modification

== Sécurité et contrôle d'accès

=== Stratégie de sécurité multi-couches
**Controller :** Validation paramètres + authentification middleware
**Service :** Règles métier et contrôle de propriété
**Database :** Contraintes d'intégrité et foreign keys

=== Protection des critiques personnelles
- **Création sécurisée** : id_user injecté automatiquement
- **Modification restreinte** : Seul l'auteur peut modifier
- **Suppression protégée** : Vérification propriétaire obligatoire
- **Isolation utilisateur** : Pas d'accès aux critiques d'autrui

=== Audit trail complet
- **user_id systématique** : Traçabilité de toutes les opérations
- **Opérations horodatées** : created_at, updated_at automatiques
- **Données complètes** : Retour des entités pour vérification
- **Historique des modifications** : Logs d'activité disponibles

== Gestion d'erreurs

=== Stratégie d'erreurs par endpoint
**getBookReviews :** 404 si livre inexistant
**create :** 400 si champs manquants, 409 si critique déjà existante
**update :** 404 si critique inexistante ou pas propriétaire
**delete :** 404 si critique inexistante ou pas propriétaire

=== Codes de réponse
- **200** : Consultation, modification réussie
- **201** : Critique créée avec succès
- **400** : Paramètres manquants ou invalides
- **401** : Authentification requise
- **403** : Accès refusé (pas propriétaire)
- **404** : Livre ou critique non trouvé
- **409** : Conflit métier (critique déjà existante)

=== Messages d'erreur spécialisés
```typescript
// Messages adaptés au contexte critique
'id_book and title are required.'
'Book not found.'
'Review not found.'
'Review created successfully.'
'Review updated successfully.'
'Review deleted successfully.'
```

== Performance et optimisation

=== Optimisations de consultation
- **Pagination intelligente** : Limitation automatique des critiques affichées
- **Index database** : Optimisation requêtes par book_id et user_id
- **Cache des critiques populaires** : Mise en cache des avis fréquemment consultés

=== Optimisations des modifications
- **Validation déléguée** : Contrôles métier côté service
- **Requêtes optimisées** : Opérations atomiques avec retour des données
- **Transactions** : Cohérence garantie pour opérations complexes

== Résumé

Le controller reviewController est l'**interface HTTP pour les critiques de livres** de l'API BlaBlaBook V2. Il expose **6 endpoints** avec :

- **Authentification middleware** : Sécurité automatique via `c.get('user')`
- **Validation des champs critiques** : Contrôles spécialisés pour id_book et title
- **CRUD complet avec propriété** : Seul l'auteur peut modifier/supprimer ses critiques
- **Messages de succès enrichis** : Feedback détaillé avec données retournées
- **Interface CustomError** : Gestion d'erreurs avec status optionnel
- **Audit trail complet** : Traçabilité de toutes les opérations de critique
- **Performance optimisée** : Pagination et cache pour consultation rapide

**Il permet un système de critique littéraire sécurisé et convivial pour le partage d'avis détaillés sur les livres.**