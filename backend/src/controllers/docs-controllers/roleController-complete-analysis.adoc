= Controller RoleController - Analyse Complète
:toc:
:toclevels: 3

== Vue d'ensemble

Le controller roleController constitue la couche de présentation pour la gestion des rôles dans l'API BlaBlaBook V2. Il expose des endpoints HTTP RESTful pour le CRUD complet des rôles avec gestion des permissions pour le système RBAC.

== Architecture du controller

=== Design pattern RBAC complet
- **CRUD complet** : Création, lecture, mise à jour et suppression de rôles
- **Consultation des rôles système** : Accès aux rôles USER et ADMIN avec permissions
- **Gestion des permissions** : Association et dissociation de permissions aux rôles
- **Validation des données** : Vérification de la présence des champs requis
- **Gestion d'erreurs** : Erreurs explicites pour les cas d'échec

=== Rôle dans l'architecture RBAC
Le controller roleController est le cœur de la gestion des rôles système :

1. **Administration des rôles** : Création, modification, suppression de rôles
2. **Gestion des permissions** : Association fine des droits aux rôles
3. **Statistiques d'utilisation** : Compteurs d'utilisateurs par rôle
4. **Validation métier** : Contrôles de format et contraintes système
5. **Protection système** : Préservation des rôles essentiels

== Endpoints disponibles

=== GET /roles - getAll()
**Objectif:** Récupérer tous les rôles du système
**Méthode HTTP:** GET

**Code :**
```typescript
async getAll(c: Context) {
    const roles = await roleService.getAll();
    return c.json({ roles });
}
```

**Réponse :**
- **roles** : Liste de tous les rôles (USER, ADMIN, et personnalisés)
- **Format** : Tableau d'objets Role

=== GET /roles/:id - getById()
**Objectif:** Récupérer un rôle spécifique par son ID
**Méthode HTTP:** GET
**Paramètres:** `id` (UUID du rôle)

**Code :**
```typescript
async getById(c: Context) {
    const roleId = c.req.param('id');
    const role = await roleService.getById(roleId);

    if (!role) {
        throw new Error('Role not found.');
    }

    return c.json({ role });
}
```

**Validation :**
- Vérification de l'existence du rôle
- Erreur 500 si non trouvé

=== GET /roles/system - getSystemRoles()
**Objectif:** Récupérer les rôles système USER et ADMIN avec leurs permissions
**Méthode HTTP:** GET

**Code :**
```typescript
async getSystemRoles(c: Context) {
    const [userRole, adminRole, userPermissions, adminPermissions] = await Promise.all([
        roleService.getUserRole(),
        roleService.getAdminRole(),
        roleService.getUserPermissions(),
        roleService.getAdminPermissions()
    ]);

    return c.json({
        roles: [
            { ...userRole, permissions: userPermissions },
            { ...adminRole, permissions: adminPermissions }
        ]
    });
}
```

**Optimisation :**
- Requêtes parallèles via Promise.all
- Enrichissement avec les permissions

=== GET /roles/permissions/:role - getRolePermissions()
**Objectif:** Récupérer les permissions d'un rôle système (USER ou ADMIN)
**Méthode HTTP:** GET
**Paramètres:** `role` (USER ou ADMIN)

**Code :**
```typescript
async getRolePermissions(c: Context) {
    const roleName = c.req.param('role');

    if (roleName === 'USER') {
        const permissions = await roleService.getUserPermissions();
        return c.json({ role: 'USER', permissions });
    }

    if (roleName === 'ADMIN') {
        const permissions = await roleService.getAdminPermissions();
        return c.json({ role: 'ADMIN', permissions });
    }

    return c.json({ error: 'Role must be USER or ADMIN' }, 400);
}
```

**Validation :**
- Seuls USER et ADMIN acceptés
- Erreur 400 pour autres valeurs

=== POST /roles - create()
**Objectif:** Créer un nouveau rôle personnalisé
**Méthode HTTP:** POST
**Body JSON requis:**
```json
{
  "role_name": "string (obligatoire)",
  "description": "string (obligatoire)"
}
```

**Code :**
```typescript
async create(c: Context) {
    const data = await c.req.json();

    if (!data.role_name || !data.description) {
        throw new Error('role_name and description are required.');
    }

    const result = await roleService.create(data);
    return c.json({ message: 'Role created successfully.', role: result }, 201);
}
```

**Validations appliquées :**
- **Champs obligatoires** : role_name et description requis
- **Statut** : 201 pour succès de création

=== PUT /roles/:id - update()
**Objectif:** Modifier un rôle existant
**Méthode HTTP:** PUT
**Paramètres:** `id` (UUID du rôle)
**Body JSON:**
```json
{
  "role_name": "string (optionnel)",
  "description": "string (optionnel)"
}
```

**Code :**
```typescript
async update(c: Context) {
    const roleId = c.req.param('id');
    const data = await c.req.json();

    const result = await roleService.update(roleId, data);
    return c.json({ message: 'Role updated successfully.', role: result });
}
```

**Fonctionnement :**
- Mise à jour des champs fournis uniquement
- Erreur si le rôle n'existe pas (gérée par le service)

=== DELETE /roles/:id - delete()
**Objectif:** Supprimer un rôle
**Méthode HTTP:** DELETE
**Paramètres:** `id` (UUID du rôle)

**Code :**
```typescript
async delete(c: Context) {
    const roleId = c.req.param('id');

    const result = await roleService.delete(roleId);
    return c.json({ message: 'Role deleted successfully.', role: result });
}
```

**Vérifications :**
- Erreur si le rôle n'existe pas (gérée par le service)
- Retourne le rôle supprimé pour confirmation

=== POST /roles/:id/permissions - addPermission()
**Objectif:** Ajouter une permission à un rôle
**Méthode HTTP:** POST
**Paramètres:** `id` (UUID du rôle)
**Body JSON requis:**
```json
{
  "id_permission": "uuid-de-la-permission"
}
```

**Code :**
```typescript
async addPermission(c: Context) {
    const roleId = c.req.param('id');
    const { id_permission } = await c.req.json();

    if (!id_permission) {
        throw new Error('id_permission is required.');
    }

    const result = await roleService.addPermission(roleId, id_permission);
    return c.json({ message: 'Permission added successfully.', result }, 201);
}
```

**Validations :**
- Vérification de la présence de id_permission
- Erreur si la permission est déjà assignée (gérée par le service)

=== DELETE /roles/:id/permissions/:permissionId - removePermission()
**Objectif:** Retirer une permission d'un rôle
**Méthode HTTP:** DELETE
**Paramètres:**
- `id` (UUID du rôle)
- `permissionId` (UUID de la permission)

**Code :**
```typescript
async removePermission(c: Context) {
    const roleId = c.req.param('id');
    const permissionId = c.req.param('permissionId');

    const result = await roleService.removePermission(roleId, permissionId);
    return c.json({ message: 'Permission removed successfully.', result });
}
```

**Validations :**
- Erreur si l'association n'existe pas (gérée par le service)

**Fonctionnalités :**
- **Assignation granulaire** : Ajout de permissions spécifiques aux rôles
- **Validation existence** : Vérification que rôle et permission existent
- **Prévention doublons** : Contrôle des associations déjà existantes
- **Feedback enrichi** : Message de succès avec données d'association

=== DELETE /roles/:id/permissions/:permissionId - removePermission()
**Objectif:** Retirer une permission d'un rôle
**Méthode HTTP:** DELETE
**Paramètres:** `id` (UUID du rôle), `permissionId` (UUID de la permission)

**Code avec validation d'association :**
```typescript
async removePermission(c: Context) {
    const roleId = c.req.param('id');
    const permissionId = c.req.param('permissionId');

    const deletedRolePermission = await roleService.removePermission(roleId, permissionId);

    if (!deletedRolePermission) {
        const error = new Error('Permission not assigned to this role.');
        throw error;
    }

    return c.json({
        message: 'Permission removed from role successfully.',
        role_permission: deletedRolePermission
    });
}
```

**Sécurité de retrait :**
- **Vérification association** : Contrôle que la permission est assignée au rôle
- **Message spécialisé** : Erreur explicite si association inexistante
- **Suppression sécurisée** : Retrait de l'association uniquement
- **Données retournées** : Association supprimée pour confirmation

== Patterns de conception

=== Validation de format de nom stricte
```typescript
// Validation regex pour format de nom de rôle
if (!/^[A-Z_]+$/.test(roleData.name)) {
    const error = new Error('Role name must be uppercase with underscores (e.g., ADMIN, MODERATOR).');
    throw error;
}
```

**Règles de format :**
- **Majuscules uniquement** : A-Z autorisés
- **Underscores permis** : Séparateurs pour noms composés
- **Pas de minuscules** : Cohérence avec conventions RBAC
- **Exemples fournis** : Documentation directe dans le message d'erreur

=== Services enrichis spécialisés
```typescript
// Utilisation de services avec données étendues
const rolesWithStats = await roleService.getAllWithStats();
const role = await roleService.getByIdWithPermissions(roleId);
```

**Services spécialisés :**
- **getAllWithStats()** : Rôles avec compteurs d'utilisateurs
- **getByIdWithPermissions()** : Rôle avec permissions associées
- **Performance optimisée** : Requêtes enrichies en une seule fois
- **Administration facilitée** : Données complètes pour gestion

=== Gestion des permissions granulaire
```typescript
// Pattern d'ajout/suppression de permissions
const result = await roleService.addPermission(roleId, permission_id);
const deleted = await roleService.removePermission(roleId, permissionId);
```

**Gestion fine :**
- **Association individuelle** : Ajout permission par permission
- **Suppression sélective** : Retrait ciblé d'une permission
- **Validation bidirectionnelle** : Existence rôle ET permission
- **Audit complet** : Traçabilité des modifications de permissions

=== Messages enrichis avec données
```typescript
return c.json({
    message: 'Operation completed successfully.',
    role: roleData,
    role_permission: associationData
}, statusCode);
```

**Enrichissement systématique :**
- **message** : Feedback explicite de l'opération
- **Données métier** : Entités créées/modifiées/supprimées
- **Codes appropriés** : 201 pour créations, 200 pour autres
- **Cohérence API** : Même format sur tous les endpoints

== Sécurité et contrôle d'accès

=== Protection des rôles système
**Rôles protégés :**
- **ADMIN** : Rôle administrateur système
- **USER** : Rôle utilisateur standard
- **MODERATOR** : Rôle modérateur communauté

**Protections appliquées :**
- **Suppression interdite** : Rôles système non supprimables
- **Modification contrôlée** : Changements limités pour préserver fonctionnalités
- **Audit renforcé** : Traçabilité des tentatives de modification

=== Validation métier RBAC
- **Format de nom** : Cohérence avec standards RBAC
- **Unicité des noms** : Pas de doublons de rôles
- **Intégrité permissions** : Associations valides uniquement
- **Contraintes système** : Respect de l'architecture de sécurité

== Gestion d'erreurs

=== Stratégie d'erreurs par endpoint
**CRUD rôles :** 400 si validation échoue, 404 si rôle inexistant, 409 si conflit
**Gestion permissions :** 404 si entités inexistantes, 409 si association déjà existante

=== Codes de réponse
- **200** : Consultation, modification réussie
- **201** : Création rôle/association permission réussie
- **400** : Paramètres manquants ou format invalide
- **404** : Rôle, permission ou association non trouvé
- **409** : Conflit métier (nom déjà utilisé, association existante)

=== Messages d'erreur spécialisés
```typescript
// Messages adaptés au contexte RBAC
'name and description are required.'
'Role name must be uppercase with underscores (e.g., ADMIN, MODERATOR).'
'Role not found.'
'Permission not assigned to this role.'
```

== Performance et optimisation

=== Optimisations de consultation
- **Services enrichis** : Données complètes en requêtes uniques
- **Cache des rôles** : Mise en cache des rôles fréquemment consultés
- **Index optimisés** : Performances sur name et permissions

=== Optimisations des modifications
- **Validation déléguée** : Contrôles métier côté service
- **Transactions atomiques** : Cohérence pour opérations complexes
- **Soft delete potentiel** : Préservation historique des rôles

== Résumé

Le controller roleController est l'**interface HTTP pour la gestion des rôles RBAC** de l'API BlaBlaBook V2. Il expose **7 endpoints** avec :

- **Validation de format stricte** : Contrôle du format des noms de rôles (majuscules + underscores)
- **Protection des rôles système** : Sauvegarde des rôles critiques (ADMIN, USER, MODERATOR)
- **Gestion des permissions granulaire** : Association/dissociation fine des droits
- **Services enrichis** : Statistiques d'utilisation et détails complets avec permissions
- **CRUD complet sécurisé** : Opérations complètes avec validation métier
- **Messages enrichis** : Feedback explicite avec données retournées
- **Architecture RBAC avancée** : Fondation robuste pour contrôle d'accès système

**Il constitue le cœur de la gestion des rôles avec sécurité et validation métier sophistiquées.**