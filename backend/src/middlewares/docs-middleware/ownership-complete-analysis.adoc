= Middleware Ownership - Analyse Complète
:toc:
:toclevels: 3

== Vue d'ensemble

Le middleware ownership vérifie que les utilisateurs authentifiés ne peuvent accéder qu'aux ressources qui leur appartiennent ou auxquelles ils ont légitimement accès. C'est le gardien qui s'assure que chaque utilisateur reste dans son périmètre autorisé et ne peut pas consulter ou modifier les données d'autres utilisateurs.

== Fonctions principales

=== requireOwnership
**Objectif:** Vérifier qu'un utilisateur accède à ses propres données personnelles
**Quand:** Utilisé sur les routes de profil utilisateur
**Pourquoi important:** Empêche les utilisateurs de consulter ou modifier les profils d'autres personnes

=== requireListOwnership
**Objectif:** Vérifier qu'un utilisateur accède à ses propres listes de lecture
**Quand:** Utilisé sur les opérations de consultation et modification des listes personnelles
**Pourquoi important:** Protège la vie privée des listes de lecture personnelles

=== requireReviewOwnership
**Objectif:** Vérifier qu'un utilisateur modifie ses propres avis sur les livres
**Quand:** Utilisé lors de la modification ou suppression d'avis
**Pourquoi important:** Empêche la falsification des avis d'autres utilisateurs

=== requireRateOwnership
**Objectif:** Vérifier qu'un utilisateur modifie ses propres notes de livres
**Quand:** Utilisé lors de la suppression de notes
**Pourquoi important:** Protège l'intégrité du système de notation

== Fonctionnement des middlewares ownership

=== Principe de vérification de propriété
Les middlewares ownership fonctionnent comme des agents de sécurité privée qui vérifient les droits de propriété :

1. **Identification de la personne** : Ils récupèrent l'identité de l'utilisateur depuis le token JWT
2. **Identification de la ressource** : Ils déterminent quelle ressource est demandée
3. **Vérification du lien** : Ils consultent la base de données pour confirmer la propriété
4. **Autorisation ou refus** : Ils permettent l'accès si la propriété est confirmée, sinon ils bloquent

=== Dépendance avec l'authentification
Tous les middlewares ownership nécessitent :
- Une authentification préalable via jwtMiddleware
- L'identité utilisateur stockée dans le contexte
- La possibilité d'accéder à la base de données pour vérifier la propriété

== Routes utilisant les middlewares ownership

=== Catégorie : Protection des données personnelles

**Middleware :** requireOwnership
**Routes concernées :**
- Consultation du profil utilisateur
- Modification des informations personnelles
- Changement de mot de passe

**Fonctionnement :** Compare l'ID de l'utilisateur connecté avec l'ID dans l'URL
**Exemple :** Un utilisateur avec l'ID "user_123" ne peut accéder qu'à "/users/user_123"

**Protection assurée :**
- Aucun utilisateur ne peut voir le profil d'un autre
- Aucun utilisateur ne peut modifier les données d'un autre
- Chaque profil reste parfaitement privé

=== Catégorie : Protection des listes de lecture

**Middleware :** requireListOwnership
**Routes concernées :**
- Consultation d'une liste de lecture spécifique
- Modification d'une liste de lecture
- Suppression d'une liste de lecture

**Fonctionnement :** Interroge la base de données pour vérifier que la liste appartient à l'utilisateur connecté
**Service utilisé :** readingListService.getListById avec vérification d'accès

**Protection assurée :**
- Les listes privées restent privées
- Seul le créateur peut modifier ses listes
- Pas d'accès non autorisé aux collections personnelles

=== Catégorie : Protection des avis et opinions

**Middleware :** requireReviewOwnership
**Routes concernées :**
- Modification d'un avis sur un livre
- Suppression d'un avis

**Fonctionnement :** Requête directe en base pour vérifier que l'avis appartient à l'utilisateur
**Vérification :** Compare l'id_user de l'avis avec l'ID de l'utilisateur connecté

**Protection assurée :**
- Impossible de modifier les avis d'autres personnes
- Intégrité des opinions personnelles préservée
- Pas de manipulation externe des critiques

=== Catégorie : Protection des notes et évaluations

**Middleware :** requireRateOwnership
**Routes concernées :**
- Suppression d'une note donnée à un livre

**Fonctionnement :** Requête directe en base pour vérifier que la note appartient à l'utilisateur
**Vérification :** Compare l'id_user de la note avec l'ID de l'utilisateur connecté

**Protection assurée :**
- Impossible de supprimer les notes d'autres personnes
- Système de notation fiable et authentique
- Chaque note reste liée à son véritable auteur

== Exemple de flux complet

=== Scénario : Un utilisateur tente de modifier le profil d'un autre utilisateur

==== Situation de départ
Alice (ID: user_789) découvre qu'elle peut modifier l'URL dans son navigateur. Elle essaie de modifier le profil de Bob (ID: user_456) en changeant l'URL de "/users/user_789" vers "/users/user_456".

==== Étape 1 : Authentification réussie
Le middleware jwtMiddleware :
- Vérifie le token JWT d'Alice
- Confirme son identité (user_789)
- Stocke ses informations dans le contexte

==== Étape 2 : Vérification de la propriété
Le middleware requireOwnership :
- Récupère l'ID d'Alice depuis le contexte (user_789)
- Récupère l'ID cible depuis l'URL (user_456)
- Compare : user_789 ≠ user_456
- Constate une tentative d'accès non autorisé

==== Étape 3 : Blocage immédiat
Le middleware :
- Refuse catégoriquement l'accès
- Renvoie une erreur 403 "Access denied"
- Empêche Alice d'accéder aux données de Bob
- Protège la vie privée de Bob

==== Alternative : Si Alice accédait à son propre profil
Si Alice avait gardé l'URL "/users/user_789" :
- La comparaison aurait donné user_789 = user_789
- Le middleware aurait autorisé l'accès
- Alice aurait pu modifier son profil normalement

==== Protection garantie
Ce système assure que :
- Chaque utilisateur reste dans son périmètre
- Aucune manipulation d'URL ne peut contourner la sécurité
- La vie privée de tous les utilisateurs est préservée

## Exemple avec vérification base de données

=== Scénario : Un utilisateur tente de supprimer l'avis d'un autre utilisateur

==== Situation de départ
Charlie trouve l'ID d'un avis qui ne lui appartient pas et tente de le supprimer en appelant l'API avec cet ID.

==== Étape 1 : Authentification et route
- Charlie est authentifié avec son ID (user_321)
- Sa requête vise à supprimer l'avis numéro 1500
- La route appelle requireReviewOwnership()

==== Étape 2 : Vérification en base de données
Le middleware requireReviewOwnership :
- Fait une requête SQL pour récupérer l'avis 1500
- Découvre que cet avis appartient à l'utilisateur user_654
- Compare user_321 (Charlie) avec user_654 (propriétaire réel)
- Constate une tentative d'accès illégitime

==== Étape 3 : Protection de l'avis
Le middleware :
- Bloque immédiatement la tentative
- Renvoie une erreur 403 "Access denied - Not your review"
- Préserve l'avis original intact
- Protège l'opinion de l'utilisateur légitime

Cette vérification en base de données garantit une sécurité absolue même si Charlie connaissait les IDs d'avis d'autres personnes.

## Gestion des erreurs spécialisées

=== Ressource introuvable
Quand l'ID fourni ne correspond à aucune ressource :
- Les middlewares renvoient une erreur 404 "Resource not found"
- Ils ne révèlent pas si la ressource existe mais appartient à quelqu'un d'autre
- Ils protègent contre l'énumération des ressources

=== Utilisateur non authentifié
Si les middlewares sont appelés sans authentification :
- Ils renvoient immédiatement une erreur 401 "Authentication required"
- Ils empêchent tout accès anonyme aux ressources protégées
- Ils redirigent vers le processus de connexion

=== Erreurs techniques
En cas de problème avec la base de données :
- Les middlewares renvoient une erreur 500 générique
- Ils refusent l'accès par prudence
- Ils préservent la sécurité même en cas de panne

=== Messages d'erreur précis
Chaque type de ressource a ses messages spécialisés :
- "Not your review" pour les avis
- "Not your rating" pour les notes
- "Reading list not found or access denied" pour les listes
- Ces messages aident les utilisateurs légitimes tout en décourageant les tentatives malveillantes

## Architecture de sécurité

=== Double vérification pour les listes
Les listes de lecture bénéficient d'une protection renforcée :
- Vérification via le service readingListService qui implémente sa propre logique de sécurité
- Contrôle des permissions d'accès (publique/privée)
- Gestion des droits de partage éventuels

=== Vérification directe pour avis et notes
Les avis et notes utilisent une approche directe :
- Requêtes SQL directes sur les tables Review et Rate
- Vérification immédiate du champ id_user
- Performance optimisée pour ces opérations fréquentes

=== Principe de responsabilité unique
Chaque middleware a sa spécialité :
- requireOwnership pour les données utilisateur génériques
- requireListOwnership pour la complexité des listes
- requireReviewOwnership pour les avis
- requireRateOwnership pour les notes

## Avantages pour la vie privée

=== Protection des données personnelles
Les utilisateurs sont assurés que :
- Leurs informations personnelles restent privées
- Leurs préférences ne sont pas visibles par d'autres
- Leurs historiques d'activité sont protégés

=== Protection des opinions
Le système garantit :
- L'authenticité des avis et notes
- L'impossibilité de falsifier les opinions d'autrui
- La préservation de l'intégrité du système de recommandation

=== Protection des collections
Les utilisateurs peuvent :
- Créer des listes privées en toute confiance
- Organiser leurs lectures sans surveillance
- Partager uniquement ce qu'ils souhaitent partager

## Interaction avec les autres middlewares

=== Complémentarité avec RBAC
- RBAC vérifie "qui peut faire quoi" au niveau système
- Ownership vérifie "sur quelles données spécifiques"
- Ensemble, ils offrent une protection complète

=== Synergie avec l'authentification
- L'authentification établit l'identité
- L'ownership utilise cette identité pour vérifier les droits
- La combinaison garantit un accès légitime uniquement

=== Coordination avec la validation
- La validation vérifie que les données sont correctes
- L'ownership vérifie que l'utilisateur a le droit de les modifier
- Les deux ensemble protègent l'intégrité des données

## Résumé

Les middlewares ownership sont les **gardiens de la vie privée** de l'API BlaBlaBook V2. Ils protègent **7 endpoints sensibles** avec :
- **requireOwnership** : Protection des profils utilisateur (3 endpoints)
- **requireListOwnership** : Protection des listes de lecture (3 endpoints)
- **requireReviewOwnership** : Protection des avis (2 endpoints)
- **requireRateOwnership** : Protection des notes (1 endpoint)

**Ils garantissent que chaque utilisateur ne peut accéder qu'à ses propres données, préservant ainsi la vie privée et l'intégrité des contenus personnels de tous les utilisateurs de la plateforme.**

== Diagramme de séquence - Workflow Ownership

[mermaid]
----
sequenceDiagram
    participant Client
    participant JWTMiddleware
    participant RequireReviewOwnership
    participant Database
    participant Controller
    participant Service

    Note over Client, Service: Exemple: PATCH /api/reviews/150 (modifier avis)

    Client->>JWTMiddleware: Requête avec Authorization token
    JWTMiddleware->>JWTMiddleware: Décoder JWT et extraire user
    JWTMiddleware->>JWTMiddleware: c.set('user', {id: "user_789", email: "alice@example.com"})
    JWTMiddleware->>RequireReviewOwnership: next()

    RequireReviewOwnership->>RequireReviewOwnership: c.get('user') - Récupérer utilisateur
    RequireReviewOwnership->>RequireReviewOwnership: c.req.param('id') - Récupérer reviewId = "150"

    alt Si user.id manquant
        RequireReviewOwnership-->>Client: 401 "Authentication required"
    else User authentifié
        RequireReviewOwnership->>Database: SELECT * FROM reviews WHERE id = 150
        Database-->>RequireReviewOwnership: {id: 150, id_user: "user_456", content: "..."}

        alt Si avis introuvable
            RequireReviewOwnership-->>Client: 404 "Review not found"
        else Avis trouvé
            RequireReviewOwnership->>RequireReviewOwnership: Comparer "user_789" vs "user_456"

            alt Si user_789 !== user_456 (pas propriétaire)
                RequireReviewOwnership-->>Client: 403 "Access denied - Not your review"
            else Si user_789 === user_456 (propriétaire légitime)
                RequireReviewOwnership->>Controller: next() - Autoriser modification
                Controller->>Service: updateReview(reviewId, newData)
                Service->>Database: UPDATE reviews SET ... WHERE id = 150
                Database-->>Service: Succès mise à jour
                Service-->>Controller: Avis modifié
                Controller-->>Client: 200 "Review updated successfully"
            end
        end
    end

    alt Si erreur base de données
        Database-->>RequireReviewOwnership: Exception
        RequireReviewOwnership-->>Client: 500 "Error checking review ownership"
    end
----