= Middleware CSRF - Analyse Compl√®te
:toc:
:toclevels: 3

== Vue d'ensemble

Le middleware CSRF (Cross-Site Request Forgery) prot√®ge l'API BlaBlaBook V2 contre les attaques o√π un site malveillant tente de faire ex√©cuter des actions √† l'insu d'un utilisateur connect√©. Il fonctionne comme un syst√®me de jetons secrets qui prouvent que les demandes proviennent bien du site officiel et non d'un attaquant.

== Fonctions principales

=== csrfProtection
**Objectif:** V√©rifier qu'une requ√™te de modification provient bien du site officiel
**Quand:** Appliqu√© sur toutes les routes qui modifient des donn√©es (POST, PUT, PATCH, DELETE)
**Pourquoi important:** Emp√™che les sites malveillants de faire des actions √† l'insu de l'utilisateur

=== generateCSRFToken
**Objectif:** Cr√©er un jeton secret unique pour une session utilisateur
**Quand:** Appel√© quand l'application a besoin d'un nouveau jeton
**Pourquoi important:** Fournit les jetons que le site officiel peut utiliser pour prouver sa l√©gitimit√©

=== getCSRFToken
**Objectif:** Fournir un endpoint pour r√©cup√©rer un jeton CSRF
**Quand:** Utilis√© par le frontend pour obtenir des jetons valides
**Pourquoi important:** Permet au site officiel d'obtenir les jetons n√©cessaires

== Principe des attaques CSRF

=== Qu'est-ce qu'une attaque CSRF en mots simples
Imaginez que vous √™tes connect√© √† votre banque en ligne dans un onglet de votre navigateur. Dans un autre onglet, vous visitez un site malveillant qui contient secr√®tement un bouton "Transf√©rer 1000‚Ç¨". Si vous cliquez dessus par accident, votre navigateur enverrait la demande √† votre banque en utilisant votre session active, et le transfert pourrait s'ex√©cuter √† votre insu.

=== Application √† BlaBlaBook
Sans protection CSRF, un site malveillant pourrait :
- Supprimer vos listes de lecture
- Publier de faux avis en votre nom
- Modifier votre profil
- Effectuer toute action que vous pouvez normalement faire

=== Comment le middleware CSRF emp√™che cela
Le middleware exige un "mot de passe secret" (le jeton CSRF) pour toute action de modification. Seul le vrai site BlaBlaBook conna√Æt ce mot de passe, donc les sites malveillants ne peuvent pas effectuer d'actions m√™me si vous √™tes connect√©.

== Fonctionnement du middleware CSRF

=== Principe du jeton secret
Le syst√®me CSRF fonctionne comme un club priv√© avec un mot de passe secret :

1. **G√©n√©ration du secret** : Quand vous vous connectez, le syst√®me g√©n√®re un mot de passe secret unique
2. **Communication du secret** : Le site officiel r√©cup√®re ce mot de passe
3. **Utilisation du secret** : Pour chaque action, le site officiel inclut le mot de passe dans sa demande
4. **V√©rification du secret** : Le serveur v√©rifie que le bon mot de passe est fourni
5. **Autorisation ou refus** : Si le mot de passe est correct, l'action est autoris√©e

=== Stockage des jetons
Les jetons CSRF sont stock√©s en m√©moire sur le serveur :
- Chaque session utilisateur a ses propres jetons
- Les jetons expirent apr√®s 1 heure
- Un nettoyage automatique supprime les jetons expir√©s toutes les 5 minutes

=== M√©thodes HTTP prot√©g√©es
Le middleware ne v√©rifie les jetons que pour les m√©thodes qui modifient des donn√©es :
- **GET, HEAD, OPTIONS** : Pas de v√©rification (consid√©r√©es comme "s√ªres")
- **POST, PUT, PATCH, DELETE** : V√©rification obligatoire du jeton

== Routes utilisant la protection CSRF

=== Cat√©gorie : Authentification et profils utilisateur

**Routes prot√©g√©es :**
- Connexion utilisateur
- Cr√©ation de nouveau compte
- Modification du profil
- Changement de mot de passe
- Suppression de compte (admin)

**Pourquoi prot√©ger ces routes :**
- **Connexion** : Emp√™cher les connexions forc√©es sur des comptes
- **Cr√©ation de compte** : √âviter la cr√©ation de comptes fant√¥mes
- **Modification de profil** : Prot√©ger les donn√©es personnelles
- **Changement de mot de passe** : S√©curit√© critique
- **Suppression** : Action irr√©versible √† prot√©ger absolument

=== Cat√©gorie : Contenu et opinions utilisateur

**Routes prot√©g√©es :**
- Cr√©ation et modification d'avis
- Suppression d'avis
- Cr√©ation et suppression de notes

**Pourquoi prot√©ger ces routes :**
- **Avis** : Emp√™cher la publication de fausses critiques
- **Notes** : Prot√©ger l'int√©grit√© du syst√®me de notation
- **Suppressions** : √âviter l'effacement malveilleux de contenu

=== Cat√©gorie : Collections personnelles

**Routes prot√©g√©es :**
- Cr√©ation et modification de listes de lecture
- Suppression de listes de lecture
- Cr√©ation et modification de biblioth√®ques
- Ajout/suppression de livres dans les collections

**Pourquoi prot√©ger ces routes :**
- **Listes de lecture** : Collections personnelles importantes pour l'utilisateur
- **Biblioth√®ques** : Organisation personnelle du contenu
- **Modifications de collections** : √âviter les manipulations non d√©sir√©es

=== Cat√©gorie : Administration du syst√®me

**Routes prot√©g√©es :**
- Toutes les op√©rations administratives
- Gestion des r√¥les et permissions
- Cr√©ation/suppression d'auteurs et genres

**Pourquoi prot√©ger ces routes :**
- **Administration** : Actions critiques pour le syst√®me
- **Gestion des r√¥les** : S√©curit√© du contr√¥le d'acc√®s
- **Contenu √©ditorial** : Int√©grit√© du catalogue

== Exemple de flux complet

=== Sc√©nario : Un utilisateur veut cr√©er un avis, mais un site malveillant tente une attaque

==== Situation de d√©part
David est connect√© sur BlaBlaBook et lit un article sur un autre site. Ce site contient secr√®tement du code malveillant qui tente de publier un faux avis en son nom.

==== √âtape 1 : Tentative d'attaque malveillante
Le site malveillant envoie une requ√™te vers l'API BlaBlaBook :
- URL : POST /api/reviews
- Donn√©es : Un faux avis tr√®s positif sur un livre
- Session : Le navigateur de David inclut automatiquement ses cookies de session

==== √âtape 2 : Authentification r√©ussie mais CSRF manquant
- Le middleware jwtMiddleware reconna√Æt David gr√¢ce √† son token
- La requ√™te arrive au middleware csrfProtection()
- Le middleware cherche le jeton CSRF dans les en-t√™tes
- Aucun jeton n'est trouv√© (le site malveillant ne le conna√Æt pas)

==== √âtape 3 : Blocage de l'attaque
Le middleware CSRF :
- Constate l'absence du jeton requis
- Bloque imm√©diatement la requ√™te
- Renvoie une erreur 403 "CSRF token required"
- Emp√™che la publication du faux avis

==== Alternative : Utilisation l√©gitime depuis le vrai site
Quand David utilise vraiment le site BlaBlaBook :
- Le site r√©cup√®re un jeton CSRF valide via l'API
- Il inclut ce jeton dans l'en-t√™te de sa requ√™te
- Le middleware v√©rifie et accepte le jeton
- L'avis de David est publi√© normalement

==== Protection assur√©e
Ce syst√®me garantit que :
- Seul le vrai site BlaBlaBook peut effectuer des actions
- Les sites malveillants sont syst√©matiquement bloqu√©s
- Les utilisateurs sont prot√©g√©s m√™me s'ils visitent des sites dangereux

== Gestion des jetons

=== Cycle de vie d'un jeton
1. **G√©n√©ration** : Cr√©ation d'un jeton al√©atoire de 32 bytes
2. **Stockage** : Sauvegarde dans la m√©moire serveur avec timestamp
3. **Distribution** : Transmission au frontend via l'API
4. **Utilisation** : Inclusion dans les en-t√™tes des requ√™tes modifiantes
5. **V√©rification** : Contr√¥le de validit√© √† chaque utilisation
6. **Expiration** : Suppression automatique apr√®s 1 heure

=== Association avec les sessions
Chaque jeton est li√© √† une session utilisateur :
- **Sessions authentifi√©es** : Jeton associ√© au token JWT de l'utilisateur
- **Sessions anonymes** : Jeton associ√© √† un identifiant temporaire
- **Isolation** : Les jetons d'une session ne fonctionnent pas pour une autre

=== Nettoyage automatique
Le syst√®me fait le m√©nage r√©guli√®rement :
- Toutes les 5 minutes, suppression des jetons expir√©s
- √âvite l'accumulation en m√©moire
- Maintient la performance du syst√®me

== S√©curit√© du syst√®me CSRF

=== G√©n√©ration cryptographiquement s√©curis√©e
Les jetons utilisent `randomBytes(32)` :
- G√©n√©ration vraiment al√©atoire, pas pr√©visible
- 32 bytes = 256 bits d'entropie
- Impossible √† deviner m√™me avec des millions d'essais

=== Validation stricte
La v√©rification des jetons est rigoureuse :
- Comparaison exacte du jeton fourni avec celui stock√©
- Pas de tol√©rance aux variations
- √âchec imm√©diat si le jeton ne correspond pas parfaitement

=== Expiration forc√©e
Les jetons ont une dur√©e de vie limit√©e :
- Maximum 1 heure de validit√©
- Renouvellement n√©cessaire pour les sessions longues
- Limite la fen√™tre d'exposition en cas de compromission

=== R√©sistance aux attaques communes

**Attaque par force brute** : Impossible avec 256 bits d'entropie
**Attaque par r√©utilisation** : Les jetons expirent et sont renouvel√©s
**Attaque par interception** : Les jetons voyagent uniquement en HTTPS
**Attaque par pr√©diction** : G√©n√©ration cryptographiquement s√©curis√©e

== Exp√©rience utilisateur

=== Transparence pour l'utilisateur normal
Pour l'utilisateur l√©gitime :
- Le processus est compl√®tement invisible
- Aucune action suppl√©mentaire requise
- Fonctionnement normal du site
- Protection automatique et transparente

=== Gestion des erreurs utilisateur
En cas de probl√®me avec les jetons :
- Messages d'erreur clairs et sp√©cifiques
- Possibilit√© de recharger la page pour obtenir de nouveaux jetons
- Pas de blocage permanent de l'utilisateur

=== Performance optimis√©e
Le syst√®me est con√ßu pour la rapidit√© :
- V√©rifications en m√©moire tr√®s rapides
- Pas d'acc√®s base de donn√©es pour la validation
- Impact minimal sur les performances

== Int√©gration avec le frontend

=== R√©cup√©ration des jetons
Le frontend peut obtenir des jetons via :
- L'endpoint d√©di√© GET /csrf-token
- R√©ponse contenant le jeton, l'ID de session (partiel) et l'expiration
- Rafra√Æchissement automatique avant expiration

=== Utilisation dans les requ√™tes
Le frontend inclut les jetons via :
- En-t√™te `X-CSRF-Token` (recommand√©)
- En-t√™te `CSRF-Token` (alternative)
- Inclusion automatique dans toutes les requ√™tes modifiantes

=== Gestion des expirations
Quand un jeton expire :
- Le backend renvoie une erreur sp√©cifique
- Le frontend peut automatiquement demander un nouveau jeton
- Nouvelle tentative de la requ√™te avec le jeton frais

== R√©sum√©

Le middleware CSRF est le **protecteur contre les attaques cross-site** de l'API BlaBlaBook V2. Il s√©curise **35 endpoints critiques** avec :
- **Protection par jetons** : V√©rification obligatoire pour toutes les actions modifiantes
- **G√©n√©ration s√©curis√©e** : Jetons cryptographiquement forts et impr√©visibles
- **Gestion automatique** : Expiration et nettoyage automatiques des jetons
- **Int√©gration transparente** : Fonctionnement invisible pour les utilisateurs l√©gitimes
- **Blocage des attaques** : Protection absolue contre les sites malveillants

**Il garantit que seul le vrai site BlaBlaBook peut effectuer des modifications au nom des utilisateurs, les prot√©geant ainsi contre toutes les tentatives d'actions malveillantes provenant de sites tiers.**

== Diagramme de s√©quence - Workflow CSRF

[mermaid]
----
sequenceDiagram
    participant Client
    participant MaliciousSite
    participant CSRFMiddleware
    participant CSRFStore
    participant Controller

    Note over Client, Controller: Sc√©nario: Protection contre attaque CSRF

    rect rgb(255, 200, 200)
        Note over Client, Controller: 1. TENTATIVE D'ATTAQUE MALVEILLANTE
        MaliciousSite->>CSRFMiddleware: POST /api/reviews (sans token CSRF)
        Note over MaliciousSite: Site malveillant tente action √† l'insu de l'utilisateur
        CSRFMiddleware->>CSRFMiddleware: V√©rifier method != GET/HEAD/OPTIONS
        CSRFMiddleware->>CSRFMiddleware: Chercher x-csrf-token header
        CSRFMiddleware->>CSRFMiddleware: Token CSRF absent

        CSRFMiddleware-->>MaliciousSite: 403 "CSRF token required"
        Note over CSRFMiddleware, MaliciousSite: ATTAQUE BLOQU√âE ‚úã
    end

    rect rgb(200, 255, 200)
        Note over Client, Controller: 2. UTILISATION L√âGITIME
        Client->>CSRFMiddleware: GET /csrf-token (r√©cup√©ration token)
        CSRFMiddleware->>CSRFMiddleware: Extraire sessionId du JWT
        CSRFMiddleware->>CSRFStore: generateCSRFToken(sessionId)
        CSRFStore->>CSRFStore: randomBytes(32).toString('hex')
        CSRFStore->>CSRFStore: Stocker token avec timestamp
        CSRFStore-->>CSRFMiddleware: Token g√©n√©r√©
        CSRFMiddleware-->>Client: 200 {csrfToken: "abc123...", expires: timestamp}

        Client->>CSRFMiddleware: POST /api/reviews (avec x-csrf-token: "abc123...")
        CSRFMiddleware->>CSRFMiddleware: V√©rifier method = POST (modifie donn√©es)
        CSRFMiddleware->>CSRFMiddleware: Extraire x-csrf-token header = "abc123..."
        CSRFMiddleware->>CSRFMiddleware: Extraire sessionId du JWT
        CSRFMiddleware->>CSRFStore: V√©rifier token pour sessionId
        CSRFStore->>CSRFStore: Chercher token "abc123..." dans la session
        CSRFStore->>CSRFStore: V√©rifier expiration (< 1h)

        alt Token valide et non expir√©
            CSRFStore-->>CSRFMiddleware: Token valid√© ‚úÖ
            CSRFMiddleware->>Controller: next() - Autoriser action
            Controller->>Controller: Cr√©er avis utilisateur
            Controller-->>Client: 201 "Review created successfully"
            Note over CSRFMiddleware, Client: UTILISATION L√âGITIME AUTORIS√âE ‚úÖ
        else Token invalide ou expir√©
            CSRFStore-->>CSRFMiddleware: Token invalide ‚ùå
            CSRFMiddleware-->>Client: 403 "Invalid CSRF token"
        end
    end

    rect rgb(200, 200, 255)
        Note over Client, Controller: 3. NETTOYAGE AUTOMATIQUE
        CSRFStore->>CSRFStore: setInterval(5min) - Nettoyage p√©riodique
        CSRFStore->>CSRFStore: Parcourir tous les tokens
        CSRFStore->>CSRFStore: Supprimer tokens expir√©s (> 1h)
        Note over CSRFStore: Maintien performances et s√©curit√© üßπ
    end
----