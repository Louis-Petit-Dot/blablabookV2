= Middleware Validation - Analyse Complète
:toc:
:toclevels: 3

== Vue d'ensemble

Le middleware validation vérifie que les données envoyées par les utilisateurs respectent les règles définies avant qu'elles n'arrivent aux contrôleurs. Il utilise la bibliothèque Zod pour valider les schémas de données et s'assure que l'application ne traite que des données correctes et sécurisées.

== Fonction principale

=== validateSchema
**Objectif:** Vérifier que les données JSON envoyées dans une requête respectent un schéma prédéfini
**Quand:** Utilisé sur les routes qui reçoivent des données (POST, PUT, PATCH)
**Pourquoi important:** Empêche les données invalides, malformées ou malveillantes d'arriver dans l'application

== Fonctionnement du middleware validation

=== Rôle de contrôleur de qualité
Le middleware validation fonctionne comme un contrôleur qualité dans une usine :

1. **Réception des données** : Il récupère les données JSON envoyées dans la requête
2. **Vérification selon les règles** : Il compare les données au schéma attendu (type, format, longueur, etc.)
3. **Validation réussie** : Si tout est correct, il stocke les données validées pour les étapes suivantes
4. **Validation échouée** : Si quelque chose ne va pas, il bloque la requête et explique les erreurs

=== Stockage des données validées
Après validation réussie, le middleware stocke les données dans le contexte de la requête sous le nom "validatedData". Les contrôleurs peuvent ensuite récupérer ces données nettoyées et garanties valides.

== Routes utilisant le middleware validation

=== Catégorie : Authentification et gestion utilisateur

**Routes concernées :** Connexion, création de compte, modification de profil, changement de mot de passe

**Pourquoi la validation est nécessaire :**
- **Connexion** : Vérifier que l'email est au bon format et que le mot de passe est fourni
- **Création de compte** : Vérifier tous les champs requis (nom, email, mot de passe) et leurs formats
- **Modification de profil** : Vérifier que les nouveaux datos respectent les contraintes
- **Changement de mot de passe** : Vérifier que l'ancien et le nouveau mot de passe sont fournis

**Schémas utilisés :**
- loginSchema pour la connexion
- createUserSchema pour la création de compte
- updateProfileSchema pour la modification de profil
- changePasswordSchema pour le changement de mot de passe

=== Catégorie : Gestion du contenu

**Routes concernées :** Création d'auteurs, création de genres

**Pourquoi la validation est nécessaire :**
- **Création d'auteur** : Vérifier que le nom de l'auteur est fourni et au bon format
- **Création de genre** : Vérifier que le nom du genre est fourni et respecte les contraintes

**Schémas utilisés :**
- authorCreateSchema pour les nouveaux auteurs
- genreCreateSchema pour les nouveaux genres

== Types d'erreurs gérées

=== Erreurs de validation Zod
Quand les données ne respectent pas le schéma :
- Le middleware capture l'erreur Zod
- Il transforme les erreurs techniques en messages compréhensibles
- Il indique exactement quel champ pose problème et pourquoi
- Il renvoie une erreur 400 avec les détails

=== Erreurs de format JSON
Quand les données envoyées ne sont pas du JSON valide :
- Le middleware détecte le problème de format
- Il renvoie une erreur générique "Format de requête invalide"
- Il empêche l'application de planter sur des données malformées

== Exemple de flux complet

=== Scénario : Un utilisateur crée un nouveau compte

==== Situation de départ
Sophie veut créer un compte sur BlaBlaBook. Elle remplit le formulaire d'inscription avec son nom, email et mot de passe, puis clique sur "Créer le compte".

==== Étape 1 : Arrivée des données
La requête arrive avec des données JSON :
```
{
  "username": "sophie_martin",
  "email": "sophie@email.com",
  "password": "monMotDePasseSecret123"
}
```

==== Étape 2 : Le middleware validation intervient
Le middleware validateSchema avec le schéma createUserSchema examine les données :
- Il vérifie que tous les champs requis sont présents
- Il contrôle que l'email a un format valide
- Il vérifie que le mot de passe respecte les critères de sécurité
- Il s'assure que le nom d'utilisateur ne contient pas de caractères interdits

==== Étape 3 : Validation réussie
Toutes les vérifications passent :
- Les données sont stockées dans le "casier" validatedData du contexte
- La requête continue vers le contrôleur userController.create
- Le contrôleur récupère les données validées et les traite en toute sécurité

==== Alternative : Validation échouée
Si Sophie avait fourni un email invalide (par exemple "sophie-email-incorrect") :
- Le middleware aurait détecté le problème
- Il aurait bloqué la requête
- Il aurait renvoyé une erreur 400 avec un message clair : "Le champ email n'est pas un email valide"
- Sophie aurait pu corriger et réessayer

== Avantages de la validation

=== Sécurité renforcée
La validation empêche :
- L'injection de données malveillantes
- Les attaques par dépassement de tampon
- Les tentatives d'injection SQL via des champs mal formatés
- L'envoi de données incohérentes qui pourraient faire planter l'application

=== Expérience utilisateur améliorée
Les utilisateurs reçoivent :
- Des messages d'erreur clairs et spécifiques
- Des indications précises sur ce qui ne va pas
- La possibilité de corriger immédiatement leurs erreurs
- Une réponse rapide sans traitement inutile

=== Code plus propre
Les développeurs bénéficient :
- De données garanties valides dans les contrôleurs
- D'un code plus simple sans vérifications répétitives
- De moins de bugs liés aux données invalides
- D'une maintenance plus facile

== Gestion des erreurs en détail

=== Format des erreurs de validation
Quand une validation échoue, l'utilisateur reçoit une réponse structurée :
- Un indicateur de succès (false)
- Un message général ("Validation failed")
- Une liste détaillée des problèmes par champ
- Un code de statut HTTP 400

=== Messages d'erreur personnalisés
Chaque type d'erreur a son message spécifique :
- "Ce champ est requis" pour les champs manquants
- "Email invalide" pour un format d'email incorrect
- "Le mot de passe doit contenir au moins 8 caractères" pour un mot de passe trop court
- Et ainsi de suite selon les règles définies dans chaque schéma

=== Arrêt immédiat du traitement
En cas d'erreur de validation :
- Le traitement s'arrête immédiatement
- Aucun contrôleur ni service n'est appelé
- Aucune ressource système n'est gaspillée
- L'utilisateur reçoit une réponse rapide

== Interaction avec les autres middlewares

=== Position dans la chaîne
Le middleware validation est généralement placé :
- Après l'authentification (pour savoir qui fait la demande)
- Après la protection CSRF (pour vérifier l'origine)
- Avant les contrôleurs (pour nettoyer les données)

=== Coopération avec les contrôleurs
Les contrôleurs font confiance aux données validées :
- Ils utilisent directement `c.get('validatedData')` sans vérification supplémentaire
- Ils peuvent se concentrer sur la logique métier
- Ils sont protégés contre les données invalides

=== Support des autres middlewares
La validation aide les autres middlewares :
- Le middleware d'ownership peut vérifier des IDs garantis valides
- Les middlewares de rôles reçoivent des données cohérentes
- Le traitement global est plus fiable

== Schémas Zod en pratique

=== Définition des règles métier
Les schémas Zod traduisent les règles métier en contraintes techniques :
- "Un email doit être valide" devient une vérification de format
- "Un mot de passe doit être sécurisé" devient des règles de longueur et complexité
- "Un nom d'utilisateur doit être unique" devient une vérification de format et longueur

=== Évolution des contraintes
Les schémas peuvent évoluer facilement :
- Ajout de nouveaux champs requis
- Modification des formats acceptés
- Renforcement des règles de sécurité
- Adaptation aux nouveaux besoins métier

=== Réutilisation des schémas
Les mêmes schémas peuvent servir :
- Côté serveur pour la validation
- Côté client pour la validation préliminaire
- Dans les tests pour générer des données cohérentes
- Dans la documentation pour expliquer les formats attendus

== Performance et efficacité

=== Validation rapide
La validation Zod est très performante :
- Vérifications en mémoire sans accès base de données
- Arrêt dès la première erreur trouvée
- Pas de traitement inutile des données invalides

=== Économie de ressources
En bloquant tôt les données invalides :
- Les contrôleurs n'ont pas besoin de les traiter
- Les services ne sont pas appelés inutilement
- La base de données n'est pas sollicitée
- Les ressources système sont préservées

=== Cache des schémas
Les schémas Zod sont compilés une seule fois au démarrage :
- Pas de recompilation à chaque requête
- Validation ultra-rapide
- Utilisation optimale de la mémoire

== Résumé

Le middleware validation est le **contrôleur qualité** de l'API BlaBlaBook V2. Il vérifie **6 types de données** critiques avec :
- **loginSchema** : Validation des connexions utilisateur
- **createUserSchema** : Validation des nouveaux comptes
- **updateProfileSchema** : Validation des modifications de profil
- **changePasswordSchema** : Validation des changements de mot de passe
- **authorCreateSchema** : Validation des nouveaux auteurs
- **genreCreateSchema** : Validation des nouveaux genres

**Il garantit que seules des données propres et sécurisées arrivent dans l'application, tout en fournissant des messages d'erreur clairs aux utilisateurs.**

== Diagramme de séquence - Workflow Validation

[mermaid]
----
sequenceDiagram
    participant Client
    participant ValidationMiddleware
    participant ZodSchema
    participant Controller
    participant Service

    Note over Client, Service: Exemple: POST /api/users (création compte)

    Client->>ValidationMiddleware: Requête avec body JSON
    ValidationMiddleware->>ValidationMiddleware: c.req.json() - Parser le body

    alt Si JSON malformé
        ValidationMiddleware-->>Client: 400 "Invalid request format"
    else JSON valide
        ValidationMiddleware->>ZodSchema: schema.parse(body)

        alt Si validation échoue
            ZodSchema-->>ValidationMiddleware: ZodError avec détails
            ValidationMiddleware->>ValidationMiddleware: Transformer erreurs Zod
            ValidationMiddleware->>ValidationMiddleware: Créer objet détails par champ
            ValidationMiddleware-->>Client: 400 "Validation failed" + détails
        else Si validation réussit
            ZodSchema-->>ValidationMiddleware: Données validées et nettoyées
            ValidationMiddleware->>ValidationMiddleware: c.set('validatedData', données)
            ValidationMiddleware->>Controller: next() - Continuer pipeline

            Controller->>Controller: c.get('validatedData') - Récupérer données sûres
            Controller->>Service: create(validatedData)
            Service-->>Controller: Résultat création
            Controller-->>ValidationMiddleware: Réponse succès
            ValidationMiddleware-->>Client: 201 Created + données utilisateur
        end
    end
----