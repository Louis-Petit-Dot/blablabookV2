= Strat√©gie S√©curit√© Production - BlaBlaBook V2
:toc:
:toclevels: 3

== üìã Vue d'ensemble

Ce document d√©finit la strat√©gie de s√©curit√© pour le d√©ploiement en production sur VPS Hostinger avec Nginx.

=== Architecture Production

----
Internet
   ‚Üì
Nginx (:80/:443)
   ‚îú‚îÄ SSL/TLS (Let's Encrypt)
   ‚îú‚îÄ Rate limiting DDoS
   ‚îú‚îÄ Security headers
   ‚îî‚îÄ Reverse Proxy
      ‚Üì
Deno Backend (:8000 local)
   ‚îú‚îÄ Rate limiting m√©tier
   ‚îú‚îÄ CORS
   ‚îú‚îÄ JWT Auth
   ‚îú‚îÄ RBAC
   ‚îú‚îÄ CSRF
   ‚îî‚îÄ Validation
      ‚Üì
PostgreSQL (:5432 local)
----

== üîê R√©partition des Responsabilit√©s

=== Nginx (Couche Infrastructure)

[cols="2,3,2"]
|===
|Fonction |Responsabilit√© |Statut

|*SSL/TLS*
|Terminer HTTPS, certificat Let's Encrypt
|‚úÖ Nginx uniquement

|*Rate Limiting DDoS*
|Protection brutale (100-1000 req/s global)
|‚úÖ Nginx (premi√®re ligne)

|*Security Headers*
|X-Frame-Options, X-Content-Type-Options, HSTS, etc.
|‚úÖ Nginx (pour tout le site)

|*Compression*
|Gzip/Brotli pour r√©ponses
|‚úÖ Nginx

|*Static Files*
|Serve frontend build (si h√©berg√© sur VPS)
|‚úÖ Nginx

|*Reverse Proxy*
|Forward /api/* vers Deno localhost:8000
|‚úÖ Nginx

|===

=== Deno Backend (Couche Application)

[cols="2,3,2"]
|===
|Fonction |Responsabilit√© |Statut

|*Rate Limiting M√©tier*
|100 req/15min par IP, personnalisable par route
|‚úÖ Middleware security.ts

|*CORS*
|Origins autoris√©es, credentials
|‚úÖ Middleware security.ts

|*JWT Authentication*
|V√©rification token, expiration
|‚úÖ Middleware auth.ts

|*RBAC*
|Permissions et r√¥les
|‚úÖ Middleware rbac.ts

|*CSRF Protection*
|Validation token CSRF
|‚úÖ Middleware csrf.ts

|*Ownership*
|V√©rification propri√©t√© ressources
|‚úÖ Middleware ownership.ts

|*Validation*
|Zod schemas
|‚úÖ Middleware validation.ts

|*Auth Lockout*
|5 tentatives max, lockout 15min
|‚úÖ Middleware authLockout.ts

|===

== üîÑ Gestion des Redondances

=== D√©cisions Architecturales

==== Rate Limiting (Les 2)

*Nginx:*
----
limit_req_zone $binary_remote_addr zone=global:10m rate=100r/s;
limit_req zone=global burst=200 nodelay;
----

*Pourquoi:* Protection DDoS brutale avant m√™me d'atteindre Deno

*Deno:*
----
100 requ√™tes / 15 minutes par IP
Stockage en m√©moire (Map)
----

*Pourquoi:* Logique m√©tier fine-grained, peut varier par endpoint

*Conclusion:* ‚úÖ **Compl√©mentaires, pas redondants**

==== Security Headers (Nginx uniquement)

*Choix:* Nginx centralise tous les headers de s√©curit√©

*Rationale:*
- Appliqu√© √† TOUT le trafic (frontend + backend)
- Configuration centralis√©e
- Pas besoin de dupliquer dans le code

*Action:* Retirer security headers du middleware Deno en prod (ou conditionner selon ENV)

==== CORS (Deno uniquement)

*Choix:* Deno g√®re CORS dans le middleware

*Rationale:*
- Logique applicative (origins peuvent changer selon environnement)
- Plus flexible que configuration Nginx
- Peut √™tre conditionn√© par logique m√©tier

*Action:* Nginx ne touche PAS aux headers CORS

== üìù Configuration Nginx Production

=== Exemple nginx.conf

[source,nginx]
----
# Global rate limiting
limit_req_zone $binary_remote_addr zone=global:10m rate=100r/s;

server {
    listen 80;
    server_name api.blablabook.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name api.blablabook.com;

    # SSL Let's Encrypt
    ssl_certificate /etc/letsencrypt/live/api.blablabook.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/api.blablabook.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # Security Headers
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

    # Rate Limiting DDoS
    limit_req zone=global burst=200 nodelay;

    # Body size limit
    client_max_body_size 10M;
    client_body_timeout 10s;
    client_header_timeout 10s;

    # Reverse Proxy vers Deno
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_http_version 1.1;

        # Forward real IP
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Host $host;

        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Logs
    access_log /var/log/nginx/api.blablabook.access.log;
    error_log /var/log/nginx/api.blablabook.error.log;
}
----

== üîß Configuration Deno Production

=== Variables d'Environnement

[source,bash]
----
# .env.prod (sur VPS, PAS dans Git)
NODE_ENV=production

# Database
DATABASE_URL=postgresql://user:password@localhost:5432/blablabook

# JWT (g√©n√©rer avec: openssl rand -hex 64)
JWT_SECRET=<128_caract√®res_random>
JWT_EXPIRATION=1h

# CORS
CORS_ORIGINS=https://blablabook.com,https://app.blablabook.com

# Rate Limiting
RATE_LIMIT_ENABLED=true
RATE_LIMIT_MAX_REQUESTS=100
RATE_LIMIT_WINDOW_MS=900000

# Auth Lockout
AUTH_LOCKOUT_ENABLED=true
AUTH_LOCKOUT_MAX_ATTEMPTS=5
AUTH_LOCKOUT_DURATION_MS=900000
----

=== Optimisation Middleware security.ts

Option 1: Retirer headers en prod (Nginx les g√®re)

[source,typescript]
----
const IS_PROD = Deno.env.get("NODE_ENV") === "production";

// Dans securityMiddleware:
if (!IS_PROD) {
    // Security headers uniquement en DEV (sans Nginx)
    c.header('X-Content-Type-Options', 'nosniff');
    c.header('X-Frame-Options', 'DENY');
    // ...
}
----

Option 2: Garder (doublon inoffensif)

*D√©cision:* √Ä choisir selon pr√©f√©rence. Le doublon n'est pas dangereux.

== üö® Vuln√©rabilit√©s Corrig√©es

=== Bug 1: JWT_SECRET undefined (‚úÖ Fix√©)

*Probl√®me:* App crash si JWT_SECRET manquant

*Solution:*
[source,typescript]
----
const JWT_SECRET = Deno.env.get("JWT_SECRET");
if (!JWT_SECRET) {
  throw new Error("JWT_SECRET environment variable is required");
}
----

*Impact:* Fail-fast au d√©marrage

=== Bug 2: authLockout catch bypass (‚úÖ Fix√©)

*Probl√®me:* JSON invalide bypass lockout

*Solution:*
[source,typescript]
----
try {
    const body = await c.req.json();
    email = body.email;
    if (!email) {
        return next();
    }
} catch (_error) {
    return next(); // Controller g√®re validation
}
----

*Impact:* Lockout s√©curis√©

== üìä Checklist D√©ploiement Production

=== Serveur VPS

- [ ] Ubuntu 22.04 LTS install√©
- [ ] Firewall UFW configur√© (ports 80, 443, 22 uniquement)
- [ ] SSH cl√© publique (d√©sactiver password auth)
- [ ] SSH port chang√© (pas 22)
- [ ] Fail2ban install√© et configur√©
- [ ] Updates automatiques (`unattended-upgrades`)
- [ ] User non-root pour Deno
- [ ] Swap configur√© (si RAM < 4GB)

=== Nginx

- [ ] Nginx install√©
- [ ] Certbot install√© (Let's Encrypt)
- [ ] SSL certificat g√©n√©r√©
- [ ] HTTP ‚Üí HTTPS redirect
- [ ] Configuration nginx test√©e (`nginx -t`)
- [ ] Rate limiting configur√©
- [ ] Security headers configur√©s
- [ ] Logs configur√©s et rotatifs

=== Deno Backend

- [ ] Deno 2.1+ install√©
- [ ] Code d√©ploy√© dans `/opt/blablabook/backend`
- [ ] `.env.prod` cr√©√© avec secrets
- [ ] JWT_SECRET g√©n√©r√© (128+ caract√®res)
- [ ] Process manager configur√© (systemd service)
- [ ] Logs configur√©s
- [ ] Backend d√©marre au boot
- [ ] Health check endpoint `/health`

=== PostgreSQL

- [ ] PostgreSQL 17 install√©
- [ ] Database cr√©√©e
- [ ] User d√©di√© cr√©√©
- [ ] Password fort
- [ ] Listen localhost uniquement
- [ ] Backups automatiques configur√©s (pg_dump + cron)

=== DNS

- [ ] Domaine achet√©
- [ ] A record: `blablabook.com` ‚Üí IP VPS
- [ ] A record: `api.blablabook.com` ‚Üí IP VPS
- [ ] CAA record configur√© (Let's Encrypt)
- [ ] TTL court avant migration (300s)

=== S√©curit√©

- [ ] JWT_SECRET s√©curis√© (128+ caract√®res random)
- [ ] Database password s√©curis√©
- [ ] `.env` pas dans Git (`.gitignore`)
- [ ] CORS origins corrects (pas localhost)
- [ ] Rate limiting actif
- [ ] Auth lockout actif
- [ ] HTTPS obligatoire (HTTP redirect)
- [ ] Security headers actifs

=== Monitoring (Optionnel)

- [ ] Uptime monitoring (UptimeRobot gratuit)
- [ ] Error tracking (Sentry gratuit)
- [ ] Logs centralis√©s
- [ ] Alertes email/SMS

== üéØ Strat√©gie de Migration

=== Phase 1: Pr√©paration

1. Acheter VPS Hostinger (4GB RAM)
2. Acheter domaine
3. Setup serveur (Ubuntu, SSH, firewall)
4. Installer stack (Nginx, Deno, PostgreSQL)

=== Phase 2: Configuration

1. Configurer Nginx (reverse proxy + SSL)
2. D√©ployer backend Deno
3. Cr√©er database PostgreSQL
4. Tester en local (curl localhost:8000)
5. Tester via Nginx (curl https://api.blablabook.com)

=== Phase 3: DNS & SSL

1. Pointer DNS vers VPS
2. Attendre propagation (1-24h)
3. G√©n√©rer SSL Let's Encrypt
4. Tester HTTPS

=== Phase 4: D√©ploiement Frontend

1. Build Next.js (`npm run build`)
2. Upload vers VPS ou Vercel
3. Configurer Nginx (si VPS)
4. Tester end-to-end

=== Phase 5: Monitoring

1. Setup uptime monitoring
2. V√©rifier logs
3. Tester charge (load testing)

== üìù Notes Importantes

=== Rate Limiter en M√©moire

*Statut actuel:* Map JavaScript en m√©moire

*Production single-instance:* ‚úÖ Suffisant

*Production multi-instances:* ‚ùå Besoin Redis

*Migration Redis:* Uniquement si load balancer avec plusieurs instances Deno

=== JWT Expiration

*Actuel:* 24h (confort DEV)

*Production:* Recommand√© 1h + refresh token

*Migration:* Impl√©menter refresh token avant PROD (ou accepter 24h)

=== CSRF Token

*Impl√©mentation:* Bas√©e sur JWT comme session ID

*Limitation:* Si JWT vol√©, CSRF token aussi (mais XSS d√©j√† game over)

*Alternative:* Cookie httpOnly + CSRF s√©par√© (plus complexe avec SPA)

*D√©cision:* Impl√©mentation actuelle acceptable

== üîÑ Maintenance Continue

=== Mises √† Jour

- Updates syst√®me Ubuntu (automatiques configur√©es)
- Updates Deno (v√©rifier changelog)
- Updates d√©pendances npm/deno
- Renouvellement SSL (automatique Let's Encrypt)

=== Backups

- PostgreSQL: pg_dump daily + weekly + monthly
- Code: Git (source of truth)
- Nginx config: `/etc/nginx/` backup
- `.env`: Backup s√©curis√© (chiffr√©)

=== Monitoring

- Logs Nginx: `/var/log/nginx/`
- Logs Deno: journalctl (systemd)
- Disk space: monitoring automatique
- Uptime: UptimeRobot ou √©quivalent

== üìö Ressources

=== Documentation

- Nginx: https://nginx.org/en/docs/
- Let's Encrypt: https://letsencrypt.org/
- Deno Deploy: https://deno.com/deploy/docs
- OWASP Top 10: https://owasp.org/www-project-top-ten/

=== Outils

- SSL Test: https://www.ssllabs.com/ssltest/
- Security Headers: https://securityheaders.com/
- Uptime Robot: https://uptimerobot.com/ (gratuit)
- Sentry: https://sentry.io/ (gratuit tier)

== ‚úÖ R√©sum√© D√©cisions

[cols="2,2,3"]
|===
|Composant |Responsable |Rationale

|*SSL/HTTPS*
|Nginx
|Standard, Let's Encrypt

|*Rate Limit DDoS*
|Nginx
|Premi√®re ligne d√©fense

|*Rate Limit M√©tier*
|Deno
|Logique applicative

|*Security Headers*
|Nginx
|Centralis√©, appliqu√© partout

|*CORS*
|Deno
|Logique applicative flexible

|*JWT Auth*
|Deno
|Logique m√©tier

|*RBAC*
|Deno
|Logique m√©tier

|*CSRF*
|Deno
|Logique m√©tier

|*Validation*
|Deno
|Logique m√©tier

|===

*Principe:* Nginx = Infrastructure, Deno = Application Logic

---

_Document cr√©√©: {docdate}_

_Version: 1.0_

_Projet: BlaBlaBook V2_