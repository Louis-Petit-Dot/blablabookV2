= Entity Relationship Diagram (ERD) - BlaBlaBook / Diagramme ERD - BlaBlaBook
:toc: left
:toclevels: 3
:sectanchors:
:icons: font
:version: 2.0
:date: {docdate}

// Navigation inter-documents
link:../../README.adoc[üìö Documentation Hub] |
link:../../project/CONCEPTION-BLABLABOOKV2.adoc[üèóÔ∏è Architecture] |
link:../Merise/MCD/cardinalites.adoc[üìã Cardinalit√©s] |
link:../../diagrams/sequence/diag-sequence.adoc[üìä Sequence Diagrams]

// Navigation langues
<<section-fr,üá´üá∑ Version Fran√ßaise>> | <<section-en,üá¨üáßüá∫üá∏ English Version>>

---

[[section-fr]]
== üá´üá∑ Diagramme ERD - BlaBlaBook

<<section-en,üá¨üáßüá∫üá∏ Switch to English>> | üá´üá∑ *Fran√ßais*

Ce document pr√©sente le diagramme ERD de l'application BlaBlaBook bas√© sur les sch√©mas Drizzle avec syst√®me RBAC complet.

NOTE: Ce diagramme est g√©n√©r√© √† partir des sch√©mas Drizzle ORM r√©els (`backend/src/models/`) et refl√®te l'√©tat actuel de la base de donn√©es PostgreSQL.

=== Diagramme ERD

[source,mermaid]
----
erDiagram
    USER ||--o{ LIBRARY : owns
    USER ||--o{ READING_LIST : creates
    USER ||--o{ REVIEW : writes
    USER ||--o{ RATE : gives
    USER ||--o{ USER_ROLE : has
    USER ||--o{ USER_ROLE : "assigned_by"

    ROLE ||--o{ USER_ROLE : granted_to
    ROLE ||--o{ ROLE_PERMISSION : has

    PERMISSION ||--o{ ROLE_PERMISSION : belongs_to

    LIBRARY ||--o{ READING_LIST : contains
    LIBRARY ||--o{ BOOK_LIBRARY : stores

    READING_LIST ||--o{ READING_LIST_BOOK : includes

    BOOK ||--o{ BOOK_LIBRARY : stored_in
    BOOK ||--o{ READING_LIST_BOOK : appears_in
    BOOK ||--o{ BOOK_AUTHOR : written_by
    BOOK ||--o{ BOOK_GENRE : categorized_as
    BOOK ||--o{ REVIEW : reviewed_in
    BOOK ||--o{ RATE : rated_in

    AUTHOR ||--o{ BOOK_AUTHOR : writes

    GENRE ||--o{ BOOK_GENRE : classifies

    USER {
        uuid id_user PK
        varchar firstname
        varchar lastname
        varchar username UK
        varchar email UK
        varchar password
        varchar avatar_url
        jsonb preferences
        timestamp last_login
        timestamp created_at
        timestamp updated_at
        timestamp deleted_at "soft delete"
    }

    ROLE {
        uuid id_role PK
        varchar role_name UK
        text description
        timestamp created_at
    }

    PERMISSION {
        uuid id_permission PK
        varchar label UK
        varchar action
        varchar resource
        timestamp created_at
    }

    USER_ROLE {
        uuid id_user_role PK
        uuid id_user FK
        uuid id_role FK
        timestamp assigned_at
        uuid assigned_by FK "self-ref to USER"
    }

    ROLE_PERMISSION {
        uuid id_role_permission PK
        uuid id_role FK
        uuid id_permission FK
        timestamp created_at
    }

    BOOK {
        uuid id_book PK
        varchar isbn UK
        varchar openlibrary_key UK
        varchar title
        text summary
        integer nb_pages
        integer publication_year
        varchar language "default fr"
        varchar image
        jsonb metadata
        timestamp created_at
    }

    AUTHOR {
        uuid id_author PK
        varchar author_name
        text bio
        varchar wikipedia_url
        timestamp created_at
    }

    GENRE {
        uuid id_genre PK
        varchar genre_name UK
        text description
        timestamp created_at
    }

    BOOK_AUTHOR {
        uuid id_book_author PK
        uuid id_book FK
        uuid id_author FK
    }

    BOOK_GENRE {
        uuid id_book_genre PK
        uuid id_book FK
        uuid id_genre FK
        timestamp created_at
    }

    LIBRARY {
        uuid id_library PK
        uuid id_user FK "cascade delete"
        varchar lib_name
        text description
        boolean is_public "default false"
        timestamp created_at
        timestamp updated_at
        timestamp deleted_at "soft delete"
    }

    BOOK_LIBRARY {
        uuid id_book_library PK
        uuid id_book FK
        uuid id_library FK
        timestamp created_at
    }

    READING_LIST {
        uuid id_list PK
        uuid id_user FK "cascade delete"
        uuid id_library FK "cascade delete"
        varchar list_name
        text description
        boolean is_public "default false"
        timestamp created_at
        timestamp updated_at
        timestamp deleted_at "soft delete"
    }

    READING_LIST_BOOK {
        uuid id_reading_list_book PK
        uuid id_list FK
        uuid id_book FK
        timestamp created_at
    }

    REVIEW {
        uuid id_review PK
        uuid id_user FK "cascade delete"
        uuid id_book FK "restrict delete"
        varchar title
        text comment
        boolean is_public "default false"
        boolean is_spoiler "default false"
        timestamp created_at
        timestamp updated_at
        timestamp published_at
    }

    RATE {
        uuid id_rate PK
        uuid id_user FK "cascade delete"
        uuid id_book FK "restrict delete"
        integer rating
        timestamp created_at
        timestamp updated_at
    }
----

=== Description des entit√©s

==== Entit√©s principales

[cols="2,3,2"]
|===
|**Entit√©** |**Description** |**Cl√© primaire**

|**USER**
|Utilisateurs de l'application avec soft delete
|id_user

|**ROLE**
|R√¥les du syst√®me RBAC (USER, ADMIN)
|id_role

|**PERMISSION**
|Permissions du syst√®me (action + resource)
|id_permission

|**LIBRARY**
|Biblioth√®ques personnelles des utilisateurs
|id_library

|**READING_LIST**
|Listes de lecture th√©matiques dans les biblioth√®ques
|id_list

|**BOOK**
|Informations sur les livres (depuis OpenLibrary)
|id_book

|**AUTHOR**
|Auteurs des livres
|id_author

|**GENRE**
|Genres litt√©raires mapp√©s depuis OpenLibrary
|id_genre

|**REVIEW**
|Avis/critiques avec gestion RGPD et spoiler
|id_review

|**RATE**
|Notes num√©riques (entier libre)
|id_rate
|===

==== Tables de liaison (Many-to-Many)

[cols="2,3,2"]
|===
|**Table** |**Description** |**Entit√©s li√©es**

|**USER_ROLE**
|Attribution des r√¥les aux utilisateurs (RBAC)
|USER ‚Üî ROLE

|**ROLE_PERMISSION**
|Attribution des permissions aux r√¥les (RBAC)
|ROLE ‚Üî PERMISSION

|**BOOK_LIBRARY**
|Livres dans les biblioth√®ques
|BOOK ‚Üî LIBRARY

|**READING_LIST_BOOK**
|Livres dans les listes de lecture
|BOOK ‚Üî READING_LIST

|**BOOK_AUTHOR**
|Auteurs des livres (multi-auteurs)
|BOOK ‚Üî AUTHOR

|**BOOK_GENRE**
|Genres des livres (multi-genres)
|BOOK ‚Üî GENRE
|===

=== Cardinalit√©s et r√®gles m√©tier

==== Syst√®me RBAC

* **USER ‚Üî ROLE** (via USER_ROLE) : Un utilisateur peut avoir plusieurs r√¥les, un r√¥le peut √™tre attribu√© √† plusieurs utilisateurs
* **ROLE ‚Üî PERMISSION** (via ROLE_PERMISSION) : Un r√¥le peut avoir plusieurs permissions, une permission peut √™tre attribu√©e √† plusieurs r√¥les
* **USER_ROLE.assigned_by** : Tra√ßabilit√© de qui a assign√© le r√¥le (r√©f√©rence vers USER, nullable)

==== Gestion des contenus

* **USER ‚Üí LIBRARY** (1-N) : Un utilisateur peut cr√©er plusieurs biblioth√®ques
* **USER ‚Üí READING_LIST** (1-N) : Un utilisateur peut cr√©er plusieurs listes
* **LIBRARY ‚Üí READING_LIST** (1-N) : Une biblioth√®que peut contenir plusieurs listes
* **READING_LIST** : Contrainte unique sur (id_user, id_library, list_name)
* **LIBRARY ‚Üî BOOK** (N-N via BOOK_LIBRARY) : Relation many-to-many permettant le partage de livres entre biblioth√®ques
* **READING_LIST ‚Üî BOOK** (N-N via READING_LIST_BOOK) : Relation many-to-many permettant aux livres d'√™tre dans plusieurs listes

==== M√©tadonn√©es des livres

* **BOOK ‚Üî AUTHOR** (N-N via BOOK_AUTHOR) : Un livre peut avoir plusieurs auteurs, un auteur peut √©crire plusieurs livres
* **BOOK ‚Üî GENRE** (N-N via BOOK_GENRE) : Un livre peut appartenir √† plusieurs genres, un genre peut contenir plusieurs livres
* **BOOK.openlibrary_key** : Cl√© unique provenant d'OpenLibrary pour √©viter les doublons d'import
* **BOOK.isbn** : ISBN unique si disponible

==== √âvaluations et Avis

* **USER ‚Üí REVIEW** (1-N) : Un utilisateur peut r√©diger plusieurs avis, chaque avis a un seul auteur
* **BOOK ‚Üê REVIEW** (1-N) : Un livre peut avoir plusieurs avis, chaque avis concerne un seul livre
* **REVIEW** : Contrainte unique sur (id_user, id_book) - un utilisateur ne peut √©crire qu'un seul avis par livre
* **USER ‚Üí RATE** (1-N) : Un utilisateur peut donner plusieurs notes
* **BOOK ‚Üê RATE** (1-N) : Un livre peut recevoir plusieurs notes de diff√©rents utilisateurs
* **RATE** : Contrainte unique sur (id_user, id_book) - un utilisateur ne peut noter qu'une fois par livre

==== Gestion des avis (REVIEW)

* **is_public** : FALSE par d√©faut (avis priv√©, opt-in publication)
* **is_spoiler** : FALSE par d√©faut (utilisateur doit cocher consciemment)
* **published_at** : Timestamp de publication si avis rendu public
* **title** : Titre obligatoire de l'avis (50 caract√®res max)
* **comment** : Contenu textuel de l'avis (optionnel)

=== Contraintes d'int√©grit√©

==== Cl√©s √©trang√®res avec CASCADE DELETE

* `LIBRARY.id_user ‚Üí USER.id_user` : Suppression des biblioth√®ques si utilisateur supprim√©
* `READING_LIST.id_user ‚Üí USER.id_user` : Suppression des listes si utilisateur supprim√©
* `READING_LIST.id_library ‚Üí LIBRARY.id_library` : Suppression des listes si biblioth√®que supprim√©e
* `REVIEW.id_user ‚Üí USER.id_user` : Suppression des avis si utilisateur supprim√©
* `RATE.id_user ‚Üí USER.id_user` : Suppression des notes si utilisateur supprim√©
* `USER_ROLE.id_user ‚Üí USER.id_user` : Suppression des r√¥les si utilisateur supprim√©
* `USER_ROLE.id_role ‚Üí ROLE.id_role` : Suppression des attributions si r√¥le supprim√©
* `ROLE_PERMISSION.id_role ‚Üí ROLE.id_role` : Suppression des permissions si r√¥le supprim√©
* `ROLE_PERMISSION.id_permission ‚Üí PERMISSION.id_permission` : Suppression des attributions si permission supprim√©e
* `BOOK_LIBRARY.id_book ‚Üí BOOK.id_book` : Retrait du livre de toutes les biblioth√®ques si livre supprim√©
* `BOOK_LIBRARY.id_library ‚Üí LIBRARY.id_library` : Retrait de tous les livres si biblioth√®que supprim√©e
* `READING_LIST_BOOK.id_list ‚Üí READING_LIST.id_list` : Retrait de tous les livres si liste supprim√©e
* `READING_LIST_BOOK.id_book ‚Üí BOOK.id_book` : Retrait du livre de toutes les listes si livre supprim√©
* `BOOK_AUTHOR.id_book ‚Üí BOOK.id_book` : Retrait des associations auteurs si livre supprim√©
* `BOOK_AUTHOR.id_author ‚Üí AUTHOR.id_author` : Retrait des associations livres si auteur supprim√©
* `BOOK_GENRE.id_book ‚Üí BOOK.id_book` : Retrait des associations genres si livre supprim√©
* `BOOK_GENRE.id_genre ‚Üí GENRE.id_genre` : Retrait des associations livres si genre supprim√©

==== Cl√©s √©trang√®res avec RESTRICT DELETE

* `REVIEW.id_book ‚Üí BOOK.id_book` : Impossible de supprimer un livre avec des avis
* `RATE.id_book ‚Üí BOOK.id_book` : Impossible de supprimer un livre avec des notes

==== Cl√©s √©trang√®res avec SET NULL

* `USER_ROLE.assigned_by ‚Üí USER.id_user` : Si l'assigneur est supprim√©, le champ devient NULL (tra√ßabilit√© pr√©serv√©e)

==== Contraintes d'unicit√©

* `USER.username` et `USER.email` : Unicit√© globale
* `ROLE.role_name` : Unicit√© des noms de r√¥les
* `PERMISSION.label` : Unicit√© des labels de permissions
* `BOOK.isbn` : Unicit√© des ISBN (si fourni)
* `BOOK.openlibrary_key` : Unicit√© des cl√©s OpenLibrary (√©vite doublons d'import)
* `GENRE.genre_name` : Unicit√© des noms de genres
* `REVIEW` : Unique (id_user, id_book) - un seul avis par utilisateur par livre
* `RATE` : Unique (id_user, id_book) - une seule note par utilisateur par livre
* `READING_LIST` : Unique (id_user, id_library, list_name) - pas de doublons de noms de listes dans une m√™me biblioth√®que pour un utilisateur

=== Notes techniques

==== Soft Delete

Les entit√©s suivantes supportent la suppression logique via `deleted_at` :

* **USER** : Permet de d√©sactiver un compte sans perdre l'historique
* **LIBRARY** : Permet d'archiver une biblioth√®que
* **READING_LIST** : Permet d'archiver une liste de lecture

NOTE: Les livres (BOOK) ne sont **pas** supprim√©s logiquement car ils sont partag√©s entre utilisateurs.

==== Timestamps automatiques

Toutes les entit√©s principales incluent :

* `created_at` : Date de cr√©ation (NOT NULL, defaultNow())
* `updated_at` : Date de derni√®re modification (si applicable, NOT NULL, defaultNow())

==== Types PostgreSQL utilis√©s

* **UUID** : Cl√©s primaires g√©n√©r√©es avec `defaultRandom()` (UUIDv4)
* **VARCHAR** : Cha√Ænes de caract√®res avec longueurs sp√©cifiques
* **TEXT** : Texte sans limite de longueur (summary, bio, description, comment)
* **INTEGER** : Entiers (rating, nb_pages, publication_year)
* **BOOLEAN** : Bool√©ens (is_public, is_spoiler)
* **JSONB** : Donn√©es JSON indexables (preferences, metadata)
* **TIMESTAMP** : Dates avec timezone

==== Int√©gration OpenLibrary

* **BOOK.openlibrary_key** : Cl√© unique provenant d'OpenLibrary (ex: `/works/OL82563W`)
* **BOOK.metadata** : Champ JSONB pour stocker des donn√©es suppl√©mentaires d'OpenLibrary
* **BOOK.image** : URL Cloudinary de la couverture (upload√©e depuis OpenLibrary)

==== Syst√®me de notation

* **RATE.rating** : Entier libre (pas de contrainte CHECK dans le mod√®le actuel)
* Contrainte unique sur (id_user, id_book) pour √©viter les notes multiples

==== Indexation recommand√©e

Pour optimiser les performances :

[source,sql]
----
-- Index sur les cl√©s √©trang√®res fr√©quemment utilis√©es
CREATE INDEX idx_review_user ON REVIEW(id_user);
CREATE INDEX idx_review_book ON REVIEW(id_book);
CREATE INDEX idx_rate_user ON RATE(id_user);
CREATE INDEX idx_rate_book ON RATE(id_book);
CREATE INDEX idx_library_user ON LIBRARY(id_user);
CREATE INDEX idx_reading_list_user ON READING_LIST(id_user);
CREATE INDEX idx_reading_list_library ON READING_LIST(id_library);
CREATE INDEX idx_book_library_book ON BOOK_LIBRARY(id_book);
CREATE INDEX idx_book_library_library ON BOOK_LIBRARY(id_library);

-- Index sur les champs de recherche
CREATE INDEX idx_book_isbn ON BOOK(isbn);
CREATE INDEX idx_book_openlibrary_key ON BOOK(openlibrary_key);
CREATE INDEX idx_user_email ON USER(email);
CREATE INDEX idx_user_username ON USER(username);

-- Index sur les soft deletes
CREATE INDEX idx_user_deleted_at ON USER(deleted_at) WHERE deleted_at IS NULL;
CREATE INDEX idx_library_deleted_at ON LIBRARY(deleted_at) WHERE deleted_at IS NULL;
CREATE INDEX idx_reading_list_deleted_at ON READING_LIST(deleted_at) WHERE deleted_at IS NULL;
----

==== L√©gende

[cols="1,2"]
|===
|**Symbole** |**Signification**

|`PK`
|Cl√© primaire (Primary Key)

|`FK`
|Cl√© √©trang√®re (Foreign Key)

|`UK`
|Cl√© unique (Unique Key)

|`\|\|--o{`
|Relation un-√†-plusieurs

|`}o--o{`
|Relation plusieurs-√†-plusieurs (via table de liaison)
|===

[[section-en]]
== üá¨üáßüá∫üá∏ ERD Diagram - BlaBlaBook

<<section-fr,üá´üá∑ Passer en Fran√ßais>> | üá¨üáßüá∫üá∏ *English*

This document presents the ERD diagram of the BlaBlaBook application based on Drizzle schemas with complete RBAC system.

NOTE: This diagram is generated from actual Drizzle ORM schemas (`backend/src/models/`) and reflects the current state of the PostgreSQL database.

=== ERD Diagram

[source,mermaid]
----
erDiagram
    USER ||--o{ LIBRARY : owns
    USER ||--o{ READING_LIST : creates
    USER ||--o{ REVIEW : writes
    USER ||--o{ RATE : gives
    USER ||--o{ USER_ROLE : has
    USER ||--o{ USER_ROLE : "assigned_by"

    ROLE ||--o{ USER_ROLE : granted_to
    ROLE ||--o{ ROLE_PERMISSION : has

    PERMISSION ||--o{ ROLE_PERMISSION : belongs_to

    LIBRARY ||--o{ READING_LIST : contains
    LIBRARY ||--o{ BOOK_LIBRARY : stores

    READING_LIST ||--o{ READING_LIST_BOOK : includes

    BOOK ||--o{ BOOK_LIBRARY : stored_in
    BOOK ||--o{ READING_LIST_BOOK : appears_in
    BOOK ||--o{ BOOK_AUTHOR : written_by
    BOOK ||--o{ BOOK_GENRE : categorized_as
    BOOK ||--o{ REVIEW : reviewed_in
    BOOK ||--o{ RATE : rated_in

    AUTHOR ||--o{ BOOK_AUTHOR : writes

    GENRE ||--o{ BOOK_GENRE : classifies

    USER {
        uuid id_user PK
        varchar firstname
        varchar lastname
        varchar username UK
        varchar email UK
        varchar password
        varchar avatar_url
        jsonb preferences
        timestamp last_login
        timestamp created_at
        timestamp updated_at
        timestamp deleted_at "soft delete"
    }

    ROLE {
        uuid id_role PK
        varchar role_name UK
        text description
        timestamp created_at
    }

    PERMISSION {
        uuid id_permission PK
        varchar label UK
        varchar action
        varchar resource
        timestamp created_at
    }

    USER_ROLE {
        uuid id_user_role PK
        uuid id_user FK
        uuid id_role FK
        timestamp assigned_at
        uuid assigned_by FK "self-ref to USER"
    }

    ROLE_PERMISSION {
        uuid id_role_permission PK
        uuid id_role FK
        uuid id_permission FK
        timestamp created_at
    }

    BOOK {
        uuid id_book PK
        varchar isbn UK
        varchar openlibrary_key UK
        varchar title
        text summary
        integer nb_pages
        integer publication_year
        varchar language "default fr"
        varchar image
        jsonb metadata
        timestamp created_at
    }

    AUTHOR {
        uuid id_author PK
        varchar author_name
        text bio
        varchar wikipedia_url
        timestamp created_at
    }

    GENRE {
        uuid id_genre PK
        varchar genre_name UK
        text description
        timestamp created_at
    }

    BOOK_AUTHOR {
        uuid id_book_author PK
        uuid id_book FK
        uuid id_author FK
    }

    BOOK_GENRE {
        uuid id_book_genre PK
        uuid id_book FK
        uuid id_genre FK
        timestamp created_at
    }

    LIBRARY {
        uuid id_library PK
        uuid id_user FK "cascade delete"
        varchar lib_name
        text description
        boolean is_public "default false"
        timestamp created_at
        timestamp updated_at
        timestamp deleted_at "soft delete"
    }

    BOOK_LIBRARY {
        uuid id_book_library PK
        uuid id_book FK
        uuid id_library FK
        timestamp created_at
    }

    READING_LIST {
        uuid id_list PK
        uuid id_user FK "cascade delete"
        uuid id_library FK "cascade delete"
        varchar list_name
        text description
        boolean is_public "default false"
        timestamp created_at
        timestamp updated_at
        timestamp deleted_at "soft delete"
    }

    READING_LIST_BOOK {
        uuid id_reading_list_book PK
        uuid id_list FK
        uuid id_book FK
        timestamp created_at
    }

    REVIEW {
        uuid id_review PK
        uuid id_user FK "cascade delete"
        uuid id_book FK "restrict delete"
        varchar title
        text comment
        boolean is_public "default false"
        boolean is_spoiler "default false"
        timestamp created_at
        timestamp updated_at
        timestamp published_at
    }

    RATE {
        uuid id_rate PK
        uuid id_user FK "cascade delete"
        uuid id_book FK "restrict delete"
        integer rating
        timestamp created_at
        timestamp updated_at
    }
----

=== Entity Descriptions

==== Main Entities

[cols="2,3,2"]
|===
|**Entity** |**Description** |**Primary Key**

|**USER**
|Application users with soft delete
|id_user

|**ROLE**
|RBAC system roles (USER, ADMIN)
|id_role

|**PERMISSION**
|System permissions (action + resource)
|id_permission

|**LIBRARY**
|User personal libraries
|id_library

|**READING_LIST**
|Thematic reading lists within libraries
|id_list

|**BOOK**
|Book information (from OpenLibrary)
|id_book

|**AUTHOR**
|Book authors
|id_author

|**GENRE**
|Literary genres mapped from OpenLibrary
|id_genre

|**REVIEW**
|Reviews/critiques with GDPR and spoiler management
|id_review

|**RATE**
|Numeric ratings (free integer)
|id_rate
|===

==== Junction Tables (Many-to-Many)

[cols="2,3,2"]
|===
|**Table** |**Description** |**Linked Entities**

|**USER_ROLE**
|Role assignment to users (RBAC)
|USER ‚Üî ROLE

|**ROLE_PERMISSION**
|Permission assignment to roles (RBAC)
|ROLE ‚Üî PERMISSION

|**BOOK_LIBRARY**
|Books in libraries
|BOOK ‚Üî LIBRARY

|**READING_LIST_BOOK**
|Books in reading lists
|BOOK ‚Üî READING_LIST

|**BOOK_AUTHOR**
|Book authors (multi-author support)
|BOOK ‚Üî AUTHOR

|**BOOK_GENRE**
|Book genres (multi-genre support)
|BOOK ‚Üî GENRE
|===

=== Cardinalities and Business Rules

==== RBAC System

* **USER ‚Üî ROLE** (via USER_ROLE): A user can have multiple roles, a role can be assigned to multiple users
* **ROLE ‚Üî PERMISSION** (via ROLE_PERMISSION): A role can have multiple permissions, a permission can be assigned to multiple roles
* **USER_ROLE.assigned_by**: Traceability of who assigned the role (reference to USER, nullable)

==== Content Management

* **USER ‚Üí LIBRARY** (1-N): A user can create multiple libraries
* **USER ‚Üí READING_LIST** (1-N): A user can create multiple lists
* **LIBRARY ‚Üí READING_LIST** (1-N): A library can contain multiple lists
* **READING_LIST**: Unique constraint on (id_user, id_library, list_name)
* **LIBRARY ‚Üî BOOK** (N-N via BOOK_LIBRARY): Many-to-many relationship allowing book sharing between libraries
* **READING_LIST ‚Üî BOOK** (N-N via READING_LIST_BOOK): Many-to-many relationship allowing books to be in multiple lists

==== Book Metadata

* **BOOK ‚Üî AUTHOR** (N-N via BOOK_AUTHOR): A book can have multiple authors, an author can write multiple books
* **BOOK ‚Üî GENRE** (N-N via BOOK_GENRE): A book can belong to multiple genres, a genre can contain multiple books
* **BOOK.openlibrary_key**: Unique key from OpenLibrary to avoid duplicate imports
* **BOOK.isbn**: Unique ISBN if available

==== Reviews and Ratings

* **USER ‚Üí REVIEW** (1-N): A user can write multiple reviews, each review has a single author
* **BOOK ‚Üê REVIEW** (1-N): A book can have multiple reviews, each review concerns a single book
* **REVIEW**: Unique constraint on (id_user, id_book) - a user can only write one review per book
* **USER ‚Üí RATE** (1-N): A user can give multiple ratings
* **BOOK ‚Üê RATE** (1-N): A book can receive multiple ratings from different users
* **RATE**: Unique constraint on (id_user, id_book) - a user can only rate once per book

==== Review Management (REVIEW)

* **is_public**: FALSE by default (private review, opt-in publication)
* **is_spoiler**: FALSE by default (user must consciously check)
* **published_at**: Publication timestamp if review made public
* **title**: Required review title (50 characters max)
* **comment**: Textual content of review (optional)

=== Integrity Constraints

==== Foreign Keys with CASCADE DELETE

* `LIBRARY.id_user ‚Üí USER.id_user`: Delete libraries if user deleted
* `READING_LIST.id_user ‚Üí USER.id_user`: Delete lists if user deleted
* `READING_LIST.id_library ‚Üí LIBRARY.id_library`: Delete lists if library deleted
* `REVIEW.id_user ‚Üí USER.id_user`: Delete reviews if user deleted
* `RATE.id_user ‚Üí USER.id_user`: Delete ratings if user deleted
* `USER_ROLE.id_user ‚Üí USER.id_user`: Delete roles if user deleted
* `USER_ROLE.id_role ‚Üí ROLE.id_role`: Delete assignments if role deleted
* `ROLE_PERMISSION.id_role ‚Üí ROLE.id_role`: Delete permissions if role deleted
* `ROLE_PERMISSION.id_permission ‚Üí PERMISSION.id_permission`: Delete assignments if permission deleted
* `BOOK_LIBRARY.id_book ‚Üí BOOK.id_book`: Remove book from all libraries if book deleted
* `BOOK_LIBRARY.id_library ‚Üí LIBRARY.id_library`: Remove all books if library deleted
* `READING_LIST_BOOK.id_list ‚Üí READING_LIST.id_list`: Remove all books if list deleted
* `READING_LIST_BOOK.id_book ‚Üí BOOK.id_book`: Remove book from all lists if book deleted
* `BOOK_AUTHOR.id_book ‚Üí BOOK.id_book`: Remove author associations if book deleted
* `BOOK_AUTHOR.id_author ‚Üí AUTHOR.id_author`: Remove book associations if author deleted
* `BOOK_GENRE.id_book ‚Üí BOOK.id_book`: Remove genre associations if book deleted
* `BOOK_GENRE.id_genre ‚Üí GENRE.id_genre`: Remove book associations if genre deleted

==== Foreign Keys with RESTRICT DELETE

* `REVIEW.id_book ‚Üí BOOK.id_book`: Cannot delete a book with reviews
* `RATE.id_book ‚Üí BOOK.id_book`: Cannot delete a book with ratings

==== Foreign Keys with SET NULL

* `USER_ROLE.assigned_by ‚Üí USER.id_user`: If assigner is deleted, field becomes NULL (traceability preserved)

==== Uniqueness Constraints

* `USER.username` and `USER.email`: Global uniqueness
* `ROLE.role_name`: Unique role names
* `PERMISSION.label`: Unique permission labels
* `BOOK.isbn`: Unique ISBN (if provided)
* `BOOK.openlibrary_key`: Unique OpenLibrary keys (avoid duplicate imports)
* `GENRE.genre_name`: Unique genre names
* `REVIEW`: Unique (id_user, id_book) - one review per user per book
* `RATE`: Unique (id_user, id_book) - one rating per user per book
* `READING_LIST`: Unique (id_user, id_library, list_name) - no duplicate list names in same library for a user

=== Technical Notes

==== Soft Delete

The following entities support logical deletion via `deleted_at`:

* **USER**: Allows account deactivation without losing history
* **LIBRARY**: Allows archiving a library
* **READING_LIST**: Allows archiving a reading list

NOTE: Books (BOOK) are **not** soft deleted as they are shared between users.

==== Automatic Timestamps

All main entities include:

* `created_at`: Creation date (NOT NULL, defaultNow())
* `updated_at`: Last modification date (if applicable, NOT NULL, defaultNow())

==== PostgreSQL Types Used

* **UUID**: Primary keys generated with `defaultRandom()` (UUIDv4)
* **VARCHAR**: Character strings with specific lengths
* **TEXT**: Unlimited text (summary, bio, description, comment)
* **INTEGER**: Integers (rating, nb_pages, publication_year)
* **BOOLEAN**: Booleans (is_public, is_spoiler)
* **JSONB**: Indexable JSON data (preferences, metadata)
* **TIMESTAMP**: Dates with timezone

==== OpenLibrary Integration

* **BOOK.openlibrary_key**: Unique key from OpenLibrary (e.g., `/works/OL82563W`)
* **BOOK.metadata**: JSONB field to store additional OpenLibrary data
* **BOOK.image**: Cloudinary URL of cover (uploaded from OpenLibrary)

==== Rating System

* **RATE.rating**: Free integer (no CHECK constraint in current model)
* Unique constraint on (id_user, id_book) to prevent multiple ratings

==== Recommended Indexing

For performance optimization:

[source,sql]
----
-- Index on frequently used foreign keys
CREATE INDEX idx_review_user ON REVIEW(id_user);
CREATE INDEX idx_review_book ON REVIEW(id_book);
CREATE INDEX idx_rate_user ON RATE(id_user);
CREATE INDEX idx_rate_book ON RATE(id_book);
CREATE INDEX idx_library_user ON LIBRARY(id_user);
CREATE INDEX idx_reading_list_user ON READING_LIST(id_user);
CREATE INDEX idx_reading_list_library ON READING_LIST(id_library);
CREATE INDEX idx_book_library_book ON BOOK_LIBRARY(id_book);
CREATE INDEX idx_book_library_library ON BOOK_LIBRARY(id_library);

-- Index on search fields
CREATE INDEX idx_book_isbn ON BOOK(isbn);
CREATE INDEX idx_book_openlibrary_key ON BOOK(openlibrary_key);
CREATE INDEX idx_user_email ON USER(email);
CREATE INDEX idx_user_username ON USER(username);

-- Index on soft deletes
CREATE INDEX idx_user_deleted_at ON USER(deleted_at) WHERE deleted_at IS NULL;
CREATE INDEX idx_library_deleted_at ON LIBRARY(deleted_at) WHERE deleted_at IS NULL;
CREATE INDEX idx_reading_list_deleted_at ON READING_LIST(deleted_at) WHERE deleted_at IS NULL;
----

==== Legend

[cols="1,2"]
|===
|**Symbol** |**Meaning**

|`PK`
|Primary Key

|`FK`
|Foreign Key

|`UK`
|Unique Key

|`\|\|--o{`
|One-to-many relationship

|`}o--o{`
|Many-to-many relationship (via junction table)
|===

---

*Document generated from Drizzle ORM schemas on {date}*

*BlaBlaBook V2 - Stack Deno/Hono/Drizzle/PostgreSQL*
