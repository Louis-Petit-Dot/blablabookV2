= Frontend Security Checklist - BlaBlaBook V2
:toc: left
:toclevels: 3
:sectanchors:
:icons: font

== ğŸ” Vue d'ensemble

Ce document liste **toutes les mesures de sÃ©curitÃ©** Ã  implÃ©menter cÃ´tÃ© frontend Next.js.

**Principe :** Frontend = 20% sÃ©curitÃ© (configuration) + 80% UX

== ğŸ“Š PrioritÃ©s

[cols="1,3,1,1"]
|===
|PrioritÃ© |Mesure |ComplexitÃ© |Impact SÃ©curitÃ©

|ğŸ”´ **P0 - Critique**
|Axios `withCredentials: true`
|5 min
|BLOQUANT

|ğŸ”´ **P0 - Critique**
|Variables env `NEXT_PUBLIC_API_URL`
|2 min
|BLOQUANT

|ğŸŸ  **P1 - Important**
|CSP Headers `next.config.js`
|15 min
|Ã‰levÃ©

|ğŸŸ  **P1 - Important**
|Middleware protection routes
|20 min
|Ã‰levÃ©

|ğŸŸ  **P1 - Important**
|Gestion erreurs 401 (redirect login)
|10 min
|Ã‰levÃ©

|ğŸŸ¡ **P2 - RecommandÃ©**
|Validation Zod formulaires
|30 min
|Moyen (UX)

|ğŸŸ¡ **P2 - RecommandÃ©**
|CSRF token interceptor
|15 min
|Moyen

|âšª **P3 - Optionnel**
|Rate limiting visuel
|20 min
|Faible (UX)

|âšª **P3 - Optionnel**
|DOMPurify sanitization
|10 min
|Faible
|===

**Temps total estimÃ© :** ~2h pour P0+P1+P2

== ğŸ”´ P0 - Mesures Critiques (BLOQUANT)

=== 1. Axios Configuration avec `withCredentials`

**Fichier :** `lib/axios.ts`

**ProblÃ¨me :** Sans `withCredentials: true`, les cookies httpOnly ne sont PAS envoyÃ©s au backend â†’ authentification cassÃ©e.

**Solution :**

[source,typescript]
----
// lib/axios.ts
import axios from 'axios';

const api = axios.create({
  baseURL: process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3000/api',
  withCredentials: true, // âš ï¸ CRITIQUE: Envoie cookies httpOnly
  headers: {
    'Content-Type': 'application/json'
  }
});

export default api;
----

**Test :**
[source,bash]
----
# VÃ©rifier dans DevTools â†’ Network â†’ Request Headers
# Doit contenir: Cookie: access_token=...
----

**Statut :** [ ] Ã€ faire

---

=== 2. Variables d'Environnement SÃ©curisÃ©es

**Fichiers :** `.env.local`, `.env.production`

**ProblÃ¨me :** URL API hardcodÃ©e = impossible de changer entre dev/prod.

**Solution :**

[source,bash]
----
# .env.local (DEV - Git ignorÃ©)
NEXT_PUBLIC_API_URL=http://localhost:3000/api

# .env.production (PROD - Git ignorÃ©)
NEXT_PUBLIC_API_URL=https://api.blablabook.com
----

**RÃ¨gles :**

* `NEXT_PUBLIC_*` â†’ ExposÃ© au navigateur (OK pour URL publique)
* Sans prefix â†’ Serveur uniquement (secrets, clÃ©s API)
* âŒ **JAMAIS** de secrets dans le code

**Gitignore :**
[source,gitignore]
----
# .gitignore (frontend)
.env.local
.env.production
.env*.local
----

**Statut :** [ ] `.env.local` crÃ©Ã© [ ] `.env.production` crÃ©Ã© [ ] Dans `.gitignore`

---

== ğŸŸ  P1 - Mesures Importantes

=== 3. CSP Headers (Content Security Policy)

**Fichier :** `next.config.js`

**ProblÃ¨me :** Sans CSP, un attaquant peut injecter `<script>` malveillant.

**Solution :**

[source,javascript]
----
// next.config.js
const securityHeaders = [
  {
    key: 'X-DNS-Prefetch-Control',
    value: 'on'
  },
  {
    key: 'Strict-Transport-Security',
    value: 'max-age=63072000; includeSubDomains; preload'
  },
  {
    key: 'X-Frame-Options',
    value: 'SAMEORIGIN' // Protection clickjacking
  },
  {
    key: 'X-Content-Type-Options',
    value: 'nosniff' // Protection MIME sniffing
  },
  {
    key: 'X-XSS-Protection',
    value: '1; mode=block'
  },
  {
    key: 'Referrer-Policy',
    value: 'strict-origin-when-cross-origin'
  },
  {
    key: 'Permissions-Policy',
    value: 'camera=(), microphone=(), geolocation=()'
  },
  {
    key: 'Content-Security-Policy',
    value: `
      default-src 'self';
      script-src 'self' 'unsafe-eval' 'unsafe-inline';
      style-src 'self' 'unsafe-inline';
      img-src 'self' https://res.cloudinary.com data: blob:;
      font-src 'self' data:;
      connect-src 'self' ${process.env.NEXT_PUBLIC_API_URL};
      frame-ancestors 'none';
    `.replace(/\s{2,}/g, ' ').trim()
  }
];

/** @type {import('next').NextConfig} */
const nextConfig = {
  async headers() {
    return [
      {
        source: '/:path*',
        headers: securityHeaders,
      },
    ];
  },
};

module.exports = nextConfig;
----

**Protection :**

* `X-Frame-Options: SAMEORIGIN` â†’ Bloque iframe externe (clickjacking)
* `X-Content-Type-Options: nosniff` â†’ Bloque MIME sniffing
* `CSP img-src` â†’ Whitelist Cloudinary pour images
* `CSP connect-src` â†’ Whitelist API backend

**Test :**
[source,bash]
----
# VÃ©rifier dans DevTools â†’ Network â†’ Response Headers
# Doit contenir tous les headers ci-dessus
----

**Statut :** [ ] ImplÃ©mentÃ© [ ] TestÃ© DevTools

---

=== 4. Middleware Protection Routes ProtÃ©gÃ©es

**Fichier :** `middleware.ts` (racine Next.js)

**ProblÃ¨me :** Utilisateurs non-authentifiÃ©s peuvent accÃ©der aux pages dashboard.

**Solution :**

[source,typescript]
----
// middleware.ts
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';

export function middleware(request: NextRequest) {
  const token = request.cookies.get('access_token');

  const isAuthPage = request.nextUrl.pathname.startsWith('/login') ||
                     request.nextUrl.pathname.startsWith('/register');

  const isProtectedPage = request.nextUrl.pathname.startsWith('/dashboard') ||
                          request.nextUrl.pathname.startsWith('/library') ||
                          request.nextUrl.pathname.startsWith('/profile');

  // Pas de token + page protÃ©gÃ©e â†’ redirect login
  if (!token && isProtectedPage) {
    return NextResponse.redirect(new URL('/login', request.url));
  }

  // Token prÃ©sent + page auth â†’ redirect dashboard
  if (token && isAuthPage) {
    return NextResponse.redirect(new URL('/dashboard', request.url));
  }

  return NextResponse.next();
}

export const config = {
  matcher: ['/((?!api|_next/static|_next/image|favicon.ico).*)']
};
----

**Protection :**

* VÃ©rifie prÃ©sence cookie `access_token`
* Redirect `/login` si pas de token + page protÃ©gÃ©e
* Redirect `/dashboard` si token prÃ©sent + page auth (Ã©vite double login)

**Test :**
[source,bash]
----
# Sans cookie: http://localhost:3001/dashboard â†’ redirect /login
# Avec cookie: http://localhost:3001/login â†’ redirect /dashboard
----

**Statut :** [ ] ImplÃ©mentÃ© [ ] TestÃ© redirects

---

=== 5. Gestion Erreurs 401 (Token ExpirÃ©)

**Fichier :** `lib/axios.ts`

**ProblÃ¨me :** Token expire aprÃ¨s 8h â†’ l'utilisateur reste bloquÃ© sur page erreur.

**Solution :**

[source,typescript]
----
// lib/axios.ts
import axios from 'axios';

const api = axios.create({
  baseURL: process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3000/api',
  withCredentials: true,
  headers: {
    'Content-Type': 'application/json'
  }
});

// Interceptor pour gÃ©rer token expirÃ©
api.interceptors.response.use(
  (response) => response,
  (error) => {
    if (error.response?.status === 401) {
      // Token expirÃ© ou invalide â†’ redirect login
      if (typeof window !== 'undefined') {
        window.location.href = '/login';
      }
    }
    return Promise.reject(error);
  }
);

export default api;
----

**Protection :**

* DÃ©tecte 401 Unauthorized
* Redirect automatique `/login`
* Check `typeof window` (Ã©vite erreur SSR)

**Statut :** [ ] ImplÃ©mentÃ© [ ] TestÃ© expiration token

---

== ğŸŸ¡ P2 - Mesures RecommandÃ©es

=== 6. Validation Formulaires CÃ´tÃ© Client (Zod)

**Fichiers :** `schemas/authSchema.ts`, `components/LoginForm.tsx`

**ProblÃ¨me :** Utilisateur attend rÃ©ponse backend â†’ UX lente.

**Solution :**

[source,typescript]
----
// schemas/authSchema.ts
import { z } from 'zod';

export const loginSchema = z.object({
  email: z.string().email('Email invalide').toLowerCase(),
  password: z.string().min(8, 'Minimum 8 caractÃ¨res')
});

export const registerSchema = z.object({
  email: z.string().email('Email invalide').toLowerCase(),
  username: z.string()
    .min(3, 'Minimum 3 caractÃ¨res')
    .max(20, 'Maximum 20 caractÃ¨res')
    .regex(/^[a-zA-Z0-9_]+$/, 'Alphanumerique + underscore uniquement'),
  password: z.string()
    .min(8, 'Minimum 8 caractÃ¨res')
    .regex(/[A-Z]/, 'Minimum 1 majuscule')
    .regex(/[0-9]/, 'Minimum 1 chiffre')
    .regex(/[!@#$%^&*]/, 'Minimum 1 caractÃ¨re spÃ©cial'),
  firstname: z.string().min(2, 'Minimum 2 caractÃ¨res'),
  lastname: z.string().min(2, 'Minimum 2 caractÃ¨res')
});

export type LoginFormData = z.infer<typeof loginSchema>;
export type RegisterFormData = z.infer<typeof registerSchema>;
----

**Usage avec React Hook Form :**

[source,typescript]
----
// components/LoginForm.tsx
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { loginSchema, type LoginFormData } from '@/schemas/authSchema';
import api from '@/lib/axios';

export default function LoginForm() {
  const { register, handleSubmit, formState: { errors } } = useForm<LoginFormData>({
    resolver: zodResolver(loginSchema)
  });

  const onSubmit = async (data: LoginFormData) => {
    try {
      await api.post('/users/login', data);
      window.location.href = '/dashboard';
    } catch (error) {
      console.error('Login failed:', error);
    }
  };

  return (
    <form onSubmit={handleSubmit(onSubmit)}>
      <input {...register('email')} type="email" />
      {errors.email && <span>{errors.email.message}</span>}

      <input {...register('password')} type="password" />
      {errors.password && <span>{errors.password.message}</span>}

      <button type="submit">Login</button>
    </form>
  );
}
----

**Avantage :**

* Feedback immÃ©diat (avant appel API)
* UX amÃ©liorÃ©e
* Backend valide quand mÃªme (sÃ©curitÃ© garantie)

**Statut :** [ ] Schemas crÃ©Ã©s [ ] React Hook Form intÃ©grÃ©

---

=== 7. CSRF Token Interceptor

**Fichier :** `lib/csrf.ts`

**ProblÃ¨me :** RequÃªtes POST/PUT/DELETE sans CSRF token peuvent Ãªtre rejetÃ©es.

**Solution :**

[source,typescript]
----
// lib/csrf.ts
import api from './axios';

let csrfToken: string | null = null;

export const getCsrfToken = async (): Promise<string> => {
  if (csrfToken) return csrfToken;

  const response = await api.get('/csrf-token');
  csrfToken = response.data.csrfToken;
  return csrfToken;
};

// Ajouter automatiquement CSRF token aux requÃªtes mutantes
api.interceptors.request.use(async (config) => {
  if (['post', 'put', 'delete', 'patch'].includes(config.method || '')) {
    const token = await getCsrfToken();
    config.headers['X-CSRF-Token'] = token;
  }
  return config;
});
----

**Usage :**

[source,typescript]
----
// Automatique, rien Ã  faire dans les composants
await api.post('/users/login', data); // CSRF ajoutÃ© automatiquement
----

**Statut :** [ ] ImplÃ©mentÃ© [ ] TestÃ© requÃªtes POST

---

== âšª P3 - Mesures Optionnelles

=== 8. Rate Limiting Visuel (UX)

**Fichier :** `hooks/useRateLimit.ts`

**ProblÃ¨me :** Utilisateur peut spammer le bouton login.

**Solution :**

[source,typescript]
----
// hooks/useRateLimit.ts
import { useState, useEffect } from 'react';

export const useRateLimit = (maxAttempts = 3, windowMs = 60000) => {
  const [attempts, setAttempts] = useState(0);
  const [isBlocked, setIsBlocked] = useState(false);
  const [remainingTime, setRemainingTime] = useState(0);

  useEffect(() => {
    if (isBlocked && remainingTime > 0) {
      const timer = setTimeout(() => {
        setRemainingTime((prev) => prev - 1000);
      }, 1000);
      return () => clearTimeout(timer);
    } else if (remainingTime <= 0 && isBlocked) {
      setIsBlocked(false);
      setAttempts(0);
    }
  }, [isBlocked, remainingTime]);

  const recordAttempt = () => {
    const newAttempts = attempts + 1;
    setAttempts(newAttempts);

    if (newAttempts >= maxAttempts) {
      setIsBlocked(true);
      setRemainingTime(windowMs);
    }
  };

  const reset = () => {
    setAttempts(0);
    setIsBlocked(false);
    setRemainingTime(0);
  };

  return { isBlocked, remainingTime, recordAttempt, reset, attempts };
};
----

**Usage :**

[source,typescript]
----
// components/LoginForm.tsx
const { isBlocked, remainingTime, recordAttempt, reset } = useRateLimit(3, 60000);

const onSubmit = async (data) => {
  if (isBlocked) return;

  try {
    await api.post('/users/login', data);
    reset(); // SuccÃ¨s â†’ reset compteur
  } catch (error) {
    recordAttempt(); // Ã‰chec â†’ increment
  }
};

return (
  <>
    <button disabled={isBlocked}>
      {isBlocked ? `Retry in ${remainingTime / 1000}s` : 'Login'}
    </button>
  </>
);
----

**Statut :** [ ] Hook crÃ©Ã© [ ] IntÃ©grÃ© formulaire

---

=== 9. DOMPurify Sanitization (Affichage User Content)

**Fichier :** `components/ReviewCard.tsx` (exemple)

**ProblÃ¨me :** Si tu affiches du contenu user avec `dangerouslySetInnerHTML`.

**Solution :**

[source,typescript]
----
// Installation
npm install isomorphic-dompurify

// components/ReviewCard.tsx
import DOMPurify from 'isomorphic-dompurify';

export default function ReviewCard({ review }) {
  const sanitizedContent = DOMPurify.sanitize(review.content, {
    ALLOWED_TAGS: ['b', 'i', 'em', 'strong', 'p', 'br'],
    ALLOWED_ATTR: []
  });

  return (
    <div dangerouslySetInnerHTML={{ __html: sanitizedContent }} />
  );
}
----

**NOTE :** Seulement si tu utilises `dangerouslySetInnerHTML`. Si tu affiches du texte brut (`{review.content}`), pas nÃ©cessaire.

**Statut :** [ ] NÃ©cessaire ? [ ] ImplÃ©mentÃ© si oui

---

== ğŸ“¦ DÃ©pendances NPM

[source,bash]
----
# Obligatoires
npm install axios
npm install next

# Validation (P2)
npm install zod
npm install react-hook-form @hookform/resolvers

# Sanitization (P3 - optionnel)
npm install isomorphic-dompurify
----

== ğŸ“‚ Structure Fichiers Frontend

[source,plaintext]
----
frontend/
â”œâ”€â”€ .env.local                    # âœ… Variables dev (Git ignored)
â”œâ”€â”€ .env.production               # âœ… Variables prod (Git ignored)
â”œâ”€â”€ .gitignore                    # âœ… Ignorer .env*
â”œâ”€â”€ next.config.js                # âœ… CSP Headers
â”œâ”€â”€ middleware.ts                 # âœ… Protection routes
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ axios.ts                  # âœ… Axios config + interceptors
â”‚   â””â”€â”€ csrf.ts                   # ğŸŸ¡ CSRF token helper
â”œâ”€â”€ schemas/
â”‚   â””â”€â”€ authSchema.ts             # ğŸŸ¡ Validation Zod
â”œâ”€â”€ hooks/
â”‚   â””â”€â”€ useRateLimit.ts           # âšª Rate limit visuel
â””â”€â”€ components/
    â””â”€â”€ LoginForm.tsx             # Usage React Hook Form
----

== ğŸ§ª Tests SÃ©curitÃ© Frontend

=== Test 1: Cookies envoyÃ©s avec `withCredentials`

[source,bash]
----
# DevTools â†’ Network â†’ SÃ©lectionner requÃªte API
# Request Headers â†’ Doit contenir:
Cookie: access_token=eyJhbGc...
----

**RÃ©sultat attendu :** âœ… Cookie prÃ©sent

---

=== Test 2: CSP Headers actifs

[source,bash]
----
# DevTools â†’ Network â†’ SÃ©lectionner page HTML
# Response Headers â†’ Doit contenir:
Content-Security-Policy: default-src 'self'; ...
X-Frame-Options: SAMEORIGIN
X-Content-Type-Options: nosniff
----

**RÃ©sultat attendu :** âœ… Tous les headers prÃ©sents

---

=== Test 3: Protection routes middleware

[source,bash]
----
# Supprimer cookie access_token dans DevTools
# Naviguer vers: http://localhost:3001/dashboard
# RÃ©sultat: Redirect vers /login

# Se login
# Naviguer vers: http://localhost:3001/login
# RÃ©sultat: Redirect vers /dashboard
----

**RÃ©sultat attendu :** âœ… Redirects fonctionnent

---

=== Test 4: Gestion 401 (Token expirÃ©)

[source,bash]
----
# Modifier cookie access_token â†’ valeur invalide
# Faire une requÃªte API (ex: GET /api/users/me)
# RÃ©sultat: Redirect automatique vers /login
----

**RÃ©sultat attendu :** âœ… Redirect automatique

---

== ğŸ“Š Checklist Finale

=== ğŸ”´ P0 - Critique (BLOQUANT)
- [ ] Axios `withCredentials: true` implÃ©mentÃ©
- [ ] `.env.local` avec `NEXT_PUBLIC_API_URL` crÃ©Ã©
- [ ] `.env.production` avec `NEXT_PUBLIC_API_URL` crÃ©Ã©
- [ ] `.env*` dans `.gitignore`
- [ ] TestÃ©: Cookie envoyÃ© dans requÃªtes (DevTools)

=== ğŸŸ  P1 - Important
- [ ] `next.config.js` avec CSP Headers
- [ ] `middleware.ts` protection routes protÃ©gÃ©es
- [ ] Gestion erreurs 401 dans Axios interceptor
- [ ] TestÃ©: Headers CSP (DevTools)
- [ ] TestÃ©: Redirects middleware

=== ğŸŸ¡ P2 - RecommandÃ©
- [ ] Schemas Zod validation client (`schemas/authSchema.ts`)
- [ ] React Hook Form intÃ©grÃ©
- [ ] CSRF token interceptor (`lib/csrf.ts`)
- [ ] TestÃ©: Validation formulaire

=== âšª P3 - Optionnel
- [ ] Hook `useRateLimit` (rate limiting visuel)
- [ ] DOMPurify (si `dangerouslySetInnerHTML` utilisÃ©)

=== ğŸ“¦ Installation
- [ ] `npm install axios zod react-hook-form @hookform/resolvers`
- [ ] `npm install isomorphic-dompurify` (si P3)

== ğŸ¯ Estimation Temps

[cols="2,1,1"]
|===
|Phase |Temps |CumulÃ©

|P0 (Critique)
|15 min
|15 min

|P1 (Important)
|45 min
|1h

|P2 (RecommandÃ©)
|45 min
|1h45

|P3 (Optionnel)
|30 min
|2h15

|Tests
|15 min
|2h30
|===

**Total estimÃ© :** 2h30 pour sÃ©curitÃ© frontend complÃ¨te

== ğŸ”— Ressources

=== Documentation
* Next.js Security: https://nextjs.org/docs/app/building-your-application/configuring/content-security-policy
* OWASP Cheat Sheet: https://cheatsheetseries.owasp.org/cheatsheets/Nodejs_Security_Cheat_Sheet.html
* CSP Generator: https://report-uri.com/home/generate

=== Outils Test
* Security Headers Test: https://securityheaders.com/
* CSP Evaluator: https://csp-evaluator.withgoogle.com/

---

_Document crÃ©Ã©: {docdate}_
_Version: 1.0_
_Projet: BlaBlaBook V2_