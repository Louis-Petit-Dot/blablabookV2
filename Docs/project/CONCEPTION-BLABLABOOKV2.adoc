= BlaBlaBook V2 - Conception & Architecture / Design & Architecture
:toc: left
:toclevels: 3
:sectanchors:
:source-highlighter: highlight.js
:icons: font
:version: 2.0
:date: {docdate}

// Navigation inter-documents
link:../README.adoc[üìö Documentation Hub] |
link:../cdc/technical-architecture.adoc[üèóÔ∏è Architecture] |
link:../cdc/api-specifications.adoc[üõ£Ô∏è API] |
link:../diagrams/sequence/diag-sequence.adoc[üìä Sequence Diagrams]

// Navigation langues
<<section-fr,üá´üá∑ Version Fran√ßaise>> | <<section-en,üá¨üáßüá∫üá∏ English Version>>

---

[[section-fr]]
== üá´üá∑ Conception & Architecture

<<section-en,üá¨üáßüá∫üá∏ Switch to English>> | üá´üá∑ *Fran√ßais*

=== üìã Synth√®se du Projet

=== Objectifs de la V2

[cols="1,3"]
|===
|Objectif |Description

|*Migration Stack*
|Passage de Node.js/Express/Sequelize vers **Deno/Hono/Drizzle**

|*Architecture Moderne*
|API RESTful stateless avec **JWT** au lieu de sessions Redis

|*S√©curit√© Zero Trust*
|Impl√©mentation **"Never Trust, Always Verify"** + **OWASP Top 10** (sans device fingerprinting)

|*Performance*
|Stack ultra-rapide et images Docker optimis√©es

|*Maintenabilit√©*
|Code TypeScript natif et schema de donn√©es simplifi√©
|===

=== Choix Techniques Valid√©s

[cols="2,3,3"]
|===
|Composant |V1 (Actuel) |V2 (Nouveau)

|*Runtime*
|Node.js 18+
|**Deno 2.1+**

|*Framework Web*
|Express.js 5.1
|**Hono 3.12+**

|*ORM*
|Sequelize 6.35
|**Drizzle ORM 0.29+**

|*Authentification*
|Sessions Redis + CSRF
|**JWT + Zero Trust Security**

|*Base de Donn√©es*
|PostgreSQL 17
|**PostgreSQL 17** (inchang√©)

|*Validation*
|Zod 4.0
|**Drizzle-Zod** (int√©gr√©)

|*Logging*
|Winston/Morgan
|**Logger Deno natif** (stylis√©)
|===

== üèóÔ∏è Architecture Syst√®me

=== Stack Technique Compl√®te

[source,typescript]
----
// deno.json - Configuration projet
{
  "compilerOptions": {
    "allowJs": true,
    "lib": ["deno.window"],
    "strict": true
  },
  "tasks": {
    "dev": "deno run --allow-net --allow-env --allow-read --watch src/main.ts",
    "db:push": "drizzle-kit push:pg",
    "db:studio": "drizzle-kit studio"
  },
  "imports": {
    "hono": "https://deno.land/x/hono@v3.12.8/mod.ts",
    "drizzle-orm": "npm:drizzle-orm@^0.29.0",
    "drizzle-zod": "npm:drizzle-zod@^0.5.1",
    "postgres": "https://deno.land/x/postgres@v0.17.0/mod.ts"
  }
}
----

=== Structure Projet Propos√©e

----
blablabookV2/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ db/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ schema.ts          # Sch√©mas Drizzle
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ relations.ts       # Relations complexes
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ migrations/        # Migrations Drizzle
‚îÇ   ‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.ts           # Routes authentification JWT
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ books.ts          # API Livres
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ users.ts          # API Utilisateurs
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.service.ts   # Logique m√©tier auth
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ book.service.ts   # Logique m√©tier livres
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îú‚îÄ‚îÄ middleware/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.ts           # JWT + Permissions
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ security.ts       # Headers OWASP
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ validation.ts     # Schemas Drizzle-Zod
‚îÇ   ‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ api.ts            # Types API
‚îÇ   ‚îî‚îÄ‚îÄ main.ts               # Application Hono
‚îú‚îÄ‚îÄ drizzle.config.ts         # Configuration Drizzle
‚îú‚îÄ‚îÄ deno.json                 # Configuration Deno
‚îî‚îÄ‚îÄ README.md
----

== üîê S√©curit√© Zero Trust + OWASP Compliant

=== Architecture Zero Trust JWT

[source,typescript]
----
// JWT Simple Pattern (8h)
interface JWTToken {
  accessToken: string;   // 8h TTL - Single token, no refresh
}

interface ZeroTrustContext {
  sessionId: string;          // Session unique JWT
  permissions: string[];      // Permissions utilisateur (cache Deno KV)
  lastActivity: Date;         // Derni√®re activit√©
  rateLimit: number;          // Compteur requ√™tes (anti-spam)
  // Note: Pas de device fingerprinting pour √©viter friction mobile
  // Storage: Deno KV pour lockout + cache r√¥les/permissions
}

// Middleware Zero Trust (sans device fingerprinting)
export const zeroTrustAuthMiddleware = async (c: Context, next: Next) => {
  const token = c.req.header("Authorization")?.slice(7); // "Bearer "
  const payload = await verify(token, JWT_SECRET);

  if (payload.type !== "access") {
    throw new Error("Invalid token type");
  }

  // Zero Trust: Validation continue SANS device fingerprinting
  const userContext = await getZeroTrustContext(payload.sub);

  // V√©rification permissions √† chaque requ√™te
  if (!payload.permissions || payload.permissions.length === 0) {
    throw new Error("No permissions in token");
  }

  // Rate limiting per user (protection spam/bot)
  if (userContext.rateLimit > 1000) { // 1000 requ√™tes/15min
    await logSecurityEvent("RATE_LIMIT_EXCEEDED", {
      user: payload.sub,
      requests: userContext.rateLimit
    });
    return c.json({ error: "Too many requests" }, 429);
  }

  // Token expiration stricte (pas de grace period)
  if (payload.exp * 1000 < Date.now()) {
    throw new Error("Token expired - strict validation");
  }

  // Mise √† jour contexte Zero Trust
  await updateZeroTrustContext(payload.sub, {
    lastActivity: new Date(),
    rateLimit: userContext.rateLimit + 1
  });

  c.set("user", {
    id: payload.sub,
    permissions: payload.permissions,
    zeroTrustValidated: true
  });

  await next();
};
----

=== Headers S√©curis√©s OWASP

[source,typescript]
----
export const securityHeaders = async (c: Context, next: Next) => {
  await next();

  // OWASP A05: Security Misconfiguration
  c.header("X-Content-Type-Options", "nosniff");
  c.header("X-Frame-Options", "DENY");
  c.header("X-XSS-Protection", "1; mode=block");
  c.header("Referrer-Policy", "strict-origin-when-cross-origin");

  // OWASP A02: Cryptographic Failures
  if (c.req.url.includes("https://")) {
    c.header("Strict-Transport-Security", "max-age=31536000; includeSubDomains");
  }
};
----

=== Rate Limiting & Protection

[source,typescript]
----
// OWASP A10: Server-Side Request Forgery
export const rateLimiter = (maxRequests = 100, windowMs = 60000) => {
  const requests = new Map<string, number[]>();

  return async (c: Context, next: Next) => {
    const clientIp = c.req.header("x-forwarded-for") || "unknown";
    const now = Date.now();

    const clientRequests = requests.get(clientIp) || [];
    const validRequests = clientRequests.filter(time => now - time < windowMs);

    if (validRequests.length >= maxRequests) {
      return c.json({ error: "Too Many Requests" }, 429);
    }

    validRequests.push(now);
    requests.set(clientIp, validRequests);
    await next();
  };
};
----

== üóÑÔ∏è Mod√©lisation des Donn√©es

=== Entity Relationship Diagram (ERD)

[source,mermaid]
----
erDiagram
    USER ||--o{ LIBRARY : owns
    USER ||--o{ READING_LIST : owns
    USER ||--o{ NOTICE : owns
    USER ||--o{ RATE : owns

    %% Relations RBAC
    USER ||--o{ USER_ROLE : has
    ROLE ||--o{ USER_ROLE : assigned_to
    ROLE ||--o{ ROLE_PERMISSION : has
    PERMISSION ||--o{ ROLE_PERMISSION : granted_to

    LIBRARY ||--o{ READING_LIST : contains
    BOOK ||--o{ READING_LIST : appears_in
    BOOK ||--o{ NOTICE : has
    BOOK ||--o{ RATE : has
    BOOK ||--o{ BOOK_AUTHOR : written_by
    BOOK ||--o{ BOOK_GENRE : categorized_as
    AUTHOR ||--o{ BOOK_AUTHOR : writes
    GENRE ||--o{ BOOK_GENRE : categorizes

    USER {
        int id_user PK
        string firstname
        string lastname
        string username UK
        string email UK
        string password
        string avatar_url
        timestamp connected_at
        timestamp created_at
        timestamp deleted_at "soft delete"
    }

    LIBRARY {
        int id_library PK
        int id_user FK "propri√©taire"
        string name
        timestamp created_at
        timestamp deleted_at "soft delete"
    }

    READING_LIST {
        int id_reading_list PK
        int id_user FK "propri√©taire de l'entr√©e"
        int id_library FK "biblioth√®que contenante"
        int id_book FK
        string list_name "nom de la liste nomm√©e"
        string reading_status "to_read|reading|read|abandoned"
        timestamp added_at
        timestamp started_at
        timestamp finished_at
    }

    BOOK {
        int id_book PK
        string title
        string isbn UK
        text description
        int publication_year
        string cover_url
        string open_library_key UK
        bool is_temporary "syst√®me import simplifi√©"
        timestamp imported_at
        timestamp created_at
        timestamp updated_at
    }

    LIBRARY_PERMISSION {
        int id_library FK
        int id_user FK "utilisateur autoris√©"
        string permission_type "read|write|admin"
        timestamp granted_at
    }

    LIBRARY ||--o{ LIBRARY_PERMISSION : "can be shared via"
    USER ||--o{ LIBRARY_PERMISSION : "can access shared"
----

=== Mod√®le Conceptuel de Donn√©es (MCD) Merise

[source,mermaid]
----
graph TB
    %% ENTIT√âS PRINCIPALES
    USER["üë§ USER<br/>id_user<br/>firstname<br/>lastname<br/>username<br/>email<br/>password<br/>avatar_url"]

    LIBRARY["üìö LIBRARY<br/>id_library<br/>name"]

    BOOK["üìñ BOOK<br/>id_book<br/>title<br/>isbn<br/>description<br/>publication_year<br/>cover_url<br/>is_temporary<br/>imported_at"]

    AUTHOR["‚úçÔ∏è AUTHOR<br/>id_author<br/>name<br/>bio<br/>birth_date<br/>death_date<br/>avatar_url"]

    GENRE["üè∑Ô∏è GENRE<br/>id_genre<br/>name<br/>description"]

    ROLE["üé≠ ROLE<br/>id_role<br/>name<br/>description"]

    PERMISSION["üîë PERMISSION<br/>id_permission<br/>label<br/>action"]

    %% ENTIT√âS D'ASSOCIATION (avec PK propres)
    READING_LIST["üìã READING_LIST<br/>id_reading_list<br/>list_name<br/>reading_status<br/>added_at<br/>started_at<br/>finished_at"]

    LIBRARY_PERMISSION["üîê LIBRARY_PERMISSION<br/>permission_type<br/>granted_at"]

    NOTICE["üí¨ NOTICE<br/>id_notice<br/>title<br/>content<br/>is_spoiler<br/>is_public"]

    RATE["‚≠ê RATE<br/>id_rate<br/>rating"]

    USER_ROLE["üë• USER_ROLE<br/>id_user_role"]

    ROLE_PERMISSION["üé´ ROLE_PERMISSION<br/>id_role_permission"]

    BOOK_AUTHOR["üìù BOOK_AUTHOR<br/>id_book_author"]

    BOOK_GENRE["üè∑Ô∏è BOOK_GENRE<br/>id_book_genre"]

    %% RELATIONS SIMPLES (1:N)
    POSSEDER["POSS√âDER<br/>1,n ---- 1,1"]

    %% RELATIONS VERS ENTIT√âS D'ASSOCIATION
    DETENIR_USER_RL["DETENIR<br/>0,n ---- 1,1"]
    APPARTENIR_LIB_RL["CONTENIR<br/>1,1 ---- 0,n"]
    APPARTENIR_BOOK_RL["FIGURER<br/>1,1 ---- 0,n"]

    AUTORISER_USER["AUTORISER<br/>0,n ---- 1,1"]
    CONCERNER_LIB["CONCERNER<br/>0,n ---- 1,1"]

    %% LIAISONS PRINCIPALES
    USER --- POSSEDER
    POSSEDER --- LIBRARY

    %% LIAISONS READING_LIST (3 FK)
    USER --- DETENIR_USER_RL
    DETENIR_USER_RL --- READING_LIST

    LIBRARY --- APPARTENIR_LIB_RL
    APPARTENIR_LIB_RL --- READING_LIST

    BOOK --- APPARTENIR_BOOK_RL
    APPARTENIR_BOOK_RL --- READING_LIST

    %% LIAISONS LIBRARY_PERMISSION
    USER --- AUTORISER_USER
    AUTORISER_USER --- LIBRARY_PERMISSION

    LIBRARY --- CONCERNER_LIB
    CONCERNER_LIB --- LIBRARY_PERMISSION
----

=== R√®gles de Gestion Valid√©es

[cols="1,4"]
|===
|RG |Description

|*RG1*
|Un utilisateur poss√®de au minimum une biblioth√®que (1,n ---- 1,1)

|*RG2*
|Une READING_LIST lie obligatoirement 1 USER + 1 LIBRARY + 1 BOOK

|*RG3*
|Un livre ne peut figurer qu'une fois dans une m√™me biblioth√®que

|*RG4*
|Chaque ajout de livre est trac√© (propri√©taire de l'entr√©e)

|*RG5*
|Un utilisateur ne peut noter qu'une fois le m√™me livre

|*RG6*
|Permissions de partage : 'read', 'write', 'admin'

|*RG7*
|Syst√®me RBAC : USER ‚Üî ROLE ‚Üî PERMISSION pour permissions syst√®me

|*RG8*
|Import temporaire : livres supprim√©s apr√®s 3 jours si non confirm√©s
|===

== üîÑ Syst√®me d'Import Temporaire Simplifi√©

=== Logique de Fonctionnement

[source,typescript]
----
// Schema Drizzle (2 champs seulement)
export const books = pgTable('books', {
  // ... champs normaux
  isTemporary: boolean('is_temporary').default(true),
  importedAt: timestamp('imported_at').defaultNow(),
});

// Confirmation automatique lors de l'usage
const confirmBook = async (bookId: number) => {
  await db.update(books)
    .set({ isTemporary: false })
    .where(eq(books.id, bookId));
};

// Cleanup automatique (Cron Deno)
Deno.cron("cleanup temporary books", "0 2 * * *", async () => {
  const threeDaysAgo = new Date(Date.now() - 3 * 24 * 60 * 60 * 1000);

  const deleted = await db.delete(books)
    .where(
      and(
        eq(books.isTemporary, true),
        lt(books.importedAt, threeDaysAgo)
      )
    );

  console.log(`üßπ Cleaned up ${deleted.length} temporary books`);
});
----

=== Avantages vs V1

[cols="2,3,3"]
|===
|Aspect |V1 (Syst√®me complexe) |V2 (Syst√®me simplifi√©)

|*Nombre de champs*
|5 champs (import_status, imported_by, imported_at, imported_reason, needs_enrichment)
|**2 champs** (is_temporary, imported_at)

|*Cleanup*
|Manuel ou script externe
|**Automatique** (Deno cron int√©gr√©)

|*Performance*
|Index multiples, requ√™tes complexes
|**1 index composite optimis√©**

|*Maintenabilit√©*
|Logique r√©partie, FK multiples
|**Logique centralis√©e, simple**
|===

== üê≥ Infrastructure & D√©ploiement

=== Docker Simplifi√©

[source,dockerfile]
----
# Dockerfile.prod - Optimis√© Deno
FROM denoland/deno:2.1.0-alpine AS cacher

WORKDIR /app
COPY deno.json deno.lock* ./
RUN deno cache src/main.ts

FROM denoland/deno:2.1.0-alpine

WORKDIR /app
COPY --from=cacher /app .
COPY . .

EXPOSE 3000

# Permissions explicites
CMD ["deno", "run", "--allow-net", "--allow-env", "--allow-read", "src/main.ts"]
----

=== Docker Compose Simplifi√©

[source,yaml]
----
# Plus de service Redis !
services:
  api:
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
    ports:
      - '3000:3000'
    environment:
      - JWT_SECRET=${JWT_SECRET}
      - DB_HOST=${DB_HOST}
      # ‚ùå Plus de REDIS_URL
    depends_on:
      - postgres
      # ‚ùå Plus de redis

  postgres:
    image: postgres:17-alpine
    # Configuration identique
----

=== Gains Infrastructure

[cols="2,3,3"]
|===
|M√©trique |V1 |V2

|*Services Docker*
|4 services (API + Redis + DB + Adminer)
|**3 services** (API + DB + Adminer)

|*Taille image API*
|~200MB (Node Alpine + deps)
|**~50MB** (Deno Alpine)

|*Temps build CI*
|3-5 minutes (npm install)
|**1-2 minutes** (cache Deno)

|*M√©moire runtime*
|~150MB (Node + Redis client)
|**~80MB** (Deno pur)
|===

== üìÖ Timeline de Migration

=== Phase 1 : Fondations (1-2 semaines)
- [ ] Setup projet Deno + Hono + Drizzle
- [ ] Migration sch√©ma de base de donn√©es
- [ ] Authentification JWT basique
- [ ] Configuration CI/CD

=== Phase 2 : API Core (3-4 semaines)
- [ ] Users, Books, Authors, Genres (CRUD)
- [ ] Syst√®me RBAC complet
- [ ] Tests unitaires
- [ ] Validation Drizzle-Zod

=== Phase 3 : Fonctionnalit√©s Avanc√©es (2-3 semaines)
- [ ] Libraries + partage (LIBRARY_PERMISSION)
- [ ] Reading lists avec ownership
- [ ] Rates + Notices
- [ ] Import OpenLibrary + syst√®me temporaire

=== Phase 4 : Production (1-2 semaines)
- [ ] S√©curit√© OWASP compl√®te
- [ ] Performance optimization
- [ ] Tests d'int√©gration
- [ ] Documentation API

*TOTAL : 7-11 semaines* (vs 15+ avec migration classique)

== ‚úÖ Validation Conception

=== Points Cl√©s Valid√©s

[cols="1,4"]
|===
|‚úÖ |Description

|*Architecture*
|MCD Merise avec entit√©s d'association valid√©

|*D√©faut V1 corrig√©*
|Reading lists avec ownership direct (plus de d√©pendance library exclusive)

|*Stack moderne*
|Deno/Hono/Drizzle pour performance et maintenabilit√©

|*S√©curit√©*
|JWT stateless + OWASP Top 10 compliance

|*Simplification*
|Schema 40% plus simple, syst√®me import temporaire optimis√©

|*Infrastructure*
|Docker all√©g√©, 1 service en moins, CI/CD plus rapide
|===

=== Prochaines √âtapes

1. **Validation finale** de cette conception
2. **Cr√©ation sch√©mas Drizzle** TypeScript
3. **Setup projet** Deno avec structure valid√©e
4. **Impl√©mentation** par phases

[[section-en]]
== üá¨üáßüá∫üá∏ Design & Architecture

<<section-fr,üá´üá∑ Passer en Fran√ßais>> | üá¨üáßüá∫üá∏ *English*

=== üìã Project Overview

==== V2 Objectives

[cols="1,3"]
|===
|Objective |Description

|*Stack Migration*
|Migration from Node.js/Express/Sequelize to **Deno/Hono/Drizzle**

|*Modern Architecture*
|Stateless RESTful API with **JWT** instead of Redis sessions

|*OWASP Security*
|Secure "in-house" implementation compliant with **OWASP Top 10**

|*Performance*
|Ultra-fast stack and optimized Docker images

|*Maintainability*
|Native TypeScript code and simplified data schema
|===

==== Validated Technical Choices

[cols="2,3,3"]
|===
|Component |V1 (Current) |V2 (New)

|*Runtime*
|Node.js 18+
|**Deno 2.1+**

|*Web Framework*
|Express.js 5.1
|**Hono 3.12+**

|*ORM*
|Sequelize 6.35
|**Drizzle ORM 0.29+**

|*Authentication*
|Redis Sessions + CSRF
|**JWT + Stateless Security**

|*Database*
|PostgreSQL 17
|**PostgreSQL 17** (unchanged)

|*Validation*
|Zod 4.0
|**Drizzle-Zod** (integrated)

|*Logging*
|Winston/Morgan
|**Deno Native Logger** (styled)
|===

=== üèóÔ∏è System Architecture

==== Complete Technical Stack

[source,typescript]
----
// deno.json - Project configuration
{
  "compilerOptions": {
    "allowJs": true,
    "lib": ["deno.window"],
    "strict": true
  },
  "tasks": {
    "dev": "deno run --allow-net --allow-env --allow-read --watch src/main.ts",
    "db:push": "drizzle-kit push:pg",
    "db:studio": "drizzle-kit studio"
  },
  "imports": {
    "hono": "https://deno.land/x/hono@v3.12.8/mod.ts",
    "drizzle-orm": "npm:drizzle-orm@^0.29.0",
    "drizzle-zod": "npm:drizzle-zod@^0.5.1",
    "postgres": "https://deno.land/x/postgres@v0.17.0/mod.ts"
  }
}
----

=== üóÑÔ∏è Data Modeling

==== Entity Relationship Diagram (ERD)

[source,mermaid]
----
erDiagram
    USER ||--o{ LIBRARY : owns
    USER ||--o{ READING_LIST : owns
    USER ||--o{ NOTICE : owns
    USER ||--o{ RATE : owns

    %% RBAC Relations
    USER ||--o{ USER_ROLE : has
    ROLE ||--o{ USER_ROLE : assigned_to
    ROLE ||--o{ ROLE_PERMISSION : has
    PERMISSION ||--o{ ROLE_PERMISSION : granted_to

    LIBRARY ||--o{ READING_LIST : contains
    BOOK ||--o{ READING_LIST : appears_in
    BOOK ||--o{ NOTICE : has
    BOOK ||--o{ RATE : has
    BOOK ||--o{ BOOK_AUTHOR : written_by
    BOOK ||--o{ BOOK_GENRE : categorized_as
    AUTHOR ||--o{ BOOK_AUTHOR : writes
    GENRE ||--o{ BOOK_GENRE : categorizes

    USER {
        int id_user PK
        string firstname
        string lastname
        string username UK
        string email UK
        string password
        string avatar_url
        timestamp connected_at
        timestamp created_at
        timestamp deleted_at "soft delete"
    }

    LIBRARY {
        int id_library PK
        int id_user FK "owner"
        string name
        timestamp created_at
        timestamp deleted_at "soft delete"
    }

    READING_LIST {
        int id_reading_list PK
        int id_user FK "entry owner"
        int id_library FK "containing library"
        int id_book FK
        string list_name "named list name"
        string reading_status "to_read|reading|read|abandoned"
        timestamp added_at
        timestamp started_at
        timestamp finished_at
    }

    BOOK {
        int id_book PK
        string title
        string isbn UK
        text description
        int publication_year
        string cover_url
        string open_library_key UK
        bool is_temporary "simplified import system"
        timestamp imported_at
        timestamp created_at
        timestamp updated_at
    }

    LIBRARY_PERMISSION {
        int id_library FK
        int id_user FK "authorized user"
        string permission_type "read|write|admin"
        timestamp granted_at
    }

    LIBRARY ||--o{ LIBRARY_PERMISSION : "can be shared via"
    USER ||--o{ LIBRARY_PERMISSION : "can access shared"
----

==== Validated Business Rules

[cols="1,4"]
|===
|BR |Description

|*BR1*
|A user owns at least one library (1,n ---- 1,1)

|*BR2*
|A READING_LIST mandatorily links 1 USER + 1 LIBRARY + 1 BOOK

|*BR3*
|A book can only appear once in the same library

|*BR4*
|Each book addition is tracked (entry owner)

|*BR5*
|A user can only rate the same book once

|*BR6*
|Sharing permissions: 'read', 'write', 'admin'

|*BR7*
|RBAC system: USER ‚Üî ROLE ‚Üî PERMISSION for system permissions

|*BR8*
|Temporary import: books deleted after 3 days if not confirmed
|===

=== üîÑ Simplified Temporary Import System

==== Operating Logic

[source,typescript]
----
// Drizzle Schema (only 2 fields)
export const books = pgTable('books', {
  // ... normal fields
  isTemporary: boolean('is_temporary').default(true),
  importedAt: timestamp('imported_at').defaultNow(),
});

// Automatic confirmation when used
const confirmBook = async (bookId: number) => {
  await db.update(books)
    .set({ isTemporary: false })
    .where(eq(books.id, bookId));
};

// Automatic cleanup (Deno Cron)
Deno.cron("cleanup temporary books", "0 2 * * *", async () => {
  const threeDaysAgo = new Date(Date.now() - 3 * 24 * 60 * 60 * 1000);

  const deleted = await db.delete(books)
    .where(
      and(
        eq(books.isTemporary, true),
        lt(books.importedAt, threeDaysAgo)
      )
    );

  console.log(`üßπ Cleaned up ${deleted.length} temporary books`);
});
----

==== Advantages vs V1

[cols="2,3,3"]
|===
|Aspect |V1 (Complex system) |V2 (Simplified system)

|*Number of fields*
|5 fields (import_status, imported_by, imported_at, imported_reason, needs_enrichment)
|**2 fields** (is_temporary, imported_at)

|*Cleanup*
|Manual or external script
|**Automatic** (integrated Deno cron)

|*Performance*
|Multiple indexes, complex queries
|**1 optimized composite index**

|*Maintainability*
|Distributed logic, multiple FKs
|**Centralized, simple logic**
|===

=== üê≥ Infrastructure & Deployment

==== Simplified Docker

[source,dockerfile]
----
# Dockerfile.prod - Deno Optimized
FROM denoland/deno:2.1.0-alpine AS cacher

WORKDIR /app
COPY deno.json deno.lock* ./
RUN deno cache src/main.ts

FROM denoland/deno:2.1.0-alpine

WORKDIR /app
COPY --from=cacher /app .
COPY . .

EXPOSE 3000

# Explicit permissions
CMD ["deno", "run", "--allow-net", "--allow-env", "--allow-read", "src/main.ts"]
----

==== Infrastructure Gains

[cols="2,3,3"]
|===
|Metric |V1 |V2

|*Docker Services*
|4 services (API + Redis + DB + Adminer)
|**3 services** (API + DB + Adminer)

|*API image size*
|~200MB (Node Alpine + deps)
|**~50MB** (Deno Alpine)

|*CI build time*
|3-5 minutes (npm install)
|**1-2 minutes** (Deno cache)

|*Runtime memory*
|~150MB (Node + Redis client)
|**~80MB** (Pure Deno)
|===

=== üìÖ Migration Timeline

==== Phase 1: Foundations (1-2 weeks)
- [ ] Setup Deno + Hono + Drizzle project
- [ ] Database schema migration
- [ ] Basic JWT authentication
- [ ] CI/CD configuration

==== Phase 2: Core API (3-4 weeks)
- [ ] Users, Books, Authors, Genres (CRUD)
- [ ] Complete RBAC system
- [ ] Unit tests
- [ ] Drizzle-Zod validation

==== Phase 3: Advanced Features (2-3 weeks)
- [ ] Libraries + sharing (LIBRARY_PERMISSION)
- [ ] Reading lists with ownership
- [ ] Rates + Notices
- [ ] OpenLibrary import + temporary system

==== Phase 4: Production (1-2 weeks)
- [ ] Complete OWASP security
- [ ] Performance optimization
- [ ] Integration tests
- [ ] API documentation

*TOTAL: 7-11 weeks* (vs 15+ with classic migration)

=== ‚úÖ Design Validation

==== Key Validated Points

[cols="1,4"]
|===
|‚úÖ |Description

|*Architecture*
|Validated Merise MCD with association entities

|*V1 Issue Fixed*
|Reading lists with direct ownership (no exclusive library dependency)

|*Modern Stack*
|Deno/Hono/Drizzle for performance and maintainability

|*Security*
|Stateless JWT + OWASP Top 10 compliance

|*Simplification*
|40% simpler schema, optimized temporary import system

|*Infrastructure*
|Lighter Docker, 1 less service, faster CI/CD
|===

==== Next Steps

1. **Final validation** of this design
2. **Create TypeScript Drizzle schemas**
3. **Setup Deno project** with validated structure
4. **Implementation** by phases

---

*BlaBlaBook V2 Design Document - {date}*
*Stack: Deno 2.1 + Hono 3.12 + Drizzle 0.29 + PostgreSQL 17*