###############################################################################
# CI - Continuous Integration
#
# DÃ©clenchÃ© sur :
# - Chaque push sur n'importe quelle branche
# - Chaque Pull Request vers main ou develop
#
# Ce workflow :
# âœ… Teste le backend (Deno)
# âœ… VÃ©rifie le lint
# âœ… VÃ©rifie le formatage
# âœ… Type checking TypeScript
###############################################################################

name: CI - Tests & Quality

on:
  push:
    branches: ['**']  # Toutes les branches
  pull_request:
    branches: [main, develop]

env:
  DENO_VERSION: '2.5.2'

jobs:
  # =========================================================================
  # BACKEND - Tests Deno
  # =========================================================================
  backend-tests:
    name: Backend Tests (Deno)
    runs-on: ubuntu-latest

    # Service PostgreSQL pour les tests
    services:
      postgres:
        image: postgres:17-alpine
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: blablabook_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    defaults:
      run:
        working-directory: ./backend

    steps:
      # 1. Checkout du code
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      # 2. Installation Deno
      - name: ğŸ¦• Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: ${{ env.DENO_VERSION }}

      # 3. Cache des dÃ©pendances Deno
      - name: ğŸ’¾ Cache Deno dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/deno
            ~/.deno
          key: ${{ runner.os }}-deno-${{ hashFiles('backend/deno.lock') }}
          restore-keys: |
            ${{ runner.os }}-deno-

      # 4. VÃ©rification du type checking
      - name: ğŸ” Type checking
        run: deno check src/**/*.ts

      # 5. Lint du code
      - name: ğŸ§¹ Lint code
        run: deno lint

      # 6. VÃ©rification du formatage
      - name: âœ¨ Format check
        run: deno fmt --check

      # 7. ExÃ©cution des tests
      - name: ğŸ§ª Run tests
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/blablabook_test
          JWT_SECRET: test-jwt-secret-for-ci-only
          NODE_ENV: test
          ALLOWED_ORIGINS: http://localhost:5173
        run: deno test --allow-all

      # 8. RÃ©sumÃ©
      - name: âœ… Tests summary
        if: success()
        run: |
          echo "âœ… All backend tests passed!"
          echo "âœ… Type checking OK"
          echo "âœ… Linting OK"
          echo "âœ… Formatting OK"

  # =========================================================================
  # RÃ‰SUMÃ‰ DU CI
  # =========================================================================
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [backend-tests]
    if: always()

    steps:
      - name: ğŸ“Š Check CI status
        run: |
          if [ "${{ needs.backend-tests.result }}" != "success" ]; then
            echo "âŒ CI failed - Backend tests failed"
            exit 1
          fi
          echo "âœ… All CI checks passed successfully!"
          echo ""
          echo "ğŸ‰ Ready to merge or deploy!"
