###############################################################################
# Configuration Nginx pour BlaBlaBook V2 - Production
#
# Installation :
#   sudo cp nginx-blablabook.conf /etc/nginx/sites-available/blablabook
#   sudo ln -s /etc/nginx/sites-available/blablabook /etc/nginx/sites-enabled/
#   sudo nginx -t
#   sudo systemctl reload nginx
#
# Puis obtenir le certificat SSL :
#   sudo certbot --nginx -d blablabook.online -d www.blablabook.online
###############################################################################

# Redirection www vers non-www
server {
    listen 80;
    listen [::]:80;
    server_name www.blablabook.online;

    # Redirect to non-www
    return 301 https://blablabook.online$request_uri;
}

# Serveur principal HTTP (sera mis à jour par Certbot pour HTTPS)
server {
    listen 80;
    listen [::]:80;
    server_name blablabook.online;

    # Logs
    access_log /var/log/nginx/blablabook-access.log;
    error_log /var/log/nginx/blablabook-error.log;

    # Let's Encrypt challenge (pour renouvellement SSL)
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # Sécurité : cache les versions serveurs
    server_tokens off;

    # Taille max upload (pour avatars/images)
    client_max_body_size 10M;

    # Timeout
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;

    # =========================================================================
    # FRONTEND - Single Page Application (React)
    # =========================================================================
    location / {
        # Proxy vers container frontend (port 5173 en dev, 4173 en prod)
        proxy_pass http://localhost:5173;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;

        # Headers de sécurité
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Support Hot Module Replacement (HMR) pour dev
        proxy_set_header Connection "upgrade";
    }

    # =========================================================================
    # BACKEND API - Deno + Hono
    # =========================================================================
    location /api/ {
        # Proxy vers container backend (port 3000)
        proxy_pass http://localhost:3000;

        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # IMPORTANT : Headers pour CORS et cookies
        proxy_set_header Origin $http_origin;
        proxy_set_header Cookie $http_cookie;

        # Preserve les cookies
        proxy_pass_header Set-Cookie;
        proxy_cookie_path / /;

        # Timeout pour requêtes API
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }

    # Health check endpoint (sans /api/)
    location /health {
        proxy_pass http://localhost:3000/health;
        access_log off;  # Ne pas logger les health checks
    }

    # =========================================================================
    # CACHE STATIQUE (images, fonts, etc.)
    # =========================================================================
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|woff|woff2|ttf|svg)$ {
        proxy_pass http://localhost:5173;
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # =========================================================================
    # SÉCURITÉ
    # =========================================================================

    # Désactive l'affichage de la version Nginx
    server_tokens off;

    # Headers de sécurité (seront renforcés par Certbot après HTTPS)
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # Bloque l'accès aux fichiers cachés
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
}

###############################################################################
# Configuration HTTPS (sera ajoutée automatiquement par Certbot)
#
# Après avoir exécuté :
#   sudo certbot --nginx -d blablabook.online -d www.blablabook.online
#
# Certbot ajoutera automatiquement :
# - Un nouveau bloc server pour HTTPS (port 443)
# - Les certificats SSL
# - La redirection HTTP → HTTPS
# - Les headers de sécurité renforcés (HSTS, etc.)
###############################################################################
